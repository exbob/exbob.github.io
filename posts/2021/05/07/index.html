<!doctype html><html lang=zh-cn dir=Chinese-Simplified class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><title>如何修改 ARM Linux 系统的启动画面 &#183; Shaocheng.Li</title>
<meta name=title content="如何修改 ARM Linux 系统的启动画面 &#183; Shaocheng.Li"><script type=text/javascript src=/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.569cc57d5993584135ff38133d1f599f8f8db0303a9e886172e4b5aabb177ac6.css integrity="sha256-VpzFfVmTWEE1/zgTPR9Zn4+NsDA6nohhcuS1qrsXesY="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.f29ffdffd9ab4cc95250c3c7196b2d5dae8ee6ef0a4139451073f90183ae7e31.js integrity="sha256-8p/9/9mrTMlSUMPHGWstXa6O5u8KQTlFEHP5AYOufjE=" data-copy=复制 data-copied=已复制></script><meta name=description content="
      
        以 NXP 的 iMX Yocto 4.
      
    "><link rel=canonical href=https://shaocheng.li/posts/2021/05/07/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="如何修改 ARM Linux 系统的启动画面"><meta property="og:description" content="以 NXP 的 iMX Yocto 4."><meta property="og:type" content="article"><meta property="og:url" content="https://shaocheng.li/posts/2021/05/07/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-07T20:49:11+08:00"><meta property="article:modified_time" content="2021-05-07T20:49:11+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="如何修改 ARM Linux 系统的启动画面"><meta name=twitter:description content="以 NXP 的 iMX Yocto 4."><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"如何修改 ARM Linux 系统的启动画面","headline":"如何修改 ARM Linux 系统的启动画面","abstract":"以 NXP 的 iMX Yocto 4.","inLanguage":"zh-cn","url":"https:\/\/shaocheng.li\/posts\/2021\/05\/07\/","author":{"@type":"Person","name":"Shaocheng.Li"},"copyrightYear":"2021","dateCreated":"2021-05-07T20:49:11\u002b08:00","datePublished":"2021-05-07T20:49:11\u002b08:00","dateModified":"2021-05-07T20:49:11\u002b08:00","keywords":["untagged"],"mainEntityOfPage":"true","wordCount":"2799"}</script><meta name=author content="Shaocheng.Li"><link href=https://github.com/exbob rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold pe-2 text-primary-600 dark:text-primary-400">&darr;</span>跳到主要内容</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Shaocheng.Li</a></div><ul class="flex flex-col list-none text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/posts/ title=Posts><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">文章列表</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=search-button-1 title="搜索 (/)">
<span class="transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=appearance-switcher-1 type=button aria-label="appearance switcher">
<span class="inline transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600 dark:hidden" title=切换为深色模式><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span>
</span><span class="hidden transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600 dark:inline" title=切换为浅色模式><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">如何修改 ARM Linux 系统的启动画面</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-05-07 20:49:11 +0800 +0800">2021 May 7</time><span class="px-2 text-primary-500">&#183;</span><span>2799 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>14 分钟</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 print:hidden lg:sticky lg:top-10"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="-ms-5 block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="-ms-5 border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#u-boot-的启动画面>U-Boot 的启动画面</a></li><li><a href=#内核的启动画面>内核的启动画面</a><ul><li><a href=#ppm-图片格式>PPM 图片格式</a></li><li><a href=#显示启动画面的过程>显示启动画面的过程</a></li><li><a href=#更换启动画面>更换启动画面</a></li><li><a href=#动态修改启动画面>动态修改启动画面</a></li><li><a href=#一些问题>一些问题</a></li><li><a href=#关于保留内存>关于保留内存</a></li></ul></li><li><a href=#用户空间的启动画面>用户空间的启动画面</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose grow"><p>以 NXP 的 iMX Yocto 4.9.88 系统版本为例，启动分为三个阶段：U-Boot ，内核，根文件系统，每个阶段都可以设置自己的显示画面。</p><h2 id=u-boot-的启动画面 class="relative group">U-Boot 的启动画面 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#u-boot-%e7%9a%84%e5%90%af%e5%8a%a8%e7%94%bb%e9%9d%a2 aria-label=锚点>#</a></span></h2><p>u-boot 阶段的运行时很短，一般不用修改。待补充。</p><h2 id=内核的启动画面 class="relative group">内核的启动画面 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%86%85%e6%a0%b8%e7%9a%84%e5%90%af%e5%8a%a8%e7%94%bb%e9%9d%a2 aria-label=锚点>#</a></span></h2><h3 id=ppm-图片格式 class="relative group">PPM 图片格式 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#ppm-%e5%9b%be%e7%89%87%e6%a0%bc%e5%bc%8f aria-label=锚点>#</a></span></h3><p>如果开启了 FrameBuffer ，Linux 内核启动时会在屏幕左上角显示企鹅图标，图标的数量等于 CPU 的核心数量。这个图标来自于内核源码的 <code>driver/video/logo/</code> 目录下的 ppm 格式图片：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ls drivers/video/logo/
</span></span><span class=line><span class=cl>clut_vga16.ppm             logo_linux_mono.pbm      logo_sun_clut224.ppm
</span></span><span class=line><span class=cl>Kconfig                    logo_linux_vga16.ppm     logo_superh_clut224.ppm
</span></span><span class=line><span class=cl>logo_blackfin_clut224.ppm  logo_m32r_clut224.ppm    logo_superh_mono.pbm
</span></span><span class=line><span class=cl>logo_blackfin_vga16.ppm    logo_mac_clut224.ppm     logo_superh_vga16.ppm
</span></span><span class=line><span class=cl>logo.c                     logo_parisc_clut224.ppm  Makefile
</span></span><span class=line><span class=cl>logo_dec_clut224.ppm       logo_sgi_clut224.ppm
</span></span><span class=line><span class=cl>logo_linux_clut224.ppm     logo_spe_clut224.ppm
</span></span></code></pre></div><p>这里的 ppm 格式是一种 ASCII 编码的图片文件格式，可以用文本编辑器打开，以 logo_linux_clut224.ppm 为例 ：</p><pre tabindex=0><code>P3
# Standard 224-color Linux logo
80 80
255
  0   0   0   0   0   0   0   0   0   0   0   0
</code></pre><p>井号 <code>#</code> 开头的是注释，忽略注释后，前三行文本是文件头：</p><ol><li>第一行表示文件类型，P3 表示 ASCII 编码的 RGB 三色色显现图像</li><li>第二行表示图像的宽度和高度，单位是像素</li><li>第三行表示最大的像素值</li></ol><p>文件头后面所有像素点的数据，每个像素点是由 RGB三个数据组成，RGB 中间用一个空格隔开，像素点之间由两个空格隔开，每一行用回车隔开。</p><p>这样的文件不能供内核直接使用，需要转换成 C 语音的格式。编译内核时，执行的 <code>drivers/video/logo/Makefile</code> 文件会调用 <code>scripts/pnmtologo</code> 工具：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnmtologo :<span class=o>=</span> scripts/pnmtologo
</span></span><span class=line><span class=cl><span class=c1># Create commands like &#34;pnmtologo -t mono -n logo_mac_mono -o ...&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>quiet_cmd_logo</span> <span class=o>=</span> LOGO    <span class=nv>$@</span>
</span></span><span class=line><span class=cl>    <span class=nv>cmd_logo</span> <span class=o>=</span> <span class=k>$(</span>pnmtologo<span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>         -t <span class=k>$(</span>patsubst <span class=nv>$*</span>_%,%,<span class=k>$(</span>notdir <span class=k>$(</span>basename $&lt;<span class=k>)))</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>         -n <span class=k>$(</span>notdir <span class=k>$(</span>basename $&lt;<span class=k>))</span> -o <span class=nv>$@</span> $&lt;
</span></span></code></pre></div><p><code>scripts/pnmtologo</code> 是用 <code>scripts/pnmtologo.c</code> 编译生成的二进制工具，执行的语法是：</p><pre tabindex=0><code>./pnmtologo [options] &lt;filename&gt;
可选项:
    -h          : 显示帮助信息
    -n &lt;name&gt;   : 生成的 struct linux_logo 类型变量的名字 (default: linux_logo)
    -o &lt;output&gt; : 生成的 C 语音源文件的名字
    -t &lt;type&gt;   : 启动画面的类型
                      mono    : monochrome black/white
                      vga16   : 16 colors VGA text palette
                      clut224 : 224 colors (default)
                      gray256 : 256 levels grayscale
&lt;filename&gt; 是要解析的 ppm 图片的文件名
</code></pre><p>它会把 <code>driver/video/logo/</code> 目录下 <code>.ppm</code> 文件转换为同名的 <code>.c</code> 文件，例如，logo_linux_clut224.ppm 会转换为 logo_linux_clut224.c ，通过一个 <code>struct linux_logo</code> 变量保存图片的数据。</p><h3 id=显示启动画面的过程 class="relative group">显示启动画面的过程 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%98%be%e7%a4%ba%e5%90%af%e5%8a%a8%e7%94%bb%e9%9d%a2%e7%9a%84%e8%bf%87%e7%a8%8b aria-label=锚点>#</a></span></h3><p>内核绘制 logo 是由 <code>drivers/video/fbdev/core/fbmem.c</code> 文件中的 <code>fb_show_logo()</code> 完成的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fb_show_logo</span><span class=p>(</span><span class=k>struct</span> <span class=n>fb_info</span> <span class=o>*</span><span class=n>info</span><span class=p>,</span> <span class=kt>int</span> <span class=n>rotate</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>y</span> <span class=o>=</span> <span class=nf>fb_show_logo_line</span><span class=p>(</span><span class=n>info</span><span class=p>,</span> <span class=n>rotate</span><span class=p>,</span> <span class=n>fb_logo</span><span class=p>.</span><span class=n>logo</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			      <span class=nf>num_online_cpus</span><span class=p>());</span>
</span></span><span class=line><span class=cl>	<span class=n>y</span> <span class=o>=</span> <span class=nf>fb_show_extra_logos</span><span class=p>(</span><span class=n>info</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>rotate</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>参数 <code>info</code> 传递的 FrameBuffer 的属性，<code>rotate</code> 则表示屏幕的旋转方向。这个函数又调用了 <code>fb_show_logo_line()</code> 函数，参数 <code>num_online_cpus()</code> 是一个宏，它返回了 CPU 的核心数量，参数 <code>fb_logo.logo</code> 是一个 <code>struct linux_logo</code> 指针，这个结构记录了 logo 图片的分辨率和像素数据，它是在 <code>fb_prepare_logo()</code> 函数中由 <code>fb_find_logo()</code> 赋值：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>fb_prepare_logo</span><span class=p>(</span><span class=k>struct</span> <span class=n>fb_info</span> <span class=o>*</span><span class=n>info</span><span class=p>,</span> <span class=kt>int</span> <span class=n>rotate</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Return if no suitable logo was found */</span>
</span></span><span class=line><span class=cl>	<span class=n>fb_logo</span><span class=p>.</span><span class=n>logo</span> <span class=o>=</span> <span class=nf>fb_find_logo</span><span class=p>(</span><span class=n>depth</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>参数 <code>depth</code> 表示 FrameBuffer 的颜色深度，基本是由屏幕的素质决定，<code>fb_find_logo()</code> 函数定义在 <code>drivers/video/logo/logo.c</code> 中，它的作用是根据 <code>depth</code> 的值和内核配置决定用那个图片作为 logo ，如果颜色深度是 16 ，且内核配置了 <code>CONFIG_LOGO_LINUX_CLUT224</code> 选项，就用 <code>logo_linux_clut224</code> 作为 logo ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>const</span> <span class=k>struct</span> <span class=n>linux_logo</span> <span class=o>*</span> <span class=n>__ref</span> <span class=nf>fb_find_logo</span><span class=p>(</span><span class=kt>int</span> <span class=n>depth</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>linux_logo</span> <span class=o>*</span><span class=n>logo</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>...</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>depth</span> <span class=o>&gt;=</span> <span class=mi>8</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef CONFIG_LOGO_LINUX_CLUT224
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=cm>/* Generic Linux logo */</span>
</span></span><span class=line><span class=cl>		<span class=n>logo</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>logo_linux_clut224</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=p>...</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>logo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>配置选项是在 menuconfig 中的 <code>Device Drivers > Graphics support > Bootup logo</code> 中设置的：</p><p><figure><img class="mx-auto my-0 rounded-md" src=./pics/image-20210509122339357.png alt=image-20210509122339357.png loading=lazy></figure></p><p><code>logo_linux_clut224</code> 是一个 <code>struct linux_logo</code> 类型的变量，定义在 <code>logo_linux_clut224.c</code> 文件中，它是在编译时，由 <code>drivers/video/logo/Makefile</code> 文件调用 <code>scripts/pnmtologo</code> 工具，读取 <code>drivers/video/logo/</code> 目录下的同名图片 <code>logo_linux_clut224.ppm</code> 解析后生成的。内容类似如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>logo_linux_clut224_data</span><span class=p>[]</span> <span class=n>__initdata</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span> <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>logo_linux_clut224_clut</span><span class=p>[]</span> <span class=n>__initdata</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xff</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span> <span class=mh>0xfd</span><span class=p>,</span> <span class=mh>0xfe</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span> <span class=mh>0xfe</span><span class=p>,</span> <span class=mh>0xff</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span> <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=k>struct</span> <span class=n>linux_logo</span> <span class=n>logo_linux_clut224</span> <span class=n>__initconst</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=p>.</span><span class=n>type</span>       <span class=o>=</span> <span class=n>LINUX_LOGO_CLUT224</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=p>.</span><span class=n>width</span>      <span class=o>=</span> <span class=mi>800</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=p>.</span><span class=n>height</span>     <span class=o>=</span> <span class=mi>590</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=p>.</span><span class=n>clutsize</span>   <span class=o>=</span> <span class=mi>223</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=p>.</span><span class=n>clut</span>       <span class=o>=</span> <span class=n>logo_linux_clut224_clut</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=p>.</span><span class=n>data</span>       <span class=o>=</span> <span class=n>logo_linux_clut224_data</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>确定了 logo 用的图片后， <code>fb_show_logo_line()</code> 函数会改用 <code>struct fb_image</code> 结构保存要显示的图片：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>fb_show_logo_line</span><span class=p>(</span><span class=k>struct</span> <span class=n>fb_info</span> <span class=o>*</span><span class=n>info</span><span class=p>,</span> <span class=kt>int</span> <span class=n>rotate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			     <span class=k>const</span> <span class=k>struct</span> <span class=n>linux_logo</span> <span class=o>*</span><span class=n>logo</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			     <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>fb_image</span> <span class=n>image</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span><span class=p>.</span><span class=n>depth</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span>    <span class=c1>//图片的颜色深度固定为 8
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>image</span><span class=p>.</span><span class=n>data</span> <span class=o>=</span> <span class=n>logo</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>    <span class=c1>//图片的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>image</span><span class=p>.</span><span class=n>dx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>        <span class=c1>//绘制图片的起始横坐标，屏幕的左上角为 0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>image</span><span class=p>.</span><span class=n>dy</span> <span class=o>=</span> <span class=n>y</span><span class=p>;</span>        <span class=c1>//绘制图片的起始纵坐标，也是 0 ，表示从左上角开始显示
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>image</span><span class=p>.</span><span class=n>width</span> <span class=o>=</span> <span class=n>logo</span><span class=o>-&gt;</span><span class=n>width</span><span class=p>;</span>    <span class=c1>//图片的横向分辨率
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>image</span><span class=p>.</span><span class=n>height</span> <span class=o>=</span> <span class=n>logo</span><span class=o>-&gt;</span><span class=n>height</span><span class=p>;</span>    <span class=c1>//图片的纵向分辨率
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nf>fb_do_show_logo</span><span class=p>(</span><span class=n>info</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>image</span><span class=p>,</span> <span class=n>rotate</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>最后调用 <code>fb_do_show_logo()</code> 函数横向的绘制 n 个 image 。如果屏幕是正向的，图片会按如下方式绘制：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>fb_do_show_logo</span><span class=p>(</span><span class=k>struct</span> <span class=n>fb_info</span> <span class=o>*</span><span class=n>info</span><span class=p>,</span> <span class=k>struct</span> <span class=n>fb_image</span> <span class=o>*</span><span class=n>image</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			    <span class=kt>int</span> <span class=n>rotate</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>rotate</span> <span class=o>==</span> <span class=n>FB_ROTATE_UR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		     <span class=n>x</span> <span class=o>&lt;</span> <span class=n>num</span> <span class=o>&amp;&amp;</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>dx</span> <span class=o>+</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>width</span> <span class=o>&lt;=</span> <span class=n>info</span><span class=o>-&gt;</span><span class=n>var</span><span class=p>.</span><span class=n>xres</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		     <span class=n>x</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>info</span><span class=o>-&gt;</span><span class=n>fbops</span><span class=o>-&gt;</span><span class=nf>fb_imageblit</span><span class=p>(</span><span class=n>info</span><span class=p>,</span> <span class=n>image</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>image</span><span class=o>-&gt;</span><span class=n>dx</span> <span class=o>+=</span> <span class=n>image</span><span class=o>-&gt;</span><span class=n>width</span> <span class=o>+</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> 
</span></span><span class=line><span class=cl>	<span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=更换启动画面 class="relative group">更换启动画面 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%9b%b4%e6%8d%a2%e5%90%af%e5%8a%a8%e7%94%bb%e9%9d%a2 aria-label=锚点>#</a></span></h3><p>根据 logo 的显示原理，我们可以按如下步骤更换内核的启动画面。</p><p>首先准备一张小于等于屏幕分辨率的 png 格式图片，命名为 logo.png ，执行如下命令将其转换为 ppm 格式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>~$ pngtopnm logo.png &gt; logo_linux_clut.pnm
</span></span><span class=line><span class=cl>~$ pnmquant <span class=m>224</span> logo_linux_clut.pnm &gt; logo_linux_clut224.pnm
</span></span><span class=line><span class=cl>~$ pnmtoplainpnm logo_linux_clut224.pnm &gt; logo_linux_clut224.ppm
</span></span></code></pre></div><p>将生成的 logo_linux_clut224.ppm 覆盖到内核源码的 <code>drivers/video/logo/</code> 目录下。</p><p>如果 CPU 是多核，且 logo 图片跟屏幕分辨率相同，想要全屏显示，就修改 <code>drivers/video/fbdev/core/fbmem.c</code> 文件中的 <code>fb_show_logo()</code> 函数，将绘制 logo 的数量设为 1 ：</p><pre tabindex=0><code>@@ -665,7 +665,7 @@ int fb_show_logo(struct fb_info *info, int rotate)
        int y;

        y = fb_show_logo_line(info, rotate, fb_logo.logo, 0,
-                             num_online_cpus());
+                             1);
        y = fb_show_extra_logos(info, y, rotate);

        return y;
</code></pre><p>默认情况下，图片会贴着屏幕的左上角 <code>&lt;0,0></code> 显示。如果需要居中显示，可以在 <code>drivers/video/fbdev/core/fbmem.c</code> 文件的 <code>fb_show_logo_line()</code> 函数中修改图片显示的起始坐标：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gd>-image.dx=0;
</span></span></span><span class=line><span class=cl><span class=gd>-image.dy=y;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+image.dx = (info-&gt;var.xres / 2) - (image.width / 2);
</span></span></span><span class=line><span class=cl><span class=gi>+image.dy = (info-&gt;var.yres / 2) - (image.height / 2);
</span></span></span></code></pre></div><p>查看内核的 git log 发现，在 5.0 之后的版本，通过 <a href=https://github.com/torvalds/linux/commit/3d8b1933eb1c3c94ef8667996dbff6994d5d552f target=_blank rel=noreferrer>commit:3d8b19</a> 添加了让 logo 居中显示的配置选项，但是很快又通过 <a href=https://github.com/torvalds/linux/commit/890d14d2d4b57ff5a149309da3ed36c8a529987f target=_blank rel=noreferrer>commit/890d14</a> 将这个功能转移到了命令行的选项 <code>fbcon=logo-pos:&lt;location></code> 中。</p><h3 id=动态修改启动画面 class="relative group">动态修改启动画面 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8a%a8%e6%80%81%e4%bf%ae%e6%94%b9%e5%90%af%e5%8a%a8%e7%94%bb%e9%9d%a2 aria-label=锚点>#</a></span></h3><p>上面的方法中，启动画面的数据必须编译到内核中，每次修改启动画面都要重新编译内核，不太方便。eMMC 中有一个用于放置内核和设备树文件的 FAT 分区，我们可以利用这个分区和 u-boot 的 load 命令，实现动态修改启动画面的功能，大致原理是：</p><ol><li>将 ppm 格式的 logo 图片转换成二进制格式的 ppmlogo.bin 文件，放到 FAT 分区中。</li><li>u-boot 启动时，读取 ppmlogo.bin 文件，并写入内核的保留内存中。</li><li>kernel 启动时，从保留内存的特定位置读取 ppmlogo.bin 的数据，用这个数据初始化 linux_logo 变量。</li></ol><p>首先写一个名为 ppmtobin 的程序，可以借用 <code>script/pnmtologo.c</code> 进行修改。它的作用是把一个 ppm 格式的 logo 图片转换成内核能够直接读取的二进制格式文件 ppmlogo.bin ，把这个文件放到 eMMC 的 FAT 分区，该文件的存储布局与 <code>struct linux_logo</code> 相同：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> * ---------------------------------------------
</span></span><span class=line><span class=cl> *         <span class=p>|</span>    <span class=m>0</span>        <span class=m>1</span>        <span class=m>2</span>        <span class=m>3</span>    <span class=o>(</span>byte<span class=o>)</span>
</span></span><span class=line><span class=cl> * ---------------------------------------------
</span></span><span class=line><span class=cl> *        0<span class=p>|</span>             logo <span class=nb>type</span>
</span></span><span class=line><span class=cl> * ---------------------------------------------
</span></span><span class=line><span class=cl> *        4<span class=p>|</span>             logo width<span class=o>(</span>w<span class=o>)</span>
</span></span><span class=line><span class=cl> * ---------------------------------------------
</span></span><span class=line><span class=cl> *        8<span class=p>|</span>             logo height<span class=o>(</span>h<span class=o>)</span>
</span></span><span class=line><span class=cl> * ---------------------------------------------
</span></span><span class=line><span class=cl> *       12<span class=p>|</span>             logo clutsize
</span></span><span class=line><span class=cl> * ---------------------------------------------
</span></span><span class=line><span class=cl> *       16<span class=p>|</span> 
</span></span><span class=line><span class=cl> *      ...<span class=p>|</span>             logo data
</span></span><span class=line><span class=cl> *      ...<span class=p>|</span>            <span class=o>(</span><span class=nv>size</span> <span class=o>=</span> w*h<span class=o>)</span>
</span></span><span class=line><span class=cl> * ---------------------------------------------
</span></span><span class=line><span class=cl> *   w*h+16<span class=p>|</span> 
</span></span><span class=line><span class=cl> *      ...<span class=p>|</span>             logo clut
</span></span><span class=line><span class=cl> *      ...<span class=p>|</span>        <span class=o>(</span><span class=nv>size</span> <span class=o>=</span> clutsize*3<span class=o>)</span>
</span></span><span class=line><span class=cl> * ---------------------------------------------
</span></span></code></pre></div><p>下一步就是 u-boot 中操作。先确认一下板卡的内存信息，可以在 u-boot 中执行 bdinfo 命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span>&gt; bdinfo
</span></span><span class=line><span class=cl><span class=nv>arch_number</span> <span class=o>=</span> 0x00000F8C
</span></span><span class=line><span class=cl><span class=nv>boot_params</span> <span class=o>=</span> 0x10000100
</span></span><span class=line><span class=cl>DRAM <span class=nv>bank</span>   <span class=o>=</span> 0x00000000
</span></span><span class=line><span class=cl>-&gt; <span class=nv>start</span>    <span class=o>=</span> 0x10000000   <span class=c1># 内存起始地址</span>
</span></span><span class=line><span class=cl>-&gt; <span class=nv>size</span>     <span class=o>=</span> 0x40000000   <span class=c1># 内存大小 1GB ，我们可以把 logo 文件加载到 4f000000 地址后面的内存里</span>
</span></span><span class=line><span class=cl><span class=nv>baudrate</span>    <span class=o>=</span> <span class=m>115200</span> bps
</span></span><span class=line><span class=cl>TLB <span class=nv>addr</span>    <span class=o>=</span> 0x4FFF0000
</span></span><span class=line><span class=cl><span class=nv>relocaddr</span>   <span class=o>=</span> 0x4FF40000
</span></span><span class=line><span class=cl>reloc <span class=nv>off</span>   <span class=o>=</span> 0x38740000
</span></span><span class=line><span class=cl><span class=nv>irq_sp</span>      <span class=o>=</span> 0x4EF318C0
</span></span><span class=line><span class=cl>sp <span class=nv>start</span>    <span class=o>=</span> 0x4EF318B0
</span></span><span class=line><span class=cl>FB <span class=nv>base</span>     <span class=o>=</span> 0x4EF46580
</span></span><span class=line><span class=cl>Early malloc usage: <span class=m>114</span> / <span class=m>400</span>
</span></span></code></pre></div><p>然后确认分区和文件，明确 ppplog.bin 文件的路径：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span>&gt; mmc part
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Partition Map <span class=k>for</span> MMC device <span class=m>2</span>  --   Partition Type: DOS
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Part    Start Sector    Num Sectors     UUID            Type
</span></span><span class=line><span class=cl>  <span class=m>1</span>     <span class=m>20480</span>           <span class=m>1024000</span>         bcd6138c-01     0c
</span></span><span class=line><span class=cl>  <span class=m>2</span>     <span class=m>1228800</span>         <span class=m>6324224</span>         bcd6138c-02     <span class=nv>83</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>=</span>&gt; fatls mmc 2:1
</span></span><span class=line><span class=cl>  <span class=m>7679712</span>   zimage
</span></span><span class=line><span class=cl>    <span class=m>52298</span>   imx6dl-sabresd.dtb
</span></span><span class=line><span class=cl>   <span class=m>472688</span>   ppmlogo.bin
</span></span><span class=line><span class=cl>    <span class=m>51391</span>   imx6q-sabresd.dtb
</span></span></code></pre></div><p>先试试手动加载，将 ppmlogo.bin 文件加载 <code>4f00000</code> 的地址上：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span>&gt; load mmc 2:1 4f000000 ppmlogo.bin
</span></span><span class=line><span class=cl>reading ppmlogo.bin
</span></span><span class=line><span class=cl><span class=m>472688</span> bytes <span class=nb>read</span> in <span class=m>29</span> ms <span class=o>(</span>15.5 MiB/s<span class=o>)</span>
</span></span></code></pre></div><p>加载成功后可以读一下这段内存的值，看一下写入的值是否正确：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span>&gt; md.l 4f000000 <span class=m>4</span>
</span></span><span class=line><span class=cl>4f000000: <span class=m>00000003</span> <span class=m>00000320</span> 0000024e 000000df    .... ...N.......
</span></span></code></pre></div><p>手动加载成功后，就可以新建一个环境变量，保存加载 logo 文件的操作：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span>&gt; env <span class=nb>set</span> load_logo load mmc 2:1 4f000000 ppmlogo.bin
</span></span><span class=line><span class=cl><span class=o>=</span>&gt; env save
</span></span></code></pre></div><p>手动执行一次，确保命令可以正常执行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span>&gt; run load_logo
</span></span><span class=line><span class=cl>reading ppmlogo.bin
</span></span><span class=line><span class=cl><span class=m>472688</span> bytes <span class=nb>read</span> in <span class=m>29</span> ms <span class=o>(</span>15.5 MiB/s<span class=o>)</span>
</span></span></code></pre></div><p>最后，编辑 bootcmd 环境变量，添加 <code>run load_logo;</code> ，让 u-boot 启动时自动执行 load_logo ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span>&gt; env edit bootcmd
</span></span><span class=line><span class=cl>edit: run findfdt<span class=p>;</span>run findtee<span class=p>;</span>mmc dev <span class=si>${</span><span class=nv>mmcdev</span><span class=si>}</span><span class=p>;</span> run load_logo<span class=p>;</span> <span class=k>if</span> mmc rescan<span class=p>;</span> <span class=k>then</span> <span class=k>if</span> run loadbootscript<span class=p>;</span> <span class=k>then</span> run bootscript<span class=p>;</span> <span class=k>else</span> <span class=k>if</span> run loadimage<span class=p>;</span> <span class=k>then</span> run mmcboot<span class=p>;</span> <span class=k>else</span> run netboot<span class=p>;</span> <span class=k>fi</span><span class=p>;</span> <span class=k>fi</span><span class=p>;</span> <span class=k>else</span> run netboot<span class=p>;</span> <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>=</span>&gt; env save
</span></span></code></pre></div><p>保存后重启，可以看到加载 ppmlogo.bin 时，u-boot 打印的如下信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>reading ppmlogo.bin
</span></span><span class=line><span class=cl><span class=m>472688</span> bytes <span class=nb>read</span> in <span class=m>28</span> ms <span class=o>(</span>16.1 MiB/s<span class=o>)</span>
</span></span></code></pre></div><p>手动修改 u-boot 没有问题后，可以在 u-boot 源码中修改 <code>bootcmd</code> 的值，使 u-boot 启动时自动加载 logo 图片。例如修改 imx6q 的配置文件 `include/configs/mx6sabre_common.h：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>#define CONFIG_EXTRA_ENV_SETTINGS \
</span></span><span class=line><span class=cl>        CONFIG_MFG_ENV_SETTINGS \
</span></span><span class=line><span class=cl>        TEE_ENV \
</span></span><span class=line><span class=cl>        &#34;epdc_waveform=epdc_splash.bin\0&#34; \
</span></span><span class=line><span class=cl>        &#34;script=boot.scr\0&#34; \
</span></span><span class=line><span class=cl>        &#34;image=zImage\0&#34; \
</span></span><span class=line><span class=cl><span class=gi>+       &#34;load_logo=load mmc 2:1 4f000000 ppmlogo.bin&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span>... ...
</span></span><span class=line><span class=cl>#define CONFIG_BOOTCOMMAND \
</span></span><span class=line><span class=cl>        &#34;run findfdt;&#34; \
</span></span><span class=line><span class=cl>        &#34;run findtee;&#34; \
</span></span><span class=line><span class=cl>        &#34;mmc dev ${mmcdev};&#34; \
</span></span><span class=line><span class=cl><span class=gi>+       &#34;run load_logo&#34; \
</span></span></span><span class=line><span class=cl><span class=gi></span>        &#34;if mmc rescan; then &#34; \
</span></span><span class=line><span class=cl>                &#34;if run loadbootscript; then &#34; \
</span></span><span class=line><span class=cl>                &#34;run bootscript; &#34; \
</span></span><span class=line><span class=cl>                &#34;else &#34; \
</span></span><span class=line><span class=cl>                        &#34;if run loadimage; then &#34; \
</span></span><span class=line><span class=cl>                                &#34;run mmcboot; &#34; \
</span></span><span class=line><span class=cl>                        &#34;else run netboot; &#34; \
</span></span><span class=line><span class=cl>                        &#34;fi; &#34; \
</span></span><span class=line><span class=cl>                &#34;fi; &#34; \
</span></span><span class=line><span class=cl>        &#34;else run netboot; fi&#34;
</span></span><span class=line><span class=cl>#endif
</span></span></code></pre></div><p>最后就是修改内核。我们需要在设备树的 <code>/reserved-memory</code> 中添加一个字节点，申请一段保留内存，将地址 <code>0x4f000000</code> 开始的 3MB 内存留給 u-boot 存放的 ppmlogo.bin ，避免内核启动后将这段内存覆盖：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>reserved</span><span class=o>-</span><span class=n>memory</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>linux</span><span class=o>-</span><span class=n>logo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>compatible</span> <span class=o>=</span> <span class=s>&#34;cs-logo&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>reusable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>reg</span> <span class=o>=</span> <span class=o>&lt;</span><span class=mh>0x4f000000</span> <span class=mh>0x300000</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>然后修改 <code>drivers/video/logo/logo.c</code> 文件中的 <code>fb_find_logo()</code> 函数，读取 <code>0x4f000000</code> 内存中的数据，并结构化为 <code>struct linux_logo</code> 格式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gh>diff --git a/drivers/video/logo/logo.c b/drivers/video/logo/logo.c
</span></span></span><span class=line><span class=cl><span class=gh>index b6bc4a0..d304272 100644
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gd>--- a/drivers/video/logo/logo.c
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/drivers/video/logo/logo.c
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -28,6 +28,8 @@ MODULE_PARM_DESC(nologo, &#34;Disables startup logo&#34;);
</span></span></span><span class=line><span class=cl><span class=gu></span>
</span></span><span class=line><span class=cl> static bool logos_freed;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gi>+struct linux_logo cs_logo; //存放内存中读取的 logo 数据，一定要全局变量
</span></span></span><span class=line><span class=cl><span class=gi>+
</span></span></span><span class=line><span class=cl><span class=gi></span> static int __init fb_logo_late_init(void)
</span></span><span class=line><span class=cl> {
</span></span><span class=line><span class=cl>        logos_freed = true;
</span></span><span class=line><span class=cl><span class=gu>@@ -43,6 +45,7 @@ late_initcall(fb_logo_late_init);
</span></span></span><span class=line><span class=cl><span class=gu></span> const struct linux_logo * __ref fb_find_logo(int depth)
</span></span><span class=line><span class=cl> {
</span></span><span class=line><span class=cl>        const struct linux_logo *logo = NULL;
</span></span><span class=line><span class=cl><span class=gi>+    char *logo_addr = NULL;  
</span></span></span><span class=line><span class=cl><span class=gi></span>
</span></span><span class=line><span class=cl>        if (nologo || logos_freed)
</span></span><span class=line><span class=cl>                return NULL;
</span></span><span class=line><span class=cl><span class=gu>@@ -76,7 +79,17 @@ const struct linux_logo * __ref fb_find_logo(int depth)
</span></span></span><span class=line><span class=cl><span class=gu></span>        if (depth &gt;= 8) {
</span></span><span class=line><span class=cl> #ifdef CONFIG_LOGO_LINUX_CLUT224
</span></span><span class=line><span class=cl>                /* Generic Linux logo */
</span></span><span class=line><span class=cl><span class=gd>-               logo = &amp;logo_linux_clut224;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+        logo_addr = phys_to_virt((phys_addr_t)(0x4f000000));  // 将物理地址转换为虚拟地址
</span></span></span><span class=line><span class=cl><span class=gi>+        memcpy(&amp;cs_logo.type, logo_addr, 4);
</span></span></span><span class=line><span class=cl><span class=gi>+        memcpy(&amp;cs_logo.width, logo_addr+4, 4);
</span></span></span><span class=line><span class=cl><span class=gi>+        memcpy(&amp;cs_logo.height, logo_addr+8, 4);
</span></span></span><span class=line><span class=cl><span class=gi>+        memcpy(&amp;cs_logo.clutsize,logo_addr+12, 4);
</span></span></span><span class=line><span class=cl><span class=gi>+        printk(&#34;load cs_logo head: %d,%d,%d,%d \n&#34;, cs_logo.type, cs_logo.width, cs_logo.height, cs_logo.clutsize);
</span></span></span><span class=line><span class=cl><span class=gi>+
</span></span></span><span class=line><span class=cl><span class=gi>+        cs_logo.data = logo_addr+16;
</span></span></span><span class=line><span class=cl><span class=gi>+        cs_logo.clut = logo_addr+16+cs_logo.width*cs_logo.height;
</span></span></span><span class=line><span class=cl><span class=gi>+        logo = &amp;cs_logo;
</span></span></span><span class=line><span class=cl><span class=gi>+
</span></span></span><span class=line><span class=cl><span class=gi></span> #endif
</span></span><span class=line><span class=cl> #ifdef CONFIG_LOGO_BLACKFIN_CLUT224
</span></span></code></pre></div><p>修改完毕，下面是 ppmtobin 的程序的源码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm> * ppmtobin.c
</span></span></span><span class=line><span class=cl><span class=cm> * compile: gcc -Wall ppmtobin.c -o ppmtobin
</span></span></span><span class=line><span class=cl><span class=cm> * Author: LiShaocheng
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * Convert a logo in ASCII PNM format to binary file, format is 
</span></span></span><span class=line><span class=cl><span class=cm> * ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=cm> *         |    0        1        2        3    
</span></span></span><span class=line><span class=cl><span class=cm> * ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=cm> *        0|             logo type
</span></span></span><span class=line><span class=cl><span class=cm> * ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=cm> *        4|             logo width(w)
</span></span></span><span class=line><span class=cl><span class=cm> * ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=cm> *        8|             logo height(h)
</span></span></span><span class=line><span class=cl><span class=cm> * ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=cm> *       12|             logo clutsize
</span></span></span><span class=line><span class=cl><span class=cm> * ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=cm> *       16| 
</span></span></span><span class=line><span class=cl><span class=cm> *      ...|             logo data
</span></span></span><span class=line><span class=cl><span class=cm> *      ...|            (size = w*h)
</span></span></span><span class=line><span class=cl><span class=cm> * ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=cm> *   w*h+16| 
</span></span></span><span class=line><span class=cl><span class=cm> *      ...|             logo clut
</span></span></span><span class=line><span class=cl><span class=cm> *      ...|        (size = clutsize*3)
</span></span></span><span class=line><span class=cl><span class=cm> * ---------------------------------------------
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;ctype.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdarg.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>bin_header</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>type</span><span class=p>;</span> <span class=cm>/* one of LINUX_LOGO_* */</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>width</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>clutsize</span><span class=p>;</span>     <span class=cm>/* LINUX_LOGO_CLUT224 only */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>appname</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>outputname</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>FILE</span> <span class=o>*</span><span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define MAX_LINUX_LOGO_COLORS 224
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>color</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>red</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>green</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>blue</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>logo_width</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>logo_height</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>color</span> <span class=o>**</span><span class=n>logo_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>color</span> <span class=n>logo_clut</span><span class=p>[</span><span class=n>MAX_LINUX_LOGO_COLORS</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>logo_clutsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>is_plain_pbm</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>die</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>fmt</span><span class=p>,</span> <span class=p>...)</span>
</span></span><span class=line><span class=cl>    <span class=nf>__attribute__</span><span class=p>((</span><span class=n>noreturn</span><span class=p>))</span> <span class=nf>__attribute</span><span class=p>((</span><span class=nf>format</span><span class=p>(</span><span class=n>printf</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)));</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>usage</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=nf>__attribute</span><span class=p>((</span><span class=n>noreturn</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// read data from PNG file
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nf>get_number</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>c</span><span class=p>,</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Skip leading whitespace */</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=nf>fgetc</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>die</span><span class=p>(</span><span class=s>&#34;%s: end of file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>==</span> <span class=sc>&#39;#&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/* Ignore comments &#39;till end of line */</span>
</span></span><span class=line><span class=cl>            <span class=k>do</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>c</span> <span class=o>=</span> <span class=nf>fgetc</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nf>die</span><span class=p>(</span><span class=s>&#34;%s: end of file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>c</span> <span class=o>!=</span> <span class=sc>&#39;\n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=nf>isspace</span><span class=p>(</span><span class=n>c</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Parse decimal number */</span>
</span></span><span class=line><span class=cl>    <span class=n>val</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nf>isdigit</span><span class=p>(</span><span class=n>c</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>=</span> <span class=mi>10</span> <span class=o>*</span> <span class=n>val</span> <span class=o>+</span> <span class=n>c</span> <span class=o>-</span> <span class=sc>&#39;0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* some PBM are &#39;broken&#39;; GiMP for example exports a PBM without space
</span></span></span><span class=line><span class=cl><span class=cm>	 * between the digits. This is Ok cause we know a PBM can only have a &#39;1&#39;
</span></span></span><span class=line><span class=cl><span class=cm>	 * or a &#39;0&#39; for the digit. */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>is_plain_pbm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=nf>fgetc</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>die</span><span class=p>(</span><span class=s>&#34;%s: end of file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nf>get_number255</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>maxval</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>val</span> <span class=o>=</span> <span class=nf>get_number</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=mi>255</span> <span class=o>*</span> <span class=n>val</span> <span class=o>+</span> <span class=n>maxval</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=n>maxval</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>read_image</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>magic</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>maxval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* open image file */</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;Cannot open file %s: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* check file type and read file header */</span>
</span></span><span class=line><span class=cl>    <span class=n>magic</span> <span class=o>=</span> <span class=nf>fgetc</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>magic</span> <span class=o>!=</span> <span class=sc>&#39;P&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;%s is not a PNM file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>magic</span> <span class=o>=</span> <span class=nf>fgetc</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>magic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;1&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;2&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* Plain PBM/PGM */</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;%s: Plain PBM/PGM is not supported</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Use pnmnoraw(1) to convert it to ASCII PNM</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;3&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* Plain PPM */</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;4&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;5&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;6&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* Binary PBM/PGM/PPM */</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;%s: Binary PNM is not supported</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Use pnmnoraw(1) to convert it to ASCII PNM</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;%s is not a PNM file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>logo_width</span> <span class=o>=</span> <span class=nf>get_number</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>logo_height</span> <span class=o>=</span> <span class=nf>get_number</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* allocate image data */</span>
</span></span><span class=line><span class=cl>    <span class=n>logo_data</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>color</span> <span class=o>**</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=n>logo_height</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>color</span> <span class=o>*</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>logo_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>die</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>logo_height</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>logo_data</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>logo_width</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>color</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>logo_data</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=nf>die</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* read Plain PPM data */</span>
</span></span><span class=line><span class=cl>    <span class=n>maxval</span> <span class=o>=</span> <span class=nf>get_number</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>logo_height</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>logo_width</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>logo_data</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>].</span><span class=n>red</span> <span class=o>=</span> <span class=nf>get_number255</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>maxval</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logo_data</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>].</span><span class=n>green</span> <span class=o>=</span> <span class=nf>get_number255</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>maxval</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>logo_data</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>].</span><span class=n>blue</span> <span class=o>=</span> <span class=nf>get_number255</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>maxval</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* close file */</span>
</span></span><span class=line><span class=cl>    <span class=nf>fclose</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>int</span> <span class=nf>is_equal</span><span class=p>(</span><span class=k>struct</span> <span class=n>color</span> <span class=n>c1</span><span class=p>,</span> <span class=k>struct</span> <span class=n>color</span> <span class=n>c2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>c1</span><span class=p>.</span><span class=n>red</span> <span class=o>==</span> <span class=n>c2</span><span class=p>.</span><span class=n>red</span> <span class=o>&amp;&amp;</span> <span class=n>c1</span><span class=p>.</span><span class=n>green</span> <span class=o>==</span> <span class=n>c2</span><span class=p>.</span><span class=n>green</span> <span class=o>&amp;&amp;</span> <span class=n>c1</span><span class=p>.</span><span class=n>blue</span> <span class=o>==</span> <span class=n>c2</span><span class=p>.</span><span class=n>blue</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>write_logo_clut224</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>write_hex_cnt</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>bin_header</span> <span class=n>header</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>bin_data</span><span class=p>[</span><span class=n>logo_width</span><span class=o>*</span><span class=n>logo_height</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>bin_clut</span><span class=p>[</span><span class=n>MAX_LINUX_LOGO_COLORS</span><span class=o>*</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* validate image */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>logo_height</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>logo_width</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>logo_clutsize</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nf>is_equal</span><span class=p>(</span><span class=n>logo_data</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>],</span> <span class=n>logo_clut</span><span class=p>[</span><span class=n>k</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>k</span> <span class=o>==</span> <span class=n>logo_clutsize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>logo_clutsize</span> <span class=o>==</span> <span class=n>MAX_LINUX_LOGO_COLORS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nf>die</span><span class=p>(</span><span class=s>&#34;Image has more than %d colors</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=s>&#34;Use ppmquant(1) to reduce the number of colors</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>MAX_LINUX_LOGO_COLORS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>logo_clut</span><span class=p>[</span><span class=n>logo_clutsize</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>logo_data</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* open bin file */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>outputname</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Creat %s file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>outputname</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=n>outputname</span><span class=p>,</span> <span class=s>&#34;wb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>die</span><span class=p>(</span><span class=s>&#34;Cannot create file %s: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>outputname</span><span class=p>,</span> <span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Creat ppmlogo.bin file</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;ppmlogo.bin&#34;</span><span class=p>,</span> <span class=s>&#34;wb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>die</span><span class=p>(</span><span class=s>&#34;Cannot create file %s: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>outputname</span><span class=p>,</span> <span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>        
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* write logo header to bin file*/</span>
</span></span><span class=line><span class=cl>    <span class=n>header</span><span class=p>.</span><span class=n>type</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>header</span><span class=p>.</span><span class=n>width</span> <span class=o>=</span> <span class=n>logo_width</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>header</span><span class=p>.</span><span class=n>height</span> <span class=o>=</span> <span class=n>logo_height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>header</span><span class=p>.</span><span class=n>clutsize</span> <span class=o>=</span> <span class=n>logo_clutsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;logo_width is %d </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>logo_width</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;logo_height is %d </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>logo_height</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;logo_clutsize is %d </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>logo_clutsize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>len</span> <span class=o>=</span> <span class=nf>fwrite</span><span class=p>(</span><span class=o>&amp;</span><span class=n>header</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>header</span><span class=p>),</span> <span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;write logo header len is %d bytes</span><span class=se>\n\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* write logo data to bin file*/</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>logo_height</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>logo_width</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>logo_clutsize</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nf>is_equal</span><span class=p>(</span><span class=n>logo_data</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>],</span> <span class=n>logo_clut</span><span class=p>[</span><span class=n>k</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>                    <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>bin_data</span><span class=p>[</span><span class=n>write_hex_cnt</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>k</span> <span class=o>+</span> <span class=mi>32</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;bin data len is %d bytes</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>write_hex_cnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>len</span> <span class=o>=</span> <span class=nf>fwrite</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bin_data</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>bin_data</span><span class=p>),</span> <span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;write bin data len is %d bytes</span><span class=se>\n\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* write logo clut to bin file*/</span>
</span></span><span class=line><span class=cl>    <span class=n>write_hex_cnt</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>logo_clutsize</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>bin_clut</span><span class=p>[</span><span class=n>write_hex_cnt</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>logo_clut</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>red</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>bin_clut</span><span class=p>[</span><span class=n>write_hex_cnt</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>logo_clut</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>green</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>bin_clut</span><span class=p>[</span><span class=n>write_hex_cnt</span><span class=o>++</span><span class=p>]</span> <span class=o>=</span> <span class=n>logo_clut</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>blue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;bin clut len is %d bytes</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>write_hex_cnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>len</span> <span class=o>=</span> <span class=nf>fwrite</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bin_clut</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>bin_clut</span><span class=p>),</span> <span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;write bin clut len is %d bytes</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>fclose</span><span class=p>(</span><span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>die</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>fmt</span><span class=p>,</span> <span class=p>...)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>va_list</span> <span class=n>ap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>va_start</span><span class=p>(</span><span class=n>ap</span><span class=p>,</span> <span class=n>fmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>vfprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=n>fmt</span><span class=p>,</span> <span class=n>ap</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>va_end</span><span class=p>(</span><span class=n>ap</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>usage</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>die</span><span class=p>(</span><span class=s>&#34;Convert a logo in ASCII PNM format to binary file</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;Usage: %s [options] &lt;filename&gt;</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;Valid options:</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;    -h          : display this usage information</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;    -o &lt;output&gt; : output to file &lt;output&gt; instead of default ppmlogo.bin</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>appname</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>opt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>appname</span> <span class=o>=</span> <span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>opterr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>opt</span> <span class=o>=</span> <span class=nf>getopt</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=s>&#34;ho:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>opt</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=p>(</span><span class=n>opt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=sc>&#39;h&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=nf>usage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=sc>&#39;o&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>outputname</span> <span class=o>=</span> <span class=n>optarg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=nf>usage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>optind</span> <span class=o>!=</span> <span class=n>argc</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>usage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>filename</span> <span class=o>=</span> <span class=n>argv</span><span class=p>[</span><span class=n>optind</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>read_image</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>write_logo_clut224</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=一些问题 class="relative group">一些问题 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e4%b8%80%e4%ba%9b%e9%97%ae%e9%a2%98 aria-label=锚点>#</a></span></h3><p>如果你的屏幕分辨率是 800x600 ，而你准备了一张 800x600 的图片，替换后会发现启动画面没有显示，查看内核信息会提示：</p><pre tabindex=0><code>fbcon_init: disable boot-logo (boot-logo bigger than screen).
</code></pre><p>这条信息来自 <code>drivers/video/console/fbcon.c</code> 文件的 <code>fbcon_prepare_logo()</code> 函数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>logo_lines</span> <span class=o>&gt;</span> <span class=n>vc</span><span class=o>-&gt;</span><span class=n>vc_bottom</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>logo_shown</span> <span class=o>=</span> <span class=n>FBCON_LOGO_CANSHOW</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;fbcon_init: disable boot-logo (boot-logo bigger than screen).</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>logo_lines 的值来自：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>logo_lines</span> <span class=o>=</span> <span class=nf>DIV_ROUND_UP</span><span class=p>(</span><span class=n>logo_height</span><span class=p>,</span> <span class=n>vc</span><span class=o>-&gt;</span><span class=n>vc_font</span><span class=p>.</span><span class=n>height</span><span class=p>);</span>
</span></span></code></pre></div><p><code>logo_height</code> 表示图片的高度，就是 600 ，<code>vc->vc_font.height</code> 的默认值是 16 ，DIV_ROUND_UP 的定义是：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define DIV_ROUND_UP __KERNEL_DIV_ROUND_UP#define __KERNEL_DIV_ROUND_UP(n, d) (((n) + (d) - 1) / (d))
</span></span></span></code></pre></div><p>计算后得到的 logo_lines 就是 38 。打印 vc->vc_bottom 的值发现是 37 ，所有需要把图片的纵向分辨率调小到 592 ，这样计算出的 logo_lines 就是 37 。</p><h3 id=关于保留内存 class="relative group">关于保留内存 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%85%b3%e4%ba%8e%e4%bf%9d%e7%95%99%e5%86%85%e5%ad%98 aria-label=锚点>#</a></span></h3><p>参考内核文档 <a href=https://www.kernel.org/doc/Documentation/devicetree/bindings/reserved-memory/reserved-memory.txt target=_blank rel=noreferrer>reserved-memory.txt</a> 。</p><p>可以在设备树的 <code>/reserved-memory</code> 节点下面新建子节点，用于描述特定的内存区域，Linux 会将这部分内存排除在正常使用之外。 <code>/reserved-memory</code> 节点的定义如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>reserved</span><span class=o>-</span><span class=n>memory</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cp>#address-cells = &lt;1&gt;; # 标准定义，用于设置子节点的 reg 属性的书写格式
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=cp>#size-cells = &lt;1&gt;; # 标准定义，用于设置子节点的 reg 属性的书写格式
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=n>ranges</span><span class=p>;</span> <span class=err>#</span> <span class=err>标准定义，空属性</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cp>#子节点
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>}</span>
</span></span></code></pre></div><p>在下面的子节点中，可以使用 <code>reg</code> 属性来指定保留内存的范围，或者用 <code>size</code> 属性请求动态分配一段特定大小的内存，如果两个都存在，则 <code>reg</code> 优先，<code>size</code> 会被忽略。按照推荐的做法，节点名称应该反映节点的目的，如果是静态分配，应该附加上单位地址 <code>@&lt;address></code> 。</p><p>可用的属性如下：</p><ol><li>静态分配<ul><li>reg - 标准定义，必须设置。语法是 <code>&lt;address offset></code> ，例如 <code>reg = &lt;0x10000000 0x40000000>;</code> 表示从 0x10000000 开始，分配 1GB 内存。</li></ul></li><li>动态分配<ul><li>size - 基于父类的 #size-cells 的长度，要保留的内存的字节数，必须设置。</li><li>alignment - 基于父类的#size-cells的长度，用于对齐分配的地址边界，可选设置。</li><li>alloc-ranges - 设置一个地址和长度，请求在这个特定区域内分配保留内存，可选设置。</li></ul></li></ol><p>可选的附加属性：</p><ol><li><p>compatible - 可以包含以下字符串。</p><ul><li><p>shared-dma-pool 。这表示一个内存区域，旨在作为一组设备的DMA缓冲区的共享池使用。如果有必要，它可以被操作系统用来实例化必要的池管理子系统。</p></li><li><p>厂商特定的字符串，形式为 <code>&lt;vendor>,[&lt;device>-]&lt;usage></code> 。</p></li></ul></li><li><p>no-map - 空属性，表示操作系统不得创建该区域的虚拟映射作为其系统内存标准映射的一部分，也不允许在使用该区域的设备驱动程序控制之外的任何情况下对其进行投机访问。</p></li><li><p>reusable - 空属性，操作系统可以使用该区域的内存，但有一个限制，即拥有该区域的设备驱动程序需要能够将其收回。通常情况下，这意味着操作系统可以使用该区域来存储易失性或缓存的数据，这些数据可以通过其他方式重新生成或迁移到其他地方。</p></li></ol><blockquote><p>no-map 和 reusable 两个属性不能共存，因为它们的逻辑是矛盾的。</p></blockquote><p>Linux 还有特定的实现：</p><ul><li><p>如果 &ldquo;linux,cma-default &ldquo;属性存在，那么 Linux 将使用该区域作为连续内存分配器的默认池。</p></li><li><p>如果 &ldquo;linux,dma-default &ldquo;属性存在，那么 Linux 将使用该区域作为一致 DMA 分配器的默认池。</p></li></ul><p>其他设备节点可以通过 <code>memory-region</code> 属性引用已定义的保留内存：</p><ul><li>memory-region - 它的值应该是保留内存子节点的名称</li><li>memory-region-names - 保留内存子节点的名称的列表。</li></ul><p>下面是一个例子，定义了三个保留内存：</p><ul><li>一个是所有设备驱动的默认区域（名为linux,cma@72000000，大小为64MB）。</li><li>一个专门用于帧缓冲设备（命名为framebuffer@78000000，8MB）。</li><li>一个用于多媒体处理（名为multimedia-memory@77000000，64MB）。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=o>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cp>#address-cells = &lt;1&gt;;
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=cp>#size-cells = &lt;1&gt;;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>	<span class=n>memory</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>reg</span> <span class=o>=</span> <span class=o>&lt;</span><span class=mh>0x40000000</span> <span class=mh>0x40000000</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>reserved</span><span class=o>-</span><span class=n>memory</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=cp>#address-cells = &lt;1&gt;;
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=cp>#size-cells = &lt;1&gt;;
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=n>ranges</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=cm>/* global autoconfigured region for contiguous allocations */</span>
</span></span><span class=line><span class=cl>		<span class=n>linux</span><span class=p>,</span><span class=n>cma</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>compatible</span> <span class=o>=</span> <span class=s>&#34;shared-dma-pool&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>reusable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>size</span> <span class=o>=</span> <span class=o>&lt;</span><span class=mh>0x4000000</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>alignment</span> <span class=o>=</span> <span class=o>&lt;</span><span class=mh>0x2000</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>linux</span><span class=p>,</span><span class=n>cma</span><span class=o>-</span><span class=k>default</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nl>display_reserved</span><span class=p>:</span> <span class=n>framebuffer</span><span class=err>@</span><span class=mi>78000000</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>reg</span> <span class=o>=</span> <span class=o>&lt;</span><span class=mh>0x78000000</span> <span class=mh>0x800000</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nl>multimedia_reserved</span><span class=p>:</span> <span class=n>multimedia</span><span class=err>@</span><span class=mi>77000000</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>compatible</span> <span class=o>=</span> <span class=s>&#34;acme,multimedia-memory&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>reg</span> <span class=o>=</span> <span class=o>&lt;</span><span class=mh>0x77000000</span> <span class=mh>0x4000000</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* ... */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nl>fb0</span><span class=p>:</span> <span class=n>video</span><span class=err>@</span><span class=mi>12300000</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>memory</span><span class=o>-</span><span class=n>region</span> <span class=o>=</span> <span class=o>&lt;&amp;</span><span class=n>display_reserved</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* ... */</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nl>scaler</span><span class=p>:</span> <span class=n>scaler</span><span class=err>@</span><span class=mi>12500000</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>memory</span><span class=o>-</span><span class=n>region</span> <span class=o>=</span> <span class=o>&lt;&amp;</span><span class=n>multimedia_reserved</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* ... */</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nl>codec</span><span class=p>:</span> <span class=n>codec</span><span class=err>@</span><span class=mi>12600000</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>memory</span><span class=o>-</span><span class=n>region</span> <span class=o>=</span> <span class=o>&lt;&amp;</span><span class=n>multimedia_reserved</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* ... */</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h2 id=用户空间的启动画面 class="relative group">用户空间的启动画面 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%94%a8%e6%88%b7%e7%a9%ba%e9%97%b4%e7%9a%84%e5%90%af%e5%8a%a8%e7%94%bb%e9%9d%a2 aria-label=锚点>#</a></span></h2><p>用户空间的启动画面是用 psplash 实现的，它的原理就是使用 FrameBuffer 的 API 在屏幕上绘制图片。源码可以用 git 下载：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git://git.yoctoproject.org/psplash
</span></span></code></pre></div><p>源文件比较简单，比较重要的有：</p><ul><li>make-image-header.sh ，它的作用是把 png 格式的图片转换为 C 语言头文件，这样就可以把图片编译到可执行的二进制文件中。</li><li>psplash.c ，main 函数所在的源文件，可以在这里查看绘制启动画面的流程。</li><li>psplash-config.h ，基本的配置宏定义。</li><li>psplash-colors.h ，颜色相关的配置宏定义。</li><li>psplash-poky-img.h ，包含图片数据的头文件。</li><li>psplash-fb.c ，定义了 framebuffer 绘图函数。</li></ul><p><code>psplash-config.h</code> 头文件定义了显示配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* 设置启动画面中文本信息，默认是空的。如果不用，最好注释掉，否则会在启动画面中显示一行背景色 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define PSPLASH_STARTUP_MSG &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* 一个布尔值，用于指示图片的显示位置，如果图片的分辨率等于屏幕分辨率，最好设为 1 ，如果图片的分辨率小于屏幕分辨率 ，可以设置为 0 ，然后用后面的参数调整显示效果*/</span>
</span></span><span class=line><span class=cl><span class=cp>#define PSPLASH_IMG_FULLSCREEN 0
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl> <span class=cm>/* 设置分屏显示的分子 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define PSPLASH_IMG_SPLIT_NUMERATOR 5
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* 设置分屏显示的分母 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define PSPLASH_IMG_SPLIT_DENOMINATOR 6
</span></span></span></code></pre></div><p><code>psplash-colors.h</code> 头文件定义了画面元素的颜色：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* 设置背景颜色，RGB */</span>
</span></span><span class=line><span class=cl><span class=cp>#define PSPLASH_BACKGROUND_COLOR 0xec,0xec,0xe1
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* 设置文字的颜色，RGB */</span>
</span></span><span class=line><span class=cl><span class=cp>#define PSPLASH_TEXT_COLOR 0x6d,0x6d,0x70
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* 设置进度条的颜色，RGB */</span>
</span></span><span class=line><span class=cl><span class=cp>#define PSPLASH_BAR_COLOR 0x6d,0x6d,0x70
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* 设置进度条的背景颜色，RGB */</span>
</span></span><span class=line><span class=cl><span class=cp>#define PSPLASH_BAR_BACKGROUND_COLOR 0xec,0xec,0xe1
</span></span></span></code></pre></div><p><code>psplash-poky-img.h</code> 文件用 make-image-header.sh 脚本生成的，根据图片的属性定义了一些宏：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* 图片的横向分辨率 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define POKY_IMG_WIDTH (800)
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=cm>/* 图片的纵向分辨率 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define POKY_IMG_HEIGHT (600)
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=cm>/* 一个像素的数据大小，单位是字节 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define POKY_IMG_BYTES_PER_PIXEL (3) </span><span class=cm>/* 3:RGB, 4:RGBA */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=cm>/* 一行像素占用的数据大小，就是 POKY_IMG_WIDTH*POKY_IMG_BYTES_PER_PIXEL ，单位是字节 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define POKY_IMG_ROWSTRIDE (2400)
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=cm>/* 一张图片的像素数据 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define POKY_IMG_RLE_PIXEL_DATA ((uint8*) &#34;&#34;
</span></span></span></code></pre></div><p><code>psplash.c</code> 中的 main 函数绘制了启动画面，基本流程如下：</p><ol><li>初始化 framebuffer</li><li>调用 psplash_fb_draw_rect 函数，将屏幕上的每个像素部设为 PSPLASH_BACKGROUND_COLOR 颜色</li><li>调用 psplash_fb_draw_image 函数，将 POKY_IMG_RLE_PIXEL_DATA 的所有数据绘制到屏幕上：<ol><li>横向是居中显示。</li><li>如果 PSPLASH_IMG_FULLSCREEN 为 1 ，横向也是居中显示。</li><li>如果 PSPLASH_IMG_FULLSCREEN 为 0 ，纵向占用屏幕的 PSPLASH_IMG_SPLIT_NUMERATOR/PSPLASH_IMG_SPLIT_DENOMINATOR 部分</li></ol></li><li>调用 psplash_fb_draw_image 函数，绘制进度条。</li><li>调用 psplash_draw_progress 函数，绘制进度条的动画。</li><li>如果定义了 PSPLASH_STARTUP_MSG ，调用 psplash_draw_msg 函数，在进度条上方显示文本信息。</li></ol><p>如果要更换启动画面，首先要准备一张 png 格式的图片，重命名为 psplash-poky.png ，分辨率应该小于等于屏幕的分辨率。然后使用 <code>make-image-header.sh</code> 脚本将图片转换为 C 语音的格式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./make-image-header.sh psplash-poky.png POKY
</span></span></code></pre></div><blockquote><p>这个脚本使用 gdk-pixbuf-csource 工具进行转换，需要安装 gdk-pixbuf-csource ：<code>sudo apt install libgdk-pixbuf2.0-dev</code></p></blockquote><p>处理完毕会生成 <code>psplash-poky-img.h</code> 头文件，直接编译，生成的 psplash 二进制文件就包含了启动画面，在系统启动时执行就可以显示。iMX Yocto 把这个文件名改成了 psplash-default ，安装在 <code>/usr/bin</code> 目录下，通过 <code>psplash-start.service</code> 服务启动。</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mb-0 !mt-0 me-4 h-24 w-24 rounded-full" width=96 height=96 alt=Shaocheng.Li src=/img/author_hucdd16a8e5aab658b1bf3664f1886d7a1_71871_192x192_fill_box_center_3.png loading=lazy><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Shaocheng.Li</div><div class="text-sm text-neutral-700 dark:text-neutral-400">A Linux software engineer.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/exbob target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/2021/04/10/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Linux 系统的 SPI 设备编程</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-04-10 21:19:11 +0800 +0800">2021 April 10</time>
</span></span></a></span><span><a class="group flex text-right" href=/posts/2021/07/03/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">使用 VSCode 绘制数字电路时序图</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-07-03 18:32:49 +0800 +0800">2021 July 3</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=https://giscus.app/client.js data-repo=exbob/exbob.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkyMzM5ODIwNTg=" data-category=Announcements data-category-id=DIC_kwDODfJIas4Cc6dQ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light_protanopia data-lang=zh-CN crossorigin=anonymous async></script></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=回到顶部 title=回到顶部>&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024
Shaocheng.Li</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a> 强力驱动</p></div><div class="flex flex-row items-center"><div class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"><button id=appearance-switcher-0 type=button aria-label="appearance switcher"><div class="flex items-center justify-center w-12 h-12 dark:hidden" title=切换为深色模式><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden w-12 h-12 dark:flex" title=切换为浅色模式><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://shaocheng.li/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>