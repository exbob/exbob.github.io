<!doctype html><html lang=zh-cn dir=Chinese-Simplified class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><title>建立一个定制内核 &#183; Shaocheng.Li</title>
<meta name=title content="建立一个定制内核 &#183; Shaocheng.Li"><script type=text/javascript src=/js/appearance.min.022d0ebc3b46a335eb1c7ef79b7f2de143d7cd5156d433638592ef1ce5f8554e.js integrity="sha256-Ai0OvDtGozXrHH73m38t4UPXzVFW1DNjhZLvHOX4VU4="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.569cc57d5993584135ff38133d1f599f8f8db0303a9e886172e4b5aabb177ac6.css integrity="sha256-VpzFfVmTWEE1/zgTPR9Zn4+NsDA6nohhcuS1qrsXesY="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.f29ffdffd9ab4cc95250c3c7196b2d5dae8ee6ef0a4139451073f90183ae7e31.js integrity="sha256-8p/9/9mrTMlSUMPHGWstXa6O5u8KQTlFEHP5AYOufjE=" data-copy=复制 data-copied=已复制></script><meta name=description content="
      
        原文：
      
    "><link rel=canonical href=https://shaocheng.li/posts/2012/04/01/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="建立一个定制内核"><meta property="og:description" content="原文："><meta property="og:type" content="article"><meta property="og:url" content="https://shaocheng.li/posts/2012/04/01/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-04-01T08:00:00+08:00"><meta property="article:modified_time" content="2012-04-01T08:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="建立一个定制内核"><meta name=twitter:description content="原文："><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"建立一个定制内核","headline":"建立一个定制内核","abstract":"原文：","inLanguage":"zh-cn","url":"https:\/\/shaocheng.li\/posts\/2012\/04\/01\/","author":{"@type":"Person","name":"Shaocheng.Li"},"copyrightYear":"2012","dateCreated":"2012-04-01T08:00:00\u002b08:00","datePublished":"2012-04-01T08:00:00\u002b08:00","dateModified":"2012-04-01T08:00:00\u002b08:00","mainEntityOfPage":"true","wordCount":"570"}</script><meta name=author content="Shaocheng.Li"><link href=https://github.com/exbob rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold pe-2 text-primary-600 dark:text-primary-400">&darr;</span>跳到主要内容</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Shaocheng.Li</a></div><ul class="flex flex-col list-none text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/posts/ title=Posts><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">文章列表</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=search-button-1 title="搜索 (/)">
<span class="transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=appearance-switcher-1 type=button aria-label="appearance switcher">
<span class="inline transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600 dark:hidden" title=切换为深色模式><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span>
</span><span class="hidden transition-colors group-dark:hover:text-primary-400 group-hover:text-primary-600 dark:inline" title=切换为浅色模式><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></span></button></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">建立一个定制内核</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2012-04-01 08:00:00 +0800 +0800">2012 April 1</time><span class="px-2 text-primary-500">&#183;</span><span>570 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>3 分钟</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 print:hidden lg:sticky lg:top-10"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="-ms-5 block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="-ms-5 border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#1-从源码rpm包建立一个内核>1. 从源码RPM包建立一个内核</a><ul><li><a href=#11-获得源码>1.1. 获得源码</a></li><li><a href=#12-准备内核源码树>1.2. 准备内核源码树</a></li><li><a href=#13-复制源码树和生成一个补丁>1.3. 复制源码树和生成一个补丁</a></li><li><a href=#14-配置内核选项>1.4. 配置内核选项</a></li><li><a href=#15-准备建立文件>1.5. 准备建立文件</a></li><li><a href=#16-建立新内核>1.6. 建立新内核</a></li><li><a href=#17-安装新内核>1.7. 安装新内核</a></li></ul></li><li><a href=#2-只建立内核模块kernel-modules>2. 只建立内核模块（kernel modules）</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose grow"><p>原文：</p><p>Building a custom kernel</p><p><a href=https://fedoraproject.org/wiki/Building_a_custom_kernel target=_blank rel=noreferrer>https://fedoraproject.org/wiki/Building_a_custom_kernel</a></p><p>Translated By Bob</p><p>2012-3-31</p><p>Email：
<a href=mailto:gexbob@gmail.com>gexbob@gmail.com</a></p><p>Blog：<a href=http://shaocheng.li target=_blank rel=noreferrer>http://shaocheng.li</a></p><hr><h2 id=1-从源码rpm包建立一个内核 class="relative group">1. 从源码RPM包建立一个内核 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-%e4%bb%8e%e6%ba%90%e7%a0%81rpm%e5%8c%85%e5%bb%ba%e7%ab%8b%e4%b8%80%e4%b8%aa%e5%86%85%e6%a0%b8 aria-label=锚点>#</a></span></h2><blockquote><p>注意：下面的说明只对 Fedora12 和之后版本有效</p></blockquote><p>这份文档为那些想要重新建立内核的高级用户提供说明。但是，重新建立的内核无法得到 Fedora 内核团队的支持。但是，您是高级用户，您可以自己处理，对吗？无论如何，高级用户建立定制内核的原因有如下几项：</p><ul><li>测试他们编写的或从其他地方得到的补丁。</li><li>重新配置已经存在的内核。</li><li>学习内核或内核开发。</li></ul><p>这些说明也可以用于简单的准备内核源码树。</p><p>开始之前，确认系统已经安装了必要的软件包：</p><ul><li>rpmdevtools</li><li>yum-utils</li></ul><p>yum-utils 是一个默认的包。用如下命令安装：</p><pre><code>su -c 'yum install rpmdevtools yum-utils'
</code></pre><p>如果您要用 make xconfig，安装如下软件是必要的：</p><ul><li>qt3-devle</li><li>libXi-devel</li><li>gcc-c++</li></ul><p>对于 Fedora 15，用如下命令：</p><pre><code>su -c 'yum install qt3-devel libXi-devel'
</code></pre><h3 id=11-获得源码 class="relative group">1.1. 获得源码 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#11-%e8%8e%b7%e5%be%97%e6%ba%90%e7%a0%81 aria-label=锚点>#</a></span></h3><blockquote><p>不要用 root 建立软件包,用 root 建立软件包是很危险且没有必要的，即使对于内核。下面的指令允许任何普通用户从源码包开始建立和安装内核.</p></blockquote><p>1.在您的用户主目录下准备一个建立RPM包的环境，运行如下命令：</p><pre><code>rpmdev-setuptree
</code></pre><p>这个命令新建了几个不同的目录 ${HOME}/rpmbuild/SOURCES， ${HOME}/rpmbuild/SPECS和${HOME}/rpmbuild/BUILD 。${HOME} 是您的用户主目录。</p><p>2.下载 kernel-&lt;version>.src.rpm 文件。用&ndash;enablerepo选项使能适当的源码库。（yumdownloader &ndash;enablerepo=repo_to_enable &ndash;source kernel)</p><pre><code>yumdownloader --source kernel
</code></pre><p>3.用 yum-builddep 命令为内核源码安装编译依赖。</p><pre><code>su -c 'yum-builddep kernel-&lt;version&gt;.src.rpm'
</code></pre><p>4.用如下命令安装 kernel-&lt;version>.src.rpm</p><pre><code>rpm -Uvh kernel-&lt;version&gt;.src.rpm
</code></pre><p>这个命令把RPM目录写入了 ${HOME}/repbuild/SOURCES和${HOME}/rpmbuild/SPECS ，${HOME} 是您的用户主目录。可以忽略像下面这样的信息：</p><pre><code>warning: user kojibuilder does not exist - using root
warning: group kojibuilder does not exist - using root
</code></pre><blockquote><p>空间需求:完全的内部编译过程需要若干 GB 的额外空间。</p></blockquote><h3 id=12-准备内核源码树 class="relative group">1.2. 准备内核源码树 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#12-%e5%87%86%e5%a4%87%e5%86%85%e6%a0%b8%e6%ba%90%e7%a0%81%e6%a0%91 aria-label=锚点>#</a></span></h3><p>这一步扩大为整个内核源码文件。这对于查看代码、编辑代码和生成补丁是必需的。</p><p>用如下命令准备内核源码树：</p><pre><code>cd ~/rpmbuild/SPECS
rpmbuild -bp --target=$(uname -m) kernel.spec
</code></pre><p>现在，内核源码树就位于 ~/rpmbuild/BUILD/kernel-&lt;version>/linux-&lt;version>.&lt;arch> 目录。</p><h3 id=13-复制源码树和生成一个补丁 class="relative group">1.3. 复制源码树和生成一个补丁 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#13-%e5%a4%8d%e5%88%b6%e6%ba%90%e7%a0%81%e6%a0%91%e5%92%8c%e7%94%9f%e6%88%90%e4%b8%80%e4%b8%aa%e8%a1%a5%e4%b8%81 aria-label=锚点>#</a></span></h3><p>这一步是为了对内核源码使用一个补丁。如果不需要这个补丁，直接跳到“配置内核选项”。</p><blockquote><p>高级用户：
有些工具，例如“quilt”，允许您避免复制源码树。对应高级用户，这样的工具可以使您在下面的步骤中节省很多时间。</p></blockquote><p>复制源码树是为了保留修改前的原始代码。</p><pre><code>export arch=x86_64 # replace x86_64 with your arch
export ver=3.1 # replace 3.1 with your kernel version
export fedver=fc16 # replace fc16 with your fedora version 
cp -r ~/rpmbuild/BUILD/kernel-$ver.$fedver/linux-$ver.$arch ~/rpmbuild/BUILD/kernel-$ver.$fedver.orig
cp -al ~/rpmbuild/BUILD/kernel-$ver.$fedver.orig ~/rpmbuild/BUILD/kernel-$ver.$fedver.new
</code></pre><blockquote><p>第二个 cp 命令在 .orig 和 .new 树之间建立了硬连接，这样可以使 diff 运行的更快。大部分文本编辑者都知道怎样正确的破坏硬连接来避免问题。</p></blockquote><p>在 FC14 上使用 vim 时，它会把上面的硬连接当做硬连接来处理，从而导致上面的技术失败。有必要将原始代码完全复制到 .new 目录。但是这样将使用双倍的空间。</p><p>直接更改 .new 源码树中的代码，或者复制到一个副本文件。这个文件可以来自于一个要求测试的开发者，上游内核源码，或者另一个发行版本。</p><p>修改 .new 源码树之后，生成一个补丁。要生成一个补丁，用下面命令对整个 .new 和 .orig 源码树运行 diff 。</p><pre><code>cd ~/rpmbuild/BUILD
diff -uNrp kernel-$ver.$fedver.orig kernel-$ver.$fedver.new &gt; ../SOURCES/linux-$ver.$fedver-mynewpatch.patch
</code></pre><p>用新补丁的名字替换 &rsquo;linux-$ver.$fedver-mynewpatch.patch&rsquo; 。在 FC14 上必须把前面的补丁名字复制到 ~/rpmbuild/SOURCES 中的 linux-$ver.$fedver-mynewpatch.patch ，以便 rpmbuild 找到它。</p><blockquote><p>更多关于补丁的信息请看 diff(1) 和 patch(1) 的 man 手册</p></blockquote><h3 id=14-配置内核选项 class="relative group">1.4. 配置内核选项 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#14-%e9%85%8d%e7%bd%ae%e5%86%85%e6%a0%b8%e9%80%89%e9%a1%b9 aria-label=锚点>#</a></span></h3><p>这一步是为了修改内核的选项。这一步是可选的。如果没有需要修改的配置，可以跳到“准备建立文件”。</p><blockquote><p>小变化:
如果您只是想要做一点小的修改，可以在config-local文件中根据需要直接设置选项。这样会找到并覆盖其余的config-*文件，避免很多不必要的工作。如果您使用config-local就可以跳过下面的步骤。*</p></blockquote><p>1.改变内核源码树目录：</p><pre><code>cd ~/rpmbuild/BUILD/kernel-$ver.$fedver/linux-$ver.$arch/
</code></pre><p>如果您只是对默认的 fedora 内核做小的修改，跳到第四步，从两个配置工作中选择一个，将这些修改编辑到默认的配置文件。</p><p>2.从 ~/rpmbuild/BUILD/kernel-$ver.$fedver/linux-$ver.$arch/configs 选择所需的配置文件。复制所需的 config 文件到 ~/rpmbuild/BUILD/kernel-$ver.$fedver/linux-$ver.$arch/.config:</p><pre><code>cp configs/&lt;desired-config-file&gt; .config
</code></pre><p>3.运行下面命令：</p><pre><code>make oldconfig
</code></pre><p>4.运行下面命令，在文本界面上选择并保持所需的内核选项</p><pre><code>make menuconfig
</code></pre><p>运行图形界面的话用这个命令：</p><pre><code>make xconfig
</code></pre><p>5.在顶层 config 文件中添加一行，该文件包含了内核支持的硬件架构（uname -i的输出）。这一行以 # 开头。例如，x86_64 设备应该在顶层 config 文件中添加下面这行：</p><pre><code># x86_64
</code></pre><p>6.复制 config 文件到 ~/rpmbuild/SOURCES/:</p><pre><code>cp .config ~/rpmbuild/SOURCES/config-`uname -m`-generic
</code></pre><p><em>32-bit x86 内核</em></p><p><em>32-bit PAE 内核使用 config-i686-PAE 配置文件。如果您正在建立一个 PAE 内核，需要复制您的 config 文件到 ~/rpmbuild/SOURCES/:</em></p><pre><code>cp .config ~/rpmbuild/SOURCES/config-i686-PAE
</code></pre><p><em>如果您正在建立一个非 PAE 内核，需要复制您的 config 文件到：</em></p><pre><code>cp .config ~/rpmbuild/SOURCES/config-x86-32-generic
</code></pre><p><em>再次鼓励使用 config-local，除非您正在修改大量的配置。</em></p><h3 id=15-准备建立文件 class="relative group">1.5. 准备建立文件 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#15-%e5%87%86%e5%a4%87%e5%bb%ba%e7%ab%8b%e6%96%87%e4%bb%b6 aria-label=锚点>#</a></span></h3><p>这一步将对 kernel.spec 文件做必要的修改。只是建立定制内核所需的。</p><p>1.进入~/rpmbuild/SPECS目录：</p><pre><code>cd ~/rpmbuild/SPECS
</code></pre><p>2.用编辑器打开kernel.spec文件。</p><p>3.为内核起一个唯一的名字。这对于确保定制内核不与其他内核混淆是很重要的。通过修改 ‘buildid’ 一行，为内核名字添加一个唯一的字符串。可以把 “.local” 改为您的名字缩写，一个 bug 号，日期，或其它任何唯一的字符串。</p><p>修改这一行：</p><pre><code>#% define buildid .local
</code></pre><p>改为（注意，# 号和额外的空格都被删除了）：</p><pre><code>%define buildid .&lt;custom_text&gt;
</code></pre><p>4.如果您生成了一个补丁，最后把它添加到 kernel.spec 文件中所有已存在的补丁的后面，并且添加详细的注释。</p><pre><code># cputime accounting is broken, revert to 2.6.22 version
Patch2220: linux-2.6-cputime-fix-accounting.patch
Patch9999: linux-2.6-samfw-test.patch
</code></pre><p>然后，需要将补丁应用到spec文件的application段，放在所有已存在的补丁应用的后面，并添加详细的注释。</p><pre><code>ApplyPatch linux-2.6-cputime-fix-accounting.patch
ApplyPatch linux-2.6-samfw-test.patch
</code></pre><h3 id=16-建立新内核 class="relative group">1.6. 建立新内核 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#16-%e5%bb%ba%e7%ab%8b%e6%96%b0%e5%86%85%e6%a0%b8 aria-label=锚点>#</a></span></h3><p>这一步实际是要生成一个内核 RPM 文件。只是建立定制内核所需的。对于 Fedora10 或 11 ，大多数场合下，这是建立内核（包括固件）的最简单的方法（看最后一部分）。</p><p>用 rpmbuild 工具建立新内核：</p><p>1.建立所有内核配置：</p><pre><code>rpmbuild -bb --target='uname -m' kernel.spec
</code></pre><p>2.关闭指定的内核配置（为了更快的建立）：</p><pre><code>rpmbuild -bb --without &lt;option&gt; --target='uname -m' kernel.spec
</code></pre><p>其中 “option” 的有效值包括 xen、smp、up、pae、kdump、debug 和 debuginfo 。指定 &ndash;without debug 会剔除内核中的调试代码，指定 &ndash;without debuginfo 会禁止建立 kernel-debuginfo 包。</p><p>3.只建立一个特定的内核：</p><pre><code>rpmbuild -bb --with &lt;option&gt; --target='uname -m' kernel-spec
</code></pre><p>“option” 的有效值包括 xenonly、smponly 和 beseonly。</p><p>4.例如，只建立 kernel 和 kernel-devel 包的命令是：</p><pre><code>rpmbuild -bb --with baseonly --without debuginfo --target='uname -m' kernel.spec
</code></pre><p>5.建立时包含固件，用如下命令：</p><pre><code>rpmbuild -bb --with baseonly --with firmware --without debuginfo --target=`uname -m` kernel.spec
</code></pre><p>建立的过程需要很长时间。会在屏幕上打印大量的信息。这些信息可以被忽略，除非建立过程因为一个error而停止。如果成功完成建立过程，一个新的内核包会出现在~/rpmbuild/RPMS目录。</p><p><em>应该添加一个故障排除的部分。</em></p><p>####1.6.1. 以下是通用教程</p><p>大部分关于 Linux 内核开发的教程，例子和教科书都假设内核源码被安装在/usr/src/linux目录下。如果您想下面这样做一个符号链接，您就可以使用那些Fedora包的学习材料了。安装合适的内核源码，然后运行下面命令：</p><pre><code>su -c 'ln -s /usr/src/kernels/&lt;version&gt;.&lt;release&gt;-&lt;arch&gt; /usr/src/linux'
</code></pre><p>根据提示输入 root 密码。</p><h3 id=17-安装新内核 class="relative group">1.7. 安装新内核 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#17-%e5%ae%89%e8%a3%85%e6%96%b0%e5%86%85%e6%a0%b8 aria-label=锚点>#</a></span></h3><p>这一步将把新内核安装到运行中的系统。</p><p>要安装新内核，用 rpm -ivh 命令，不要带 -U 或 &ndash;upgrade 选项：</p><pre><code>su -c &quot;rpm -ivh --force $HOME/rpmbuild/RPMS/&lt;arch&gt;/kernel-&lt;version&gt;.&lt;arch&gt;.rpm&quot;
</code></pre><p>如果您根据需要修改了内核的名字，您的固件和内核头文件将无法匹配。最简单的解决方法是用前面描述的方法建立新的固件，然后：</p><pre><code>su -c &quot;rpm -ivh $HOME/rpmbuild/RPMS/&lt;arch&gt;/kernel-&lt;version&gt;.&lt;arch&gt;.rpm \
$HOME/rpmbuild/RPMS/&lt;arch&gt;/kernel-firmware-&lt;version&gt;.&lt;arch&gt;.rpm \
$HOME/rpmbuild/RPMS/&lt;arch&gt;/kernel-headers-&lt;version&gt;.&lt;arch&gt;.rpm \
$HOME/rpmbuild/RPMS/&lt;arch&gt;/kernel-devel-&lt;version&gt;.&lt;arch&gt;.rpm&quot;
</code></pre><p>这些命令会把您的内核安装到 /boot目录，创建一个新的 initramfs，并且自动把新内核添加到 grub 的 “menu.list” 中。然后，您就可以重启并使用您的新内核了。</p><h2 id=2-只建立内核模块kernel-modules class="relative group">2. 只建立内核模块（kernel modules） <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-%e5%8f%aa%e5%bb%ba%e7%ab%8b%e5%86%85%e6%a0%b8%e6%a8%a1%e5%9d%97kernel-modules aria-label=锚点>#</a></span></h2><p><em>本段需要更新和充实</em></p><p>这一段针对那些只想在内核模块上工作的用户，他们并不想建立一个完整的内核。只要就没必要下载和重新建立整个内核。要为当前运行的内核建立一个模块，只需要相匹配的 kernel-devel 包。运行下面命令安装 kernel-devel 包：</p><pre><code>su -c 'yum install kernel-devel'
</code></pre><p>如果您用的是 PAE 内核，可能要安装 “kernel-PAE-devel” 。</p><p>只要您安装了相应版本的 kernel 或 kernel-devel 包，就可以建立任何内核版本。本段的其余部分假设您正在使用当前运行的内核。如果不是，用指定的版本号代替 ‘uname -r’。</p><p>kernel-doc 包包含了官方的 Kbuild 文档。在 Documentation/kbuild 目录下查看，尤其是 modules.txt 文件。</p><p>一个简单的例子，从 foo.c 建立 foo.ko 模块，在 foo.c 所在的目录下创建下面这样的 Makefile：</p><pre><code>obj-m := foo.o
KDIR  := /lib/modules/$(shell uname -r)/build
PWD   := $(shell pwd)
default:
[TAB]$(MAKE) -C $(KDIR) M=$(PWD) modules
</code></pre><p>[TAB] 表示 makefile 中包含命令的一行必须以一个 tab 字符开头。</p><p>然后，执行 make 命令建立 foo.ko 模块。</p><p>上面是是通过一个本地 Makefile 包装调用 kbuild。通常您可以简单一点，想下面这样来建立那些目标。</p><pre><code># make -C /lib/modules/`uname -r`/build M=`pwd` modules
# make -C /lib/modules/`uname -r`/build M=`pwd` clean
# make -C /lib/modules/`uname -r`/build M=`pwd` modules_install
</code></pre></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mb-0 !mt-0 me-4 h-24 w-24 rounded-full" width=96 height=96 alt=Shaocheng.Li src=/img/author_hucdd16a8e5aab658b1bf3664f1886d7a1_71871_192x192_fill_box_center_3.png loading=lazy><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Shaocheng.Li</div><div class="text-sm text-neutral-700 dark:text-neutral-400">A Linux software engineer.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/exbob target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/2012/03/23/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">在 Linux 系统中部署 goagent</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2012-03-23 08:00:00 +0800 +0800">2012 March 23</time>
</span></span></a></span><span><a class="group flex text-right" href=/posts/2012/04/28/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">在大项目中使用 Cscope</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2012-04-28 08:00:00 +0800 +0800">2012 April 28</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=https://giscus.app/client.js data-repo=exbob/exbob.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkyMzM5ODIwNTg=" data-category=Announcements data-category-id=DIC_kwDODfJIas4Cc6dQ data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light_protanopia data-lang=zh-CN crossorigin=anonymous async></script></div></div></footer></article><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=回到顶部 title=回到顶部>&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024
Shaocheng.Li</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a> 强力驱动</p></div><div class="flex flex-row items-center"><div class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"><button id=appearance-switcher-0 type=button aria-label="appearance switcher"><div class="flex items-center justify-center w-12 h-12 dark:hidden" title=切换为深色模式><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden w-12 h-12 dark:flex" title=切换为浅色模式><span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://shaocheng.li/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative inline-block align-text-bottom px-1 icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="relative inline-block align-text-bottom px-1 icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>