<!doctype html><html lang=zh-Hans dir=Chinese-Simplified class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#FFFFFF"><title>MIPI DSI学习笔记 &#183; Shaocheng.Li</title>
<meta name=title content="MIPI DSI学习笔记 &#183; Shaocheng.Li"><script type=text/javascript src=/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.900ab2ce3e7db5eba67d1f7dae7f22410bddd4cd42fd9cd8ee95ecca31e5564e.css integrity="sha256-kAqyzj59teumfR99rn8iQQvd1M1C/ZzY7pXsyjHlVk4="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.af5d9722112bedac95702865c340bcd6286c4e9b2c15ce26b531ea1fba974cb8.js integrity="sha256-r12XIhEr7ayVcChlw0C81ihsTpssFc4mtTHqH7qXTLg=" data-copy=复制 data-copied=已复制></script><meta name=description content="
      
        
      
    "><link rel=canonical href=https://shaocheng.li/posts/2025/09/07/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://shaocheng.li/posts/2025/09/07/"><meta property="og:site_name" content="Shaocheng.Li"><meta property="og:title" content="MIPI DSI学习笔记"><meta property="og:description" content="LiShaocheng's Blog"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-07T19:40:17+08:00"><meta property="article:modified_time" content="2025-09-07T19:40:17+08:00"><meta property="article:tag" content="Untagged"><meta name=twitter:card content="summary"><meta name=twitter:title content="MIPI DSI学习笔记"><meta name=twitter:description content="LiShaocheng's Blog"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"文章","name":"MIPI DSI学习笔记","headline":"MIPI DSI学习笔记","inLanguage":"zh-Hans","url":"https:\/\/shaocheng.li\/posts\/2025\/09\/07\/","author":{"@type":"Person","name":"Shaocheng.Li"},"copyrightYear":"2025","dateCreated":"2025-09-07T19:40:17\u002b08:00","datePublished":"2025-09-07T19:40:17\u002b08:00","dateModified":"2025-09-07T19:40:17\u002b08:00","keywords":["untagged"],"mainEntityOfPage":"true","wordCount":"2486"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://shaocheng.li/","name":"Shaocheng. Li","position":1},{"@type":"ListItem","item":"https://shaocheng.li/posts/","name":"文章","position":2},{"@type":"ListItem","name":"Mipi Dsi学习笔记","position":3}]}</script><meta name=author content="Shaocheng.Li"><link href=https://github.com/exbob rel=me></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>跳到主要内容</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Shaocheng.Li</a></div><ul class="flex list-none flex-col text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/posts/ title=文章><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">文章</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/projects/ title=做过的项目><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">项目</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/movies/ title=看过的电影><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">观影</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/exercise/ title=运动记录><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">运动</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/share/ title=好物分享><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">好物</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=search-button-1 title="搜索 (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=appearance-switcher-1 type=button aria-label="appearance switcher">
<span class="group-dark:hover:text-primary-400 inline transition-colors group-hover:text-primary-600 dark:hidden" title=切换为深色模式><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span>
</span><span class="group-dark:hover:text-primary-400 hidden transition-colors group-hover:text-primary-600 dark:inline" title=切换为浅色模式><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></span></button></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">MIPI DSI学习笔记</h1><div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2025-09-07 19:40:17 +0800 +0800">2025 九月 7</time><span class="px-2 text-primary-500">&#183;</span><span>2486 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>12 分钟</span></div></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 lg:sticky lg:top-10 print:hidden"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#mipi-dsi-的基本概念>MIPI DSI 的基本概念</a><ul><li><a href=#d-phy>D-PHY</a></li><li><a href=#时钟和传输速率>时钟和传输速率</a></li></ul></li><li><a href=#显示器工作原理基础>显示器工作原理基础</a><ul><li><a href=#水平扫描过程>水平扫描过程</a></li><li><a href=#垂直扫描过程>垂直扫描过程</a></li><li><a href=#完整显示过程>完整显示过程</a></li></ul></li><li><a href=#mipi-dsi的显示时序>MIPI DSI的显示时序</a></li><li><a href=#mipi-dsi的初始化命令>MIPI DSI的初始化命令</a></li><li><a href=#mipi-dsi-显示屏实例>MIPI DSI 显示屏实例</a><ul><li><a href=#接口>接口</a></li><li><a href=#垂直扫描时序>垂直扫描时序</a></li><li><a href=#水平扫描时序>水平扫描时序</a></li><li><a href=#像素时钟和接口速率>像素时钟和接口速率</a></li><li><a href=#初始化命令>初始化命令</a></li></ul></li><li><a href=#实例调试>实例调试</a><ul><li><a href=#源码分析>源码分析</a><ul><li><a href=#start_vo>start_vo</a></li><li><a href=#do_start_mipi_tx>do_start_mipi_tx</a></li><li><a href=#总结>总结</a></li></ul></li><li><a href=#调试过程>调试过程</a><ul><li><a href=#引脚复用>引脚复用</a></li><li><a href=#屏幕使能和复位>屏幕使能和复位</a></li><li><a href=#背光>背光</a></li><li><a href=#vo的输出时序>VO的输出时序</a></li><li><a href=#vo的输出时钟>VO的输出时钟</a></li><li><a href=#mipi-tx的时序参数>MIPI Tx的时序参数</a></li><li><a href=#初始化命令序列>初始化命令序列</a></li><li><a href=#启动vo输出>启动VO输出</a></li><li><a href=#添加启动画面>添加启动画面</a></li></ul></li></ul></li></ul></nav></div></details></div></div><div class="min-h-0 min-w-0 max-w-prose grow"><h2 id=mipi-dsi-的基本概念 class="relative group">MIPI DSI 的基本概念 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#mipi-dsi-%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5 aria-label=锚点>#</a></span></h2><p>MIPI联盟是一个由移动设备制造商和电子元件供应商组成的联盟，在2003年由ARM，Nokia和TI等厂商牵头成立，旨在为智能手机和类似多媒体设备中的各种子系统指定一组通用接口。他们发布了一系列标准，涵盖音频、摄像头、显示器、触摸屏和其他设备的接口，如其信息图所示：</p><p><figure><img src=./pics/image_zoNdkHQvzo.png alt class="mx-auto my-0 rounded-md"></figure></p><p>目前最成熟的两个接口标准协议：</p><ul><li>MIPI-CSI，全称MIPI Camera Serial Interface，用于连接处理器和摄像头。数据流<code>传感器 → 应用层 → CSI-2协议层 → 通道层 → D-PHY → 处理器</code></li><li>MIPI-DSI，全称MIPI Display Serial Interface，用于连接处理器和液晶显示屏。数据流<code>处理器 → 应用层 → DSI协议层 → 通道层 → D-PHY → 显示面板</code></li></ul><p>协议分四层：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>┌─────────────────────────┐
</span></span><span class=line><span class=cl>│    应用层 (Application) │  ← 图像数据/显示数据
</span></span><span class=line><span class=cl>├─────────────────────────┤
</span></span><span class=line><span class=cl>│    协议层 (Protocol)    │  ← CSI-2/DSI 协议
</span></span><span class=line><span class=cl>├─────────────────────────┤
</span></span><span class=line><span class=cl>│    通道层 (Lane)        │  ← 数据打包和分发
</span></span><span class=line><span class=cl>├─────────────────────────┤
</span></span><span class=line><span class=cl>│    物理层 (Physical)    │  ← D-PHY/C-PHY
</span></span><span class=line><span class=cl>└─────────────────────────┘
</span></span></code></pre></div><p>物理层的两种协议区别：</p><table><thead><tr><th>特性</th><th>D-PHY</th><th>C-PHY</th></tr></thead><tbody><tr><td>信号类型</td><td>差分信号对</td><td>三线制信号</td></tr><tr><td>数据通道</td><td>每个通道需要2根线（差分对）</td><td>每个通道需要3根线</td></tr><tr><td>速率</td><td>最高 4.5 Gbps/Lane（v2.1）</td><td>最高 9Gbps/trio（v2.0）</td></tr><tr><td>功耗</td><td>相对较高</td><td>更低功耗</td></tr><tr><td>成本</td><td>较低，技术成熟</td><td>较高，新技术</td></tr></tbody></table><p>下图是一个典型应用，分别使用了四通道的D-PHY传输数据，用I2C进行控制：</p><p><figure><img src=./pics/image_8lofILZmvH.png alt class="mx-auto my-0 rounded-md"></figure></p><p>除了以上MIPI标准要求的信号，通常还会有电源信号，复位信号和背光信号等。</p><h3 id=d-phy class="relative group">D-PHY <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#d-phy aria-label=锚点>#</a></span></h3><p>MIPI协议的物理层是D-PHY，基本概念：</p><ul><li><strong>线路(Line)</strong>：主机处理器和外设之间单个引脚的互连或走线</li><li><strong>通道(Lane)</strong>：两条线路组成差分信号对，用于高速数据和时钟传输</li><li><strong>链路(Link)</strong>：包含一个时钟通道和至少一个数据通道的设备间连接</li></ul><p>一个D-PHY接口链路的特性：</p><ul><li><strong>信号类型</strong>：低压差分信号</li><li><strong>电压范围</strong>：1.2V ± 10%</li><li><strong>数据通道</strong>：1-4个差分数据对 (Data Lane)</li><li><strong>时钟通道</strong>：1个差分时钟对 (Clock Lane)</li><li><strong>每个通道</strong>：2根信号线（Line）组成差分对，一个叫做P，一个叫做N</li></ul><p>常见的2-Lane MIPI D-PHY 接口连接方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>发送端                    接收端
</span></span><span class=line><span class=cl>┌─────────┐              ┌─────────┐
</span></span><span class=line><span class=cl>│ Data0+  │──────────────│ Data0+  │
</span></span><span class=line><span class=cl>│ Data0-  │──────────────│ Data0-  │
</span></span><span class=line><span class=cl>│ Data1+  │──────────────│ Data1+  │
</span></span><span class=line><span class=cl>│ Data1-  │──────────────│ Data1-  │
</span></span><span class=line><span class=cl>│ CLK+    │──────────────│ CLK+    │
</span></span><span class=line><span class=cl>│ CLK-    │──────────────│ CLK-    │
</span></span><span class=line><span class=cl>└─────────┘              └─────────┘
</span></span></code></pre></div><h3 id=时钟和传输速率 class="relative group">时钟和传输速率 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%97%b6%e9%92%9f%e5%92%8c%e4%bc%a0%e8%be%93%e9%80%9f%e7%8e%87 aria-label=锚点>#</a></span></h3><p>数据在 Data Lane 上采用DDR方式传输，在CLK Lane的上升沿和下降沿采样：</p><ul><li>1个CLK周期传输2个数据位</li><li>CLK上升沿传输第1个bit</li><li>CLK下降沿传输第2个bit</li></ul><p>所以，一对Lane的时钟频率 = 数据速率 ÷ 2 （数据速率 = CLK频率 × 2），如果数据速率要达到 800Mbps，时钟频率至少 400MHz 。而 MIPI-DSI的传输速率（也就是总带宽）由Lane的传输能力和Lane的数量决定：</p><p><figure><img src=./pics/image_YHEmfiLIzA.png alt class="mx-auto my-0 rounded-md"></figure></p><h2 id=显示器工作原理基础 class="relative group">显示器工作原理基础 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%98%be%e7%a4%ba%e5%99%a8%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86%e5%9f%ba%e7%a1%80 aria-label=锚点>#</a></span></h2><p>显示器采用<strong>逐行扫描</strong>的方式显示图像，类似于老式CRT电视机的电子束扫描：</p><ol><li>从屏幕左上角开始</li><li>逐像素从左到右扫描（水平扫描）</li><li>扫描完一行后，跳到下一行的左边重新开始（垂直扫描）</li><li>重复直到扫描完整个屏幕的每一行</li><li>回到左上角，开始下一帧</li></ol><p>下面是一个典型的 1600x1200 60Hz的显示器的工作时序。</p><h3 id=水平扫描过程 class="relative group">水平扫描过程 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%b0%b4%e5%b9%b3%e6%89%ab%e6%8f%8f%e8%bf%87%e7%a8%8b aria-label=锚点>#</a></span></h3><p>每一行需要扫描1600个像素：</p><p><figure><img src=./pics/image_IvmFIc3bIl.png alt class="mx-auto my-0 rounded-md"></figure></p><p>水平时序各阶段详解：</p><ol><li>HSA (Horizontal Sync Active) - 水平同步脉冲<ul><li>作用：告诉屏幕"新的一行开始了"</li><li>时长：10个像素时钟周期</li><li>信号：HSYNC拉低（或拉高，取决于极性）</li><li>此时：不传输像素数据</li></ul></li><li>HBP (Horizontal Back Porch) - 水平后消隐<ul><li>作用：给屏幕时间准备接收像素数据</li><li>时长：20个像素时钟周期</li><li>信号：HSYNC恢复正常电平</li><li>此时：不传输像素数据，但时钟继续运行</li></ul></li><li>HACT (Horizontal Active) - 水平有效数据<ul><li>作用：传输这一行的所有像素数据</li><li>时长：1600个像素时钟周期</li><li>信号：DE（数据有效）信号拉高</li><li>此时：连续传输1600个像素的RGB数据</li></ul></li><li>HFP (Horizontal Front Porch) - 水平前消隐<ul><li>作用：给屏幕时间处理这一行数据，准备下一行</li><li>时长：30个像素时钟周期</li><li>信号：DE信号拉低</li><li>此时：不传输像素数据</li></ul></li></ol><h3 id=垂直扫描过程 class="relative group">垂直扫描过程 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%9e%82%e7%9b%b4%e6%89%ab%e6%8f%8f%e8%bf%87%e7%a8%8b aria-label=锚点>#</a></span></h3><p>连续做1200次水平扫描可以完成一帧画面：</p><p><figure><img src=./pics/image_k0FTj0zsBu.png alt class="mx-auto my-0 rounded-md"></figure></p><p>垂直时序各阶段详解：</p><ol><li>VSA (Vertical Sync Active) - 垂直同步脉冲<ol><li>作用：告诉屏幕"新的一帧开始了"</li><li>时长：4行时间</li><li>信号：VSYNC拉低（或拉高）</li><li>此时：不显示任何图像数据</li></ol></li><li>VBP (Vertical Back Porch) - 垂直后消隐<ul><li>作用：给屏幕时间准备显示新一帧图像</li><li>时长：8行时间</li><li>信号：VSYNC恢复正常电平</li><li>此时：扫描8行，但不显示有效图像</li></ul></li><li>VACT (Vertical Active) - 垂直有效数据<ul><li>作用：显示整帧图像的所有行</li><li>时长：1200行时间</li><li>信号：每行都按水平时序传输像素数据</li><li>此时：连续扫描1200行，每行1600个像素</li></ul></li><li>VFP (Vertical Front Porch) - 垂直前消隐<ul><li>作用：给屏幕时间处理这一帧，准备下一帧</li><li>时长：12行时间</li><li>信号：继续行扫描但不显示数据</li><li>此时：扫描12行空白，然后开始下一帧</li></ul></li></ol><h3 id=完整显示过程 class="relative group">完整显示过程 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ae%8c%e6%95%b4%e6%98%be%e7%a4%ba%e8%bf%87%e7%a8%8b aria-label=锚点>#</a></span></h3><p>数据传输过程：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>第1帧开始：
</span></span><span class=line><span class=cl>├─ VSA(4行) → 发送垂直同步信号
</span></span><span class=line><span class=cl>├─ VBP(8行) → 8行空白扫描
</span></span><span class=line><span class=cl>├─ VACT开始：
</span></span><span class=line><span class=cl>│   ├─ 第1行：HSA→HBP→传输1600像素RGB数据→HFP
</span></span><span class=line><span class=cl>│   ├─ 第2行：HSA→HBP→传输1600像素RGB数据→HFP  
</span></span><span class=line><span class=cl>│   ├─ ...
</span></span><span class=line><span class=cl>│   └─ 第1200行：HSA→HBP→传输1600像素RGB数据→HFP
</span></span><span class=line><span class=cl>├─ VFP(12行) → 12行空白扫描
</span></span><span class=line><span class=cl>└─ 第2帧开始...
</span></span></code></pre></div><p>一幅画面就是一帧，每秒能够完成的帧数叫做帧率，或者叫刷新率。60Hz帧率下的时间计算：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>一行时间 = 1660个像素时钟 ÷ 122.4MHz = 13.56μs
</span></span><span class=line><span class=cl>一帧时间 = 1224行 × 13.56μs = 16.6ms
</span></span><span class=line><span class=cl>帧率 = 1000ms ÷ 16.6ms = 60.24Hz ≈ 60Hz
</span></span></code></pre></div><p>有效像素区域VACT和HACT的前后都有消隐区，目的是给软硬件保留信号处理时间，也是与传统显示标准的兼容。完整的像素显示区域示意图：</p><p><figure><img src=./pics/image_UpFThv1TKd.png alt class="mx-auto my-0 rounded-md"></figure></p><p>消隐区会影响显示器的有效显示时间占比：</p><ol><li>水平有效比例 = 1600 / 1660 = 96.4%</li><li>垂直有效比例 = 1200 / 1224 = 98.0%</li><li>总有效比例 = 96.4% × 98.0% = 94.5%</li></ol><p>这意味着：</p><ul><li>94.5%的时间在传输有效图像数据</li><li>5.5%的时间在消隐区（不传输图像数据）</li></ul><h2 id=mipi-dsi的显示时序 class="relative group">MIPI DSI的显示时序 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#mipi-dsi%e7%9a%84%e6%98%be%e7%a4%ba%e6%97%b6%e5%ba%8f aria-label=锚点>#</a></span></h2><p>上面时序中有 SYNC和 DATA等信号，但是MIPI DSI协议中并没有独立的DATA，HSYNC和VSYNC硬件信号线。这些信息都是通过D-PHY的Lane进行传输的。</p><p>HSYNC和VSYNC信息是通过<strong>数据包</strong>的形式在DATA通道中传输的：</p><p><figure><img src=./pics/image_oCJSYymNNc.png alt class="mx-auto my-0 rounded-md"></figure></p><p>Video Mode下的数据流：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>// 一帧数据的传输序列
</span></span><span class=line><span class=cl>Frame开始:
</span></span><span class=line><span class=cl>├─ 发送VSA数据包 (4次，对应4行VSA)
</span></span><span class=line><span class=cl>├─ 发送VBP数据包 (8次，对应8行VBP)  
</span></span><span class=line><span class=cl>├─ 发送1200行有效数据:
</span></span><span class=line><span class=cl>│   ├─ 第1行: HSA包 → HBP包 → 像素数据包(1600像素) → HFP包
</span></span><span class=line><span class=cl>│   ├─ 第2行: HSA包 → HBP包 → 像素数据包(1600像素) → HFP包
</span></span><span class=line><span class=cl>│   ├─ ...
</span></span><span class=line><span class=cl>│   └─ 第1200行: HSA包 → HBP包 → 像素数据包(1600像素) → HFP包
</span></span><span class=line><span class=cl>├─ 发送VFP数据包 (12次，对应12行VFP)
</span></span><span class=line><span class=cl>└─ 下一帧开始...
</span></span></code></pre></div><p>数据包的4Lane并行传输</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>// 以HSA数据包为例 (假设包含4字节数据)
</span></span><span class=line><span class=cl>数据包内容: [Header(4字节)] [Data(N字节)] [CRC(2字节)]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>4Lane并行传输:
</span></span><span class=line><span class=cl>时钟周期1: Lane0=Header[0], Lane1=Header[1], Lane2=Header[2], Lane3=Header[3]
</span></span><span class=line><span class=cl>时钟周期2: Lane0=Data[0],   Lane1=Data[1],   Lane2=Data[2],   Lane3=Data[3]
</span></span><span class=line><span class=cl>时钟周期3: Lane0=CRC[0],    Lane1=CRC[1],    Lane2=空,        Lane3=空
</span></span></code></pre></div><p>屏幕端的收到信号后进行重建：</p><p><figure><img src=./pics/image__TAb0_rwpv.png alt class="mx-auto my-0 rounded-md"></figure></p><p>这些转换和传输过程由底层驱动和硬件完成，Linux显示子系统抽象后的屏幕模型还是标准时序，无论什么显示接口，行列扫描和时钟频率这些基本参数都是一样的。</p><h2 id=mipi-dsi的初始化命令 class="relative group">MIPI DSI的初始化命令 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#mipi-dsi%e7%9a%84%e5%88%9d%e5%a7%8b%e5%8c%96%e5%91%bd%e4%bb%a4 aria-label=锚点>#</a></span></h2><p>与其他显示接口主要用硬件时序初始化不同，MIPI DSI需要执行一组软件初始化命令。不同接口的初始化方式对比：</p><p><figure><img src=./pics/image_fC1ucoWHsM.png alt class="mx-auto my-0 rounded-md"></figure></p><p>MIPI DSI为应对更智能更复杂的情况，实现更多功能，需要软件初始化：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>1. 复杂的电源管理：
</span></span><span class=line><span class=cl>   ├─ 多个电源域需要协调
</span></span><span class=line><span class=cl>   ├─ 支持多种省电模式
</span></span><span class=line><span class=cl>   ├─ 动态功耗控制
</span></span><span class=line><span class=cl>   └─ 温度补偿功能
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2. 可编程的显示参数：
</span></span><span class=line><span class=cl>   ├─ 像素格式可选择 (RGB565/RGB666/RGB888)
</span></span><span class=line><span class=cl>   ├─ 扫描方向可配置
</span></span><span class=line><span class=cl>   ├─ 亮度可调节
</span></span><span class=line><span class=cl>   ├─ 伽马校正可设置
</span></span><span class=line><span class=cl>   └─ 色彩增强可开启
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>3. 协议层复杂性：
</span></span><span class=line><span class=cl>   ├─ LP/HS模式切换
</span></span><span class=line><span class=cl>   ├─ 虚拟通道管理
</span></span><span class=line><span class=cl>   ├─ 错误检测和恢复
</span></span><span class=line><span class=cl>   └─ 流控制机制
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>4. 兼容性考虑：
</span></span><span class=line><span class=cl>   ├─ 支持不同的主控芯片
</span></span><span class=line><span class=cl>   ├─ 适应不同的应用场景
</span></span><span class=line><span class=cl>   ├─ 向后兼容性
</span></span><span class=line><span class=cl>   └─ 标准化命令接口
</span></span></code></pre></div><p>典型的MIPI DSI 屏幕控制器的状态机：</p><p><figure><img src=./pics/image_Tl3dt_5-I5.png alt class="mx-auto my-0 rounded-md"></figure></p><p>这些初始化命令由屏厂给出，通常是由MIPI DSI接口发送，也可以由 I2C或者SPI等接口发送给屏的控制器。</p><h2 id=mipi-dsi-显示屏实例 class="relative group">MIPI DSI 显示屏实例 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#mipi-dsi-%e6%98%be%e7%a4%ba%e5%b1%8f%e5%ae%9e%e4%be%8b aria-label=锚点>#</a></span></h2><p>下面是一个MIPI显示屏SY050WGM01的基本参数：</p><p><figure><img src=./pics/image_0SnNYLIULO.png alt class="mx-auto my-0 rounded-md"></figure></p><ul><li>分辨率: 1600(H) × 1200(V)</li><li>像素尺寸: 6.3μm × 6.3μm</li><li>显示区域: 10.08mm × 7.56mm (0.5英寸对角线)</li><li>帧率范围: 60Hz ~ 120Hz（每秒刷新的帧数）</li><li>接口: MIPI DSI (1port D-PHY)</li><li>颜色深度: 24-bit RGB (8:8:8)</li></ul><h3 id=接口 class="relative group">接口 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%8e%a5%e5%8f%a3 aria-label=锚点>#</a></span></h3><p>这个屏支持I2C和MIPI DSI 两种接口：</p><p><figure><img src=./pics/image_XLV_FyKUYy.png alt class="mx-auto my-0 rounded-md"></figure></p><p><figure><img src=./pics/image_Erxpb4v6lM.png alt class="mx-auto my-0 rounded-md"></figure></p><p>其中，I2C的7位设备地址是0x4C或者0x4D，最后一位右pin16引脚的电平决定（本例中是接地，所以设备地址是 0x4C）：</p><p><figure><img src=./pics/image_8WhrvdgAoM.png alt class="mx-auto my-0 rounded-md"></figure></p><p>MIPI DSI的数据通道是4Lane差分信号：</p><ul><li>CLK差分对: CKP/CKN (Pin 45/46)</li><li>DATA0差分对: DP&lt;0>/DN&lt;0> (Pin 48/49)</li><li>DATA1差分对: DP&lt;1>/DN&lt;1> (Pin 42/43)</li><li>DATA2差分对: DP&lt;2>/DN&lt;2> (Pin 51/52)</li><li>DATA3差分对: DP&lt;3>/DN&lt;3> (Pin 39/40)</li></ul><h3 id=垂直扫描时序 class="relative group">垂直扫描时序 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%9e%82%e7%9b%b4%e6%89%ab%e6%8f%8f%e6%97%b6%e5%ba%8f aria-label=锚点>#</a></span></h3><p><figure><img src=./pics/image_meBJbwD_rr.png alt class="mx-auto my-0 rounded-md"></figure></p><p>由规格书可知，垂直时序参数（单位是行）：</p><ul><li>VSW (垂直同步宽度，就是前面说的VSA): 2行 (固定)</li><li>VBP (垂直后消隐): 30~34行 (典型值34行)</li><li>VDISP (有效显示，就是前面说的VACT): 1200行 (固定)</li><li>VFP (垂直前消隐): 30~36行 (典型值36行)</li><li>VTOTAL (垂直总行数): 最大2047行</li><li>VPT (垂直消隐总时间) = VSW + VBP + VFP，典型值: VPT = 2 + 34 + 36 = 72行</li></ul><h3 id=水平扫描时序 class="relative group">水平扫描时序 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%b0%b4%e5%b9%b3%e6%89%ab%e6%8f%8f%e6%97%b6%e5%ba%8f aria-label=锚点>#</a></span></h3><p><figure><img src=./pics/image_n5kHKh16qJ.png alt class="mx-auto my-0 rounded-md"></figure></p><p>由规格书可知，水平时序参数（单位是像素）：</p><ul><li>HSW（水平同步脉冲宽度，就是前面说的HSA）：6像素 (典型值)</li><li>HBP（水平后消隐）：32像素 (典型值)</li><li>HFP（水平前消隐）：32像素 (典型值)</li><li>HDISP (水平有效显示，就是前面说的HACT)：1600像素</li><li>HBLK (水平消隐总时间)=HSW+HBP+HFP ： 6 + 32 + 32 = 70像素</li></ul><h3 id=像素时钟和接口速率 class="relative group">像素时钟和接口速率 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%83%8f%e7%b4%a0%e6%97%b6%e9%92%9f%e5%92%8c%e6%8e%a5%e5%8f%a3%e9%80%9f%e7%8e%87 aria-label=锚点>#</a></span></h3><p>在1600x1200分辨率，60Hz帧率的情况下，基于像素单位的时序计算像素时钟：</p><ol><li>水平总像素 = HSW + HBP + HDISP + HFP = 6 + 32 + 1600 + 32 = 1670像素</li><li>垂直总行数 = VSW + VBP + VDISP + VFP = 2 + 34 + 1200 + 36 = 1272行</li><li>一帧的像素总数 = 1670 × 1272 = 2124240 像素</li><li>60Hz帧率下，每秒显示60帧，总像素数 = 1670 × 1272 × 60 = 127646400像素/秒</li><li>像素时钟 = 127.65MHz</li></ol><p>因为每个像素是24Bit（RGB888），所以，D-PHY接口的带宽需求就是 24bit x 127.65MHz = 3.0636Gbps ，每条 Lane 的数据速率就是 3.0636Gbps/4 = 765.9Mbps ≈ 800Mbps 。时钟频率是 800Mbps/2 = 400MHz。</p><h3 id=初始化命令 class="relative group">初始化命令 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e5%91%bd%e4%bb%a4 aria-label=锚点>#</a></span></h3><p>初始化命令是一组指令，由屏的厂家直接给出，可以由MIPI DSI，I2C 或者 SPI 接口传输，具体由屏的规格书决定。例如，下面是该屏厂给出的800x600分辨率60Hz帧率的情况下的时序参数和初始化命令，由左边是MIPI格式，右边是I2C格式：</p><p><figure><img src=./pics/image_t3AvUnCT5i.png alt class="mx-auto my-0 rounded-md"></figure></p><h2 id=实例调试 class="relative group">实例调试 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%ae%9e%e4%be%8b%e8%b0%83%e8%af%95 aria-label=锚点>#</a></span></h2><p>以在Hi3516dv500的u-boot点亮SY050WGM01为例。参考海思SDK中提供的文档：</p><ul><li>\ReleaseDoc\zh\02.only for reference\Software\屏幕对接使用指南.pdf</li><li>\ReleaseDoc\zh\02.only for reference\Software\RGB_MIPI屏幕时钟时序计算器.xlsx</li><li>\ReleaseDoc\zh\01.Software\board\MPP\开机画面使用指南.pdf</li><li>\ReleaseDoc\zh\01.Software\board\MPP\MPP 媒体处理软件 V6.0 开发参考.pdf</li></ul><h3 id=源码分析 class="relative group">源码分析 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label=锚点>#</a></span></h3><p>Hi3516dv500的视频输出模块叫做VO，有它来驱动MIPI DSI接口向屏幕输出图像，所以u-boot中启动显示设备的命令是startvo，语法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>startvo <span class=o>[</span>dev<span class=o>]</span> <span class=o>[</span>intftype<span class=o>]</span> <span class=o>[</span>sync<span class=o>]</span>
</span></span></code></pre></div><ul><li>dev 表示设备号，Hi3516dv500支持的超高清显示设备DHD0，设备号就是0 （它支持一个视频层VHD0和一个图形层G0）。</li><li>intftype 表示接口类型，MIPI接口的编号是1024</li><li>sync 表示时序类型，官方内置了默认的时序，例如24(代表1600x1200_60)，如果是自己添加的液晶屏驱动，这里要设置为48，表示用户自定义。</li></ul><p>该命令的实现是<code>do_startvo()</code>函数，依次做两个工作：</p><ol><li>调用<code>start_vo(dev, intftype, sync)</code> 配置并启动VO</li><li>调用<code>do_start_mipi_tx(intftype, sync)</code> 配置并启动MIPI_TX</li></ol><h4 id=start_vo class="relative group">start_vo <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#start_vo aria-label=锚点>#</a></span></h4><p><code>start_vo()</code> 函数负责初始化、配置和启动VO设备。执行流程：</p><ol><li>调用 <code>vo_init()</code> 初始化视频输出系统</li><li>调用 <code>vo_construct_pub_attr()</code> 根据设备号、接口类型和时序类型构造公共属性结构体变量 <code>ot_vo_pub_attr pub_attr</code> 。其中关键的用户时序参数定义在<code>product/ot_osd/vo/arch/hi3519dv500/hal/drv_vo_dev.c</code>文件的<code>ot_vo_sync_info g_vo_user_sync_timing[]</code>数组里：<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=n>ot_vo_sync_info</span> <span class=n>g_vo_user_sync_timing</span><span class=p>[</span><span class=n>OT_VO_MAX_PHYS_DEV_NUM</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * |--INTFACE---||-----TOP-----||----HORIZON--------||----BOTTOM-----||-PULSE-||-INVERSE-|
</span></span></span><span class=line><span class=cl><span class=cm>     * syncm, iop, itf,   vact, vbb,  vfb,  hact,  hbb,  hfb, hmid,bvact,bvbb, bvfb, hpw, vpw,idv, ihs, ivs
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>600</span><span class=p>,</span> <span class=mi>36</span><span class=p>,</span> <span class=mi>36</span><span class=p>,</span> <span class=mi>800</span><span class=p>,</span> <span class=mi>56</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span> <span class=p>},</span> <span class=cm>/* 800x600@60_hz */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// VO输出用户时序信息的数据结构ot_vo_pub_attr.ot_vo_sync_info的定义
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>td_u32</span> <span class=n>bg_color</span><span class=p>;</span> <span class=cm>/* RW; background color of a device, in RGB format. */</span>
</span></span><span class=line><span class=cl>    <span class=n>ot_vo_intf_type</span> <span class=n>intf_type</span><span class=p>;</span> <span class=cm>/* RW; VO接口类型，来自startvo的intftype参数，MIPI接口的编号是1024(OT_VO_INTF_MIPI) */</span>
</span></span><span class=line><span class=cl>    <span class=n>ot_vo_intf_sync</span> <span class=n>intf_sync</span><span class=p>;</span> <span class=cm>/* RW; VO时序类型，来自startvo的sync参数，自定义是设置48(OT_MIPI_TX_OUT_USER或者OT_VO_OUT_USER)*/</span>
</span></span><span class=line><span class=cl>    <span class=n>ot_vo_sync_info</span> <span class=n>sync_info</span><span class=p>;</span> <span class=cm>/* RW; VO接口的时序信息，来自 struct ot_vo_sync_info*/</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>ot_vo_pub_attr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=n>td_bool</span> <span class=n>syncm</span><span class=p>;</span>      <span class=c1>// 同步模式，参数无意义，配置为0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_bool</span> <span class=n>iop</span><span class=p>;</span>        <span class=c1>// 隔行/逐行标志，0=隔行时序，1=逐行时序。MIPI和LCD配置为1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u8</span> <span class=n>intfb</span><span class=p>;</span>        <span class=c1>// 输出接口位宽，参数无意义，配置为0
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>td_u16</span> <span class=n>vact</span><span class=p>;</span>        <span class=c1>// 垂直有效区，屏幕垂直分辨率，如1080、720等
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u16</span> <span class=n>vbb</span><span class=p>;</span>         <span class=c1>// 垂直消隐后肩，VSA+VBP（垂直同步+垂直后消隐）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u16</span> <span class=n>vfb</span><span class=p>;</span>         <span class=c1>// 垂直消隐前肩，VFP（垂直前消隐）
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>td_u16</span> <span class=n>hact</span><span class=p>;</span>        <span class=c1>// 水平有效区，屏幕水平分辨率，如1920、1280等
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u16</span> <span class=n>hbb</span><span class=p>;</span>         <span class=c1>// 水平消隐后肩，HSA+HBP（水平同步+水平后消隐）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u16</span> <span class=n>hfb</span><span class=p>;</span>         <span class=c1>// 水平消隐前肩，HFP（水平前消隐）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u16</span> <span class=n>hmid</span><span class=p>;</span>        <span class=c1>// 底场垂直同步有效像素值，逐行时序时无意义，置为1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>td_u16</span> <span class=n>bvact</span><span class=p>;</span>       <span class=c1>// 底场垂直有效区，逐行时序时无意义，置为1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u16</span> <span class=n>bvbb</span><span class=p>;</span>        <span class=c1>// 底场垂直消隐后肩，逐行时序时无意义，置为1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u16</span> <span class=n>bvfb</span><span class=p>;</span>        <span class=c1>// 底场垂直消隐前肩，逐行时序时无意义，置为1
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>td_u16</span> <span class=n>hpw</span><span class=p>;</span>         <span class=c1>// 水平同步信号宽度，HSA（水平同步脉冲宽度）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u16</span> <span class=n>vpw</span><span class=p>;</span>         <span class=c1>// 垂直同步信号宽度，VSA（垂直同步脉冲宽度）
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>td_bool</span> <span class=n>idv</span><span class=p>;</span>        <span class=c1>// 数据有效信号极性，0=高有效，1=低有效。MIPI固定高有效
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_bool</span> <span class=n>ihs</span><span class=p>;</span>        <span class=c1>// 水平有效信号极性，0=高有效，1=低有效。MIPI固定高有效
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_bool</span> <span class=n>ivs</span><span class=p>;</span>        <span class=c1>// 垂直有效信号极性，0=高有效，1=低有效。MIPI固定高有效
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>ot_vo_sync_info</span><span class=p>;</span>
</span></span></code></pre></div></li><li>调用<code>vo_set_pub_attr()</code> 根据<code>ot_vo_pub_attr pub_attr</code>设置设备的公共属性。</li><li>调用 <code>vo_set_user_sync_clk()</code> 函数，从<code>product/ot_osd/vo/arch/hi3519dv500/hal/drv_vo_dev.c</code>文件的<code>ot_vo_user_sync_info g_vo_user_sync_info[]</code>数组里获取时钟配置，然后设置输出时钟频率。定义如下：<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=n>ot_vo_user_sync_info</span> <span class=n>g_vo_user_sync_info</span><span class=p>[</span><span class=n>OT_VO_MAX_PHYS_DEV_NUM</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>manual_user_sync_info</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>user_sync_attr</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>clk_src</span> <span class=o>=</span> <span class=n>OT_VO_CLK_SRC_LCDMCLK</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>lcd_m_clk_div</span> <span class=o>=</span> <span class=mh>0x3EF962</span><span class=p>,</span>  <span class=c1>//LCD时钟分频
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>pre_div</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=cm>/* if hdmi, set it by pixel clk */</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>dev_div</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=cm>/* if rgb, set it by serial mode */</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>op_mode</span> <span class=o>=</span> <span class=n>OT_OP_MODE_MANUAL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>clk_reverse_en</span> <span class=o>=</span> <span class=n>TD_TRUE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// VO输出时钟频率的数据结构ot_vo_user_sync_info的定义
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>td_bool</span> <span class=n>clk_reverse_en</span><span class=p>;</span>              <span class=c1>// 设置时钟相位是否相反，0表示正向，1表示反向，对于MIPI屏，固定为反向即可
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ot_op_mode</span> <span class=n>op_mode</span><span class=p>;</span>     <span class=c1>// 时序操作模式，0表示自动设置，1表示手动设置。u-boot阶段只支持手动设置。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ot_vo_auto_user_sync_info</span> <span class=n>auto_user_sync_info</span><span class=p>;</span> <span class=c1>// 自动模式下的时钟参数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ot_vo_manual_user_sync_info</span> <span class=n>manual_user_sync_info</span><span class=p>;</span> <span class=c1>// 手动模式下的时钟参数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>ot_vo_user_sync_info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 手动模式下的时钟参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ot_vo_user_sync_attr</span> <span class=n>user_sync_attr</span><span class=p>;</span> <span class=c1>// 时序属性：时钟源类型、时钟大小配置信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>pre_div</span><span class=p>;</span>                      <span class=c1>// 设备前置分频，取值范围 [1, 32]，MIPI屏固定为1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>dev_div</span><span class=p>;</span>                      <span class=c1>// 设备时钟分频比，取值范围[1, 4]，MIPI屏固定为1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>ot_vo_manual_user_sync_info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 时序属性
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ot_vo_clk_src</span> <span class=n>clk_src</span><span class=p>;</span> <span class=c1>// 时钟源类型，
</span></span></span><span class=line><span class=cl><span class=c1></span>                           <span class=c1>// 中小型LCD屏建议选择LCD分频器时钟源（OT_VO_CLK_SRC_LCDMCLK），可以输出0~75MHz的时钟；
</span></span></span><span class=line><span class=cl><span class=c1></span>                           <span class=c1>// 中大型LCD屏建议选择PLL时钟源，可以输出16.326531~594MHz时钟
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>union</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ot_vo_pll</span> <span class=n>vo_pll</span><span class=p>;</span>  <span class=c1>// clk_src为OT_VO_CLK_SRC_PLL或OT_VO_CLK_SRC_PLL_FOUT4时有效，user synchronization timing clock PLL information
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>td_u32</span> <span class=n>lcd_m_clk_div</span><span class=p>;</span> <span class=c1>// clk_src为OT_VO_CLK_SRC_LCDMCLK时有效。LCD时钟源的分频系数，取值范围 [1, 8473341]，假定目标频率src_clk（MHz），则分频系数lcd_m_clk_div= (src_clk/1188) * 2^27； src_clk最大75MHz
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ot_vo_fixed_clk</span> <span class=n>fixed_clk</span><span class=p>;</span> <span class=c1>// clk_src为OT_VO_CLK_SRC_FIXED时有效。fixed clock。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>ot_vo_user_sync_attr</span><span class=p>;</span>
</span></span></code></pre></div></li><li>调用 <code>vo_enable()</code> 启用视频输出设备。</li></ol><h4 id=do_start_mipi_tx class="relative group">do_start_mipi_tx <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#do_start_mipi_tx aria-label=锚点>#</a></span></h4><p><code>do_start_mipi_tx(intftype, sync)</code>的核心函数是<code>sample_comm_mipi_tx.c:mipi_tx_display()</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>mipi_tx_display</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>intftype</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>sync</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sample_mipi_tx_config</span> <span class=n>tx_config</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>((</span><span class=n>intftype</span> <span class=o>&amp;</span> <span class=n>OT_VO_INTF_MIPI</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=n>intftype</span> <span class=o>&amp;</span> <span class=n>OT_VO_INTF_MIPI_SLAVE</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>tx_config</span><span class=p>.</span><span class=n>intf_sync</span> <span class=o>=</span> <span class=n>sync</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * step1: Users do:
</span></span></span><span class=line><span class=cl><span class=cm>     * fill the cmd_count and cmd_info for a peripheral device.
</span></span></span><span class=line><span class=cl><span class=cm>     * If this peripheral device needs to be configured through mipi_tx controller.
</span></span></span><span class=line><span class=cl><span class=cm>     * If not, ignore this step or fill in to 0.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nf>set_mipi_tx_config_cmd_info</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tx_config</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * step2: Users do:
</span></span></span><span class=line><span class=cl><span class=cm>     * fill the combo_dev_cfg for mipi_tx in USER timing.
</span></span></span><span class=line><span class=cl><span class=cm>     * If it is not user timing, the system will automatically fill in this item in step3.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nf>set_mipi_tx_config_combo_dev_cfg</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tx_config</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * step3: System do:
</span></span></span><span class=line><span class=cl><span class=cm>     * If it is not user timing, it is not necessary to fill in the combo_dev_cfg,
</span></span></span><span class=line><span class=cl><span class=cm>     * and the system will adopt a default configuration.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nf>sample_comm_start_mipi_tx</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tx_config</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>参数：</p><ul><li>intftype: 接口类型，用于确定是否为MIPI接口</li><li>sync: 同步类型，指定分辨率和帧率</li></ul><p>这个函数主要是初始化<code>sample_mipi_tx_config tx_config</code>结构体变量，然后按照结构体的内容对MIPI进行配置，这是一个用于配置MIPI Tx（发送器）的结构体，它封装了驱动MIPI显示屏所需的各种参数和配置信息，结构体的定义：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* for combo dev config */</span>
</span></span><span class=line><span class=cl>    <span class=n>mipi_tx_intf_sync</span> <span class=n>intf_sync</span><span class=p>;</span> <span class=c1>// 接口时序类型，对应不同的分辨率和刷新率，例如OT_VO_OUT_1600x1200_60（值为48）表示1600x1200@60Hz
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>    <span class=cm>/* for screen cmd */</span>
</span></span><span class=line><span class=cl>    <span class=n>td_u32</span> <span class=n>cmd_count</span><span class=p>;</span> <span class=c1>// 初始化命令的数量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mipi_tx_cmd_info</span> <span class=o>*</span><span class=n>cmd_info</span><span class=p>;</span>  <span class=c1>// 初始化命令序列的数组指针
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>    <span class=cm>/* for user sync */</span>
</span></span><span class=line><span class=cl>    <span class=kt>combo_dev_cfg_t</span> <span class=n>combo_dev_cfg</span><span class=p>;</span> <span class=c1>// MIPI TX设备组合配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>sample_mipi_tx_config</span><span class=p>;</span>
</span></span></code></pre></div><p>执行流程：</p><ol><li>检查接口类型是否为MIPI或MIPI从设备</li><li>设置接口时序类型<code>tx_config->intf_sync</code>，如果是用户自定义，这个值是<code>48（OT_MIPI_TX_OUT_USER）</code></li><li>通过<code>set_mipi_tx_config_cmd_info()</code>函数设置屏幕初始化命令（<code>tx_config->cmd_info</code>和<code>tx_config->cmd_count</code>），如果sync设置的是<code>48（OT_MIPI_TX_OUT_USER）</code>，用户需要自定义一个<code>struct mipi_tx_cmd_info</code> 数组，并传递给<code>set_mipi_tx_config_cmd_info()</code>函数：<ol><li><code>tx_config->cmd_info</code>，屏幕初始化命令序列，实际是一组MIPI命令，用 <code>struct mipi_tx_cmd_info</code> 数组描述，添加特定液晶屏时要自定义一个这样的数组，并注册到<code>tx_config</code></li><li><code>tx_config->cmd_count</code>，屏幕初始化命令的数量，也就是<code>struct mipi_tx_cmd_info</code> 数组的长度。</li></ol></li><li>通过<code>set_mipi_tx_config_combo_dev_cfg()</code>函数设置MIPI Tx设备组合配置<code>tx_config->combo_dev_cfg</code>，它包含了MIPI Tx设备的设备号，LaneID，时钟频率，LCD的时序参数等。如果sync设置的是<code>48（OT_MIPI_TX_OUT_USER）</code>，会使用<code>combo_dev_cfg_t g_sample_comm_mipi_tx_1920x1080_60_config</code>中的配置。添加特定液晶屏时要自定义一个这样的数组，并注册到<code>tx_config</code>。</li><li>通过<code>sample_comm_start_mipi_tx()</code>函数按照<code>tx_config</code>的配置启动MIPI TX：<ol><li>检查配置参数</li><li>初始化MIPI Tx模块</li><li>如果sync设置的不是<code>48（OT_MIPI_TX_OUT_USER）</code>，会依据<code>tx_config->intf_sync</code>的值，在<code>mipi_tx_intf_sync_cfg</code>数组里匹配一个MIPI TX配置，传递给<code>tx_config->combo_dev_cfg</code></li><li>调用<code>mipi_tx_set_combo_dev_cfg(const combo_dev_cfg_t *dev_cfg)</code>，根据<code>tx_config->combo_dev_cfg</code>配置 mipi_tx设备的参数.</li><li>执行<code>tx_config->cmd_info</code>中的命令，初始化屏幕。</li><li>使能MIPI Tx</li></ol></li></ol><p>初始化命令序列的数据结构<code>tx_config->cmd_info</code>定义：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>td_u32</span> <span class=n>devno</span><span class=p>;</span>                 <span class=c1>// MIPI Tx设备号，固定 0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>work_mode</span><span class=p>;</span>             <span class=c1>// 工作模式，低功耗模式和高速模式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>lp_clk_en</span><span class=p>;</span>             <span class=c1>// 低功耗时钟使能
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>data_type</span><span class=p>;</span>             <span class=c1>// 初始化命令数组的数据类型。根据数据个数选择数据类型：类型1、当只有寄存器地址没有数据时，数据类型选择0x5；类型2、有寄存器地址和一个数据时，数据类型选择0x15；类型3、有寄存器地址且数据个数大于等于两个数据类型一般用0x39。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>cmd_size</span><span class=p>;</span>              <span class=c1>// 如果初始化命令数组的数据类型是类型三，设置为初始化命令数组的大小。如果是类型1，设置为寄存器地址；如果是类型2，低八位为地址，高八位为数据。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u8</span> <span class=o>*</span><span class=n>cmd</span><span class=p>;</span>                   <span class=c1>// 如果初始化命令数组的数据类型是类型3，设置为命令数组，如果是类型1或者类型2，可置为NULL；
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=kt>cmd_info_t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>cmd_info_t</span> <span class=n>cmd_info</span><span class=p>;</span>          <span class=c1>// 初始化命令信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>usleep_value</span><span class=p>;</span>          <span class=c1>// 命令执行后的延迟时间(微秒)，固定设置为UDELAY_50。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>mipi_tx_cmd_info</span><span class=p>;</span>
</span></span></code></pre></div><blockquote><p>注意，<code>tx_config->cmd_info</code>定义的初始化命令，是通过MIPI 接口发送的，如果要通过其他接口发送，需要自定义。</p></blockquote><p>MIPI设备组合配置的数据结构<code>tx_config->combo_dev_cfg</code>定义：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>td_u32</span> <span class=n>devno</span><span class=p>;</span>                 <span class=c1>// MIPI Tx设备号，配0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>lane_id</span><span class=p>[</span><span class=n>LANE_MAX_NUM</span><span class=p>];</span> <span class=c1>// 数据通道ID，4lane配成{0,1,2,3}，2lane配成{0,1,-1,-1}
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>out_mode</span><span class=p>;</span>              <span class=c1>// 输出模式 (OUTPUT_MODE_CSI，OUTPUT_MODE_DSI_VIDEO，OUTPUT_MODE_DSI_CMD)，需要从屏的规格书确认。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>video_mode</span><span class=p>;</span>            <span class=c1>// VIDEO模式下的数据格式。参数选择范围： BURST_MODE、NON_BURST_MODE_SYNC_PULSES、NON_BURST_MODE_SYNC_EVENTS，三种模式下，传递的数序和数据包位置不同，需要从屏的规格书确认。如果output_mode_t属性为OUTPUT_MODE_DSI_CMD，本属性配置不生效。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>out_format</span><span class=p>;</span>            <span class=c1>// 输出格式，参数包括OUT_FORMAT_RGB_24BIT = 0x3,OUT_FORMAT_YUV420_12BIT = 0x4 等，需要从屏的规格书确认
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>vact</span><span class=p>;</span>    <span class=c1>// 垂直有效区行数，屏幕垂直分辨率
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>vbp</span><span class=p>;</span>     <span class=c1>// 垂直后消隐区行数，垂直后消隐（不包含同步脉冲）
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>vfp</span><span class=p>;</span>     <span class=c1>// 垂直前消隐区行数，垂直前消隐
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>hact</span><span class=p>;</span>    <span class=c1>// 水平有效区像素个数，屏幕水平分辨率
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>hbp</span><span class=p>;</span>     <span class=c1>// 水平后消隐区像素个，水平后消隐（不包含同步脉冲）
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>hfp</span><span class=p>;</span>     <span class=c1>// 水平前消隐区像素个数，水平前消隐
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>hpw</span><span class=p>;</span>     <span class=c1>// 水平同步脉冲区像素个数，HSA，要求与VO时序中的hpw一致
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>vpw</span><span class=p>;</span>     <span class=c1>// 垂直同步脉冲区行数，VSA，要求与VO时序中的vpw一致
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=kt>sync_info_t</span><span class=p>;</span>                  <span class=c1>// 同步信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>phy_data_rate</span><span class=p>;</span>         <span class=c1>// 一条Lane的数据速率 (Mbps)，配置值&gt;= (hact+hsa+hbp+hfp)*(vact+vsa+vbp+vfp)*output format bits* framerate / lane_num/（ 10^6）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>td_u32</span> <span class=n>pixel_clk</span><span class=p>;</span>             <span class=c1>// 像素时钟 (KHz)，配置值=(hact+hsa+hbp+hfp)*(vact+vsa+vbp+vfp)*framerate/1000，向上取整
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=kt>combo_dev_cfg_t</span><span class=p>;</span>
</span></span></code></pre></div><h4 id=总结 class="relative group">总结 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%80%bb%e7%bb%93 aria-label=锚点>#</a></span></h4><p>对比VO和MIPI_TX的时序参数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>屏幕规格参数 → MIPI sync_info_t → VO ot_vo_sync_info
</span></span><span class=line><span class=cl>─────────────────────────────────────────────────────
</span></span><span class=line><span class=cl>HACT         → hact            → hact
</span></span><span class=line><span class=cl>HBP          → hbp             → hbb = hsa + hbp  
</span></span><span class=line><span class=cl>HFP          → hfp             → hfb
</span></span><span class=line><span class=cl>HSA          → hpw             → hpw
</span></span><span class=line><span class=cl>VACT         → vact            → vact  
</span></span><span class=line><span class=cl>VBP          → vbp             → vbb = vsa + vbp
</span></span><span class=line><span class=cl>VFP          → vfp             → vfb
</span></span><span class=line><span class=cl>VSA          → vpw             → vpw
</span></span></code></pre></div><p>添加新的屏幕时，主要是修改或者新建如下几个数据结构：</p><ul><li><code>ot_vo_sync_info g_vo_user_sync_timing[]</code>，定义VO时序参数</li><li><code>ot_vo_user_sync_info g_vo_user_sync_info[]</code>，定义VO时钟参数</li><li><code>combo_dev_cfg_t g_sample_comm_mipi_tx_800x600_60_config</code>，MIPI Tx 时序参数</li><li><code>mipi_tx_cmd_info g_sy050wgm01_init_cmds[]</code>，初始化命令数组</li></ul><h3 id=调试过程 class="relative group">调试过程 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%b0%83%e8%af%95%e8%bf%87%e7%a8%8b aria-label=锚点>#</a></span></h3><p>调试过程如下：</p><ol><li>配置引脚复用</li><li>MIPI屏使能和复位</li><li>配置背光</li><li>配置VO输出时序</li><li>配置VO输出时钟</li><li>配置MIPI Tx时序</li><li>配置屏幕初始化序列</li><li>启动VO和MIPI Tx</li></ol><h4 id=引脚复用 class="relative group">引脚复用 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%bc%95%e8%84%9a%e5%a4%8d%e7%94%a8 aria-label=锚点>#</a></span></h4><p>当前主板用到的引脚包括：</p><ol><li>Power：<code>LCD_PWM(GPIO4_4)</code>，电源使能，需要启动时拉高。</li><li>Reset：<code>LCD_RESET(GPIO8_3)</code>，输出低电平脉冲进行复位。</li><li>MIPI_DSI: <code>DSI_D0P/N\~DSI_D3P/N</code>, <code>DSI_CKP/N</code></li><li>I2C0：<code>TP_I2C0_SCL/TP_I2C0_SDA</code></li></ol><h4 id=屏幕使能和复位 class="relative group">屏幕使能和复位 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%b1%8f%e5%b9%95%e4%bd%bf%e8%83%bd%e5%92%8c%e5%a4%8d%e4%bd%8d aria-label=锚点>#</a></span></h4><p>屏幕的电源控制引脚是<code>GPIO4_4</code>，启动时拉高，复位引脚是<code>GPIO8_3</code>，启动时依次输出101，完成复位。参考代码:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>screen_poweron</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>writel</span><span class=p>(</span><span class=mh>0x1201</span><span class=p>,</span> <span class=n>PIN_F19_IOCFG_REG22</span><span class=p>);</span> <span class=c1>// F19引脚的功能设置为GPIO4_4
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>set_gpio_dir</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=n>GPIO_DIR_OUT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>mdelay</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>set_gpio_output</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>mdelay</span><span class=p>(</span><span class=mi>15</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>screen_reset</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>writel</span><span class=p>(</span><span class=mh>0x1300</span><span class=p>,</span> <span class=n>PIN_P19_IOCFG_REG54</span><span class=p>);</span> <span class=c1>// P19引脚的功能设置为GPIO8_3
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>set_gpio_dir</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>GPIO_DIR_OUT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>mdelay</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>set_gpio_output</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>mdelay</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>set_gpio_output</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>mdelay</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>set_gpio_output</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>mdelay</span><span class=p>(</span><span class=mi>15</span><span class=p>);</span>  <span class=c1>// 复位后需要保持足够的延时，让屏幕控制进入正常状态，等待初始化命令
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>board_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nf>screen_poweron</span><span class=p>();</span>  
</span></span><span class=line><span class=cl>  <span class=nf>screen_reset</span><span class=p>();</span>  
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>启动后在u-boot验证<code>GPIO4_4</code>和<code>GPIO8_3</code>的引脚复用，方向和输入</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># GPIO4_4</span>
</span></span><span class=line><span class=cl>~ <span class=c1># md.l 10260058 1</span>
</span></span><span class=line><span class=cl>10260058: <span class=m>00001201</span>                             ....
</span></span><span class=line><span class=cl>~ <span class=c1># md.l 11094400 1</span>
</span></span><span class=line><span class=cl>11094400: <span class=m>00000010</span>                             ....
</span></span><span class=line><span class=cl>~ <span class=c1># md.l 11094040 1</span>
</span></span><span class=line><span class=cl>11094040: <span class=m>00000010</span>                             ....
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># GPIO8_3</span>
</span></span><span class=line><span class=cl>~ <span class=c1># md.l 0x102600D8 1</span>
</span></span><span class=line><span class=cl>102600d8: <span class=m>00001300</span>                             ....
</span></span><span class=line><span class=cl>~ <span class=c1># md.l 0x11098400 1</span>
</span></span><span class=line><span class=cl>11098400: <span class=m>00000008</span>                             ....
</span></span><span class=line><span class=cl>~ <span class=c1># md.l 0x11098020 1</span>
</span></span><span class=line><span class=cl>11098020: <span class=m>00000008</span>                             ....
</span></span></code></pre></div><h4 id=背光 class="relative group">背光 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e8%83%8c%e5%85%89 aria-label=锚点>#</a></span></h4><p>该屏的背光是有初始化命令设置的，不用单独配置。如果是通过PWM或者GPIO设置的屏，需要在 <code>board_init(void)</code> 函数中添加相关代码。</p><h4 id=vo的输出时序 class="relative group">VO的输出时序 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#vo%e7%9a%84%e8%be%93%e5%87%ba%e6%97%b6%e5%ba%8f aria-label=锚点>#</a></span></h4><p>用官方提供的《RGB_MIPI屏幕时钟时序计算器.xlsx》，输入屏幕的属性，可以直接计算得到的时序参数：</p><table><thead><tr><th>MIPI屏幕属性</th><th>输入值</th><th>VO用户时序参数值</th><th>输出值</th></tr></thead><tbody><tr><td>水平有效区          HACT（像素）</td><td>800</td><td>水平有效区          hact（像素）</td><td>800</td></tr><tr><td>水平后消隐          HBP（像素）</td><td>50</td><td>水平消隐后肩        hbb（像素）</td><td>56</td></tr><tr><td>水平前消隐          HFP（像素）</td><td>50</td><td>水平消隐前肩        hfb（像素）</td><td>50</td></tr><tr><td>水平同步时序        HSA（像素）</td><td>6</td><td>水平同步信号        hpw（像素）</td><td>6</td></tr><tr><td>垂直有效区          VACT（行数）</td><td>600</td><td>垂直有效区          vact（行数）</td><td>600</td></tr><tr><td>垂直后消隐          VBP（行数）</td><td>32</td><td>垂直消隐后肩        vbb（行数）</td><td>36</td></tr><tr><td>垂直前消隐          VFP（行数）</td><td>36</td><td>垂直消隐前肩        vfb（行数）</td><td>36</td></tr><tr><td>垂直同步时序        VSA（行数）</td><td>4</td><td>垂直同步信号        vpw（行数）</td><td>4</td></tr><tr><td>设备输出帧率        frame rate</td><td>60</td><td></td><td></td></tr><tr><td>输出数据类型   output_format_t</td><td>24</td><td></td><td></td></tr><tr><td>使用的lane个数</td><td>4</td><td></td><td></td></tr><tr><td>MIPI Tx输出模式</td><td>1</td><td></td><td></td></tr></tbody></table><p>填到变量中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=n>ot_vo_sync_info</span> <span class=n>g_vo_user_sync_timing</span><span class=p>[</span><span class=n>OT_VO_MAX_PHYS_DEV_NUM</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * |--INTFACE---||-----TOP-----||----HORIZON--------||----BOTTOM-----||-PULSE-||-INVERSE-|
</span></span></span><span class=line><span class=cl><span class=cm>     * syncm, iop, itf,   vact, vbb,  vfb,  hact,  hbb,  hfb, hmid,bvact,bvbb, bvfb, hpw, vpw,idv, ihs, ivs
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>600</span><span class=p>,</span> <span class=mi>36</span><span class=p>,</span> <span class=mi>36</span><span class=p>,</span> <span class=mi>800</span><span class=p>,</span> <span class=mi>56</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span> <span class=p>},</span> <span class=cm>/* 800x600@60_hz */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h4 id=vo的输出时钟 class="relative group">VO的输出时钟 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#vo%e7%9a%84%e8%be%93%e5%87%ba%e6%97%b6%e9%92%9f aria-label=锚点>#</a></span></h4><p>VO接口输出时钟频率为时钟源输出时钟除以分频后得到，因此，为了得到接口输出时钟，需要依次设置时钟源类型、时钟大小和时钟分频比。拓扑关系如下图：</p><p><figure><img src=./pics/image_RxXW4Kj9d7.png alt class="mx-auto my-0 rounded-md"></figure></p><p>时钟源时钟频率与接口时钟之间的关系：</p><ol><li>CLK SOURCE 有很多时钟源，这个MIPI屏可以设置为 LCDMCLK 时钟源，然后配置<code>lcd_m_clk_div</code>分频，可以得到<code>src_clk</code>。</li><li><code>src_clk</code> 经过 <code>pre_div</code> （MIPI屏固定为1）分频输出 SC。</li><li>再经过<code>dev_div</code>（MIPI屏固定为1）分频即得到像素时钟<code>pixel_clk</code>，供MIPI屏使用。</li></ol><p><figure><img src=./pics/image_aYgVYcOBE1.png alt class="mx-auto my-0 rounded-md"></figure></p><p>同样可以通过计算得到VO用户时钟参数值：</p><table><thead><tr><th>MIPI屏幕属性</th><th>输入值</th><th>VO用户时钟参数值</th><th>输出值</th></tr></thead><tbody><tr><td>水平有效区          HACT（像素）</td><td>800</td><td>前置分频系数         pre_div[1,32]</td><td>1</td></tr><tr><td>水平后消隐          HBP（像素）</td><td>50</td><td>设备时钟分频系数     dev_div[1,4]</td><td>1</td></tr><tr><td>水平前消隐          HFP（像素）</td><td>50</td><td>LCD分频时钟（小于75MHz)lcdmclk_div</td><td>3EF962</td></tr><tr><td>水平同步时序        HSA（像素）</td><td>6</td><td>PLL时钟分频 (大于16.33MHz)fb_div</td><td>74</td></tr><tr><td>垂直有效区          VACT（行数）</td><td>600</td><td>frac</td><td>94F8B5</td></tr><tr><td>垂直后消隐          VBP（行数）</td><td>32</td><td>ref_div</td><td>1</td></tr><tr><td>垂直前消隐          VFP（行数）</td><td>36</td><td>post_div1</td><td>7</td></tr><tr><td>垂直同步时序        VSA（行数）</td><td>4</td><td>post_div2</td><td>7</td></tr><tr><td>设备输出帧率        frame rate</td><td>60</td><td>PLL(MHz)</td><td>74.58192</td></tr><tr><td>输出数据类型   output_format_t</td><td>24</td><td>FREF(MHz)</td><td>24</td></tr><tr><td>使用的lane个数</td><td>4</td><td></td><td></td></tr><tr><td>MIPI Tx输出模式</td><td>1</td><td></td><td></td></tr></tbody></table><p>填到变量中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=n>ot_vo_user_sync_info</span> <span class=n>g_vo_user_sync_info</span><span class=p>[</span><span class=n>OT_VO_MAX_PHYS_DEV_NUM</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>manual_user_sync_info</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>user_sync_attr</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>clk_src</span> <span class=o>=</span> <span class=n>OT_VO_CLK_SRC_LCDMCLK</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=n>lcd_m_clk_div</span> <span class=o>=</span> <span class=mh>0x3EF962</span><span class=p>,</span>  <span class=c1>//LCD时钟分频
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>pre_div</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=cm>/* if hdmi, set it by pixel clk */</span>
</span></span><span class=line><span class=cl>            <span class=p>.</span><span class=n>dev_div</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=cm>/* if rgb, set it by serial mode */</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>op_mode</span> <span class=o>=</span> <span class=n>OT_OP_MODE_MANUAL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>clk_reverse_en</span> <span class=o>=</span> <span class=n>TD_TRUE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h4 id=mipi-tx的时序参数 class="relative group">MIPI Tx的时序参数 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#mipi-tx%e7%9a%84%e6%97%b6%e5%ba%8f%e5%8f%82%e6%95%b0 aria-label=锚点>#</a></span></h4><p>同样可以通过计算得到MIPI Tx的时序参数：</p><table><thead><tr><th>MIPI屏幕属性</th><th>输入值</th><th>MIPI设备属性参数值</th><th>输出值</th></tr></thead><tbody><tr><td>水平有效区          HACT（像素）</td><td>800</td><td>行有效区像素个数    hact_pixels</td><td>800</td></tr><tr><td>水平后消隐          HBP（像素）</td><td>50</td><td>行后消隐区像素个数  hbp_pixels</td><td>50</td></tr><tr><td>水平前消隐          HFP（像素）</td><td>50</td><td>行前消隐区像素个数  hfp_pixels</td><td>50</td></tr><tr><td>水平同步时序        HSA（像素）</td><td>6</td><td>行同步像素个数      hsa_pixels</td><td>6</td></tr><tr><td>垂直有效区          VACT（行数）</td><td>600</td><td>帧前有效区行数      vact_lines</td><td>600</td></tr><tr><td>垂直后消隐          VBP（行数）</td><td>32</td><td>帧后消隐区行数      vbp_lines</td><td>32</td></tr><tr><td>垂直前消隐          VFP（行数）</td><td>36</td><td>帧前消隐区行数      vfp_lines</td><td>36</td></tr><tr><td>垂直同步时序        VSA（行数）</td><td>4</td><td>帧同步区行数        vsa_lines</td><td>4</td></tr><tr><td>设备输出帧率        frame rate</td><td>60</td><td></td><td></td></tr><tr><td>输出数据类型   output_format_t</td><td>24</td><td>输入数据数率        phy_data_rate（Mbps）</td><td>220</td></tr><tr><td>使用的lane个数</td><td>4</td><td>像素时钟            pixel_clk(KHz)</td><td>36530</td></tr><tr><td>MIPI Tx输出模式</td><td>1</td><td></td><td></td></tr></tbody></table><p>新建一个<code>combo_dev_cfg_t</code>变量，并注册。参考代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=kt>combo_dev_cfg_t</span> <span class=n>g_sample_comm_mipi_tx_800x600_60_config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>devno</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>lane_id</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>out_mode</span> <span class=o>=</span> <span class=n>OUT_MODE_DSI_VIDEO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>out_format</span> <span class=o>=</span> <span class=n>OUT_FORMAT_RGB_24BIT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>video_mode</span> <span class=o>=</span>  <span class=n>BURST_MODE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>sync_info</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>vact</span> <span class=o>=</span> <span class=mi>600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>vbp</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>vfp</span> <span class=o>=</span> <span class=mi>36</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>hact</span> <span class=o>=</span> <span class=mi>800</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>hbp</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>hfp</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>hpw</span> <span class=o>=</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=n>vpw</span> <span class=o>=</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>phy_data_rate</span> <span class=o>=</span> <span class=mi>220</span><span class=p>,</span> <span class=c1>// 220Mbps
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>.</span><span class=n>pixel_clk</span> <span class=o>=</span> <span class=mi>36530</span><span class=p>,</span> <span class=c1>// 36530KHz
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>td_void</span> <span class=nf>set_mipi_tx_config_user</span><span class=p>(</span><span class=n>sample_mipi_tx_config</span> <span class=o>*</span><span class=n>tx_config</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>tx_config</span><span class=o>-&gt;</span><span class=n>intf_sync</span> <span class=o>==</span> <span class=n>OT_MIPI_TX_OUT_USER</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>td_void</span><span class=p>)</span><span class=nf>memcpy_s</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tx_config</span><span class=o>-&gt;</span><span class=n>combo_dev_cfg</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>combo_dev_cfg_t</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>g_sample_comm_mipi_tx_800x600_60_config</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>combo_dev_cfg_t</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=初始化命令序列 class="relative group">初始化命令序列 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e5%91%bd%e4%bb%a4%e5%ba%8f%e5%88%97 aria-label=锚点>#</a></span></h4><p>初始化命令序列需要自定义一个<code>mipi_tx_cmd_info</code>结构变量，并注册。参考代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SY050WGM01显示屏 800x600 60Hz MIPI初始化序列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>g_sy050wgm01_cmd_0</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0x51</span><span class=p>,</span> <span class=mh>0xFF</span><span class=p>,</span> <span class=mh>0x1F</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>g_sy050wgm01_cmd_1</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0x53</span><span class=p>,</span> <span class=mh>0x2C</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>g_sy050wgm01_cmd_2</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0x35</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>g_sy050wgm01_cmd_3</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0x6C</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>g_sy050wgm01_cmd_4</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0x6D</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>g_sy050wgm01_cmd_5</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0xF1</span><span class=p>,</span> <span class=mh>0xA5</span><span class=p>,</span> <span class=mh>0xA6</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>g_sy050wgm01_cmd_6</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0xE6</span><span class=p>,</span> <span class=mh>0x18</span><span class=p>,</span> <span class=mh>0xC0</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0x6B</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>g_sy050wgm01_cmd_7</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0xF1</span><span class=p>,</span> <span class=mh>0xA0</span><span class=p>,</span> <span class=mh>0xA0</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>...</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// MIPI初始化命令数组
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define UDELAY_50       50
</span></span></span><span class=line><span class=cl><span class=cp>#define UDELAY_20000    20000
</span></span></span><span class=line><span class=cl><span class=cp>#define UDELAY_32000    32000
</span></span></span><span class=line><span class=cl><span class=cp>#define UDELAY_100000   100000
</span></span></span><span class=line><span class=cl><span class=cp>#define SY050WGM01_INIT_CMD_COUNT 48
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=n>mipi_tx_cmd_info</span> <span class=n>g_sy050wgm01_init_cmds</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>{{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>g_sy050wgm01_cmd_0</span><span class=p>},</span> <span class=n>UDELAY_50</span><span class=p>},</span>  <span class=c1>// 类型3 (地址+2个数据), 地址:0x51
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span> <span class=mh>0x2C53</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>},</span> <span class=n>UDELAY_50</span><span class=p>},</span>  <span class=c1>// 类型2 (地址+1个数据), 地址:0x53
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span> <span class=mh>0x0035</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>},</span> <span class=n>UDELAY_50</span><span class=p>},</span>  <span class=c1>// 类型2 (地址+1个数据), 地址:0x35
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span> <span class=mh>0x036C</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>},</span> <span class=n>UDELAY_50</span><span class=p>},</span>  <span class=c1>// 类型2 (地址+1个数据), 地址:0x6C
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span> <span class=mh>0x006D</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>},</span> <span class=n>UDELAY_50</span><span class=p>},</span>  <span class=c1>// 类型2 (地址+1个数据), 地址:0x6D
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>g_sy050wgm01_cmd_5</span><span class=p>},</span> <span class=n>UDELAY_50</span><span class=p>},</span>  <span class=c1>// 类型3 (地址+2个数据), 地址:0xF1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=n>g_sy050wgm01_cmd_6</span><span class=p>},</span> <span class=n>UDELAY_50</span><span class=p>},</span>  <span class=c1>// 类型3 (地址+5个数据), 地址:0xE6
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x39</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>g_sy050wgm01_cmd_7</span><span class=p>},</span> <span class=n>UDELAY_50</span><span class=p>},</span>  <span class=c1>// 类型3 (地址+2个数据), 地址:0xF1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>...</span> 
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>td_void</span> <span class=nf>set_mipi_tx_config_cmd_info</span><span class=p>(</span><span class=n>sample_mipi_tx_config</span> <span class=o>*</span><span class=n>tx_config</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>tx_config</span><span class=o>-&gt;</span><span class=n>cmd_count</span> <span class=o>=</span> <span class=n>SY050WGM01_INIT_CMD_COUNT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>tx_config</span><span class=o>-&gt;</span><span class=n>cmd_info</span> <span class=o>=</span> <span class=n>g_sy050wgm01_init_cmds</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=启动vo输出 class="relative group">启动VO输出 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%90%af%e5%8a%a8vo%e8%be%93%e5%87%ba aria-label=锚点>#</a></span></h4><p>源码修改完毕后，可以启动u-boot，进入u-boot的命令行，依次执行如下命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>setvobg <span class=m>0</span> 0x00FF00
</span></span><span class=line><span class=cl>startvo <span class=m>0</span> <span class=m>1024</span> <span class=m>48</span>
</span></span></code></pre></div><ul><li><code>setvobg [dev] [color]</code>：设置背景色<ul><li>dev表示设备号，直接设为0</li><li>color是RGB格式的颜色，0x00FF00表示绿色。</li></ul></li><li><code>startvo [dev] [intftype] [sync]</code>：启动VO设备<ul><li>dev表示设备号，直接设为0;</li><li>intftype表示接口类型，MIPI就是1024;</li><li>sync 表示时序类型，自定义的时序设为48</li></ul></li></ul><p>一切正常的话，屏幕会亮起并显示绿色。</p><h4 id=添加启动画面 class="relative group">添加启动画面 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%b7%bb%e5%8a%a0%e5%90%af%e5%8a%a8%e7%94%bb%e9%9d%a2 aria-label=锚点>#</a></span></h4><p>屏幕已经点亮，就可以在u-boot阶段加载一张图片作为开机画面。以NandFlash启动为例，大致流程如下。</p><ol><li>准备一张jpg格式的图片，分辨率800x600，图片大小和CRC32校验值如下：<figure><img src=./pics/image_E2r44WG9TJ.png alt class="mx-auto my-0 rounded-md"></figure></li><li>讲图片文件写入NandFlash的特定地址，这里是512MB的NandFlash，我们写到后面的0x1EA80000地址处。</li><li>启动u-boot，进入u-boot命令行界面，先检查NandFlash的状态：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># nand info</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Device 0: nand0, sector size <span class=m>256</span> KiB
</span></span><span class=line><span class=cl>  Page size       <span class=m>4096</span> b
</span></span><span class=line><span class=cl>  OOB size         <span class=m>200</span> b
</span></span><span class=line><span class=cl>  Erase size    <span class=m>262144</span> b
</span></span><span class=line><span class=cl>  subpagesize     <span class=m>4096</span> b
</span></span><span class=line><span class=cl>  options     0x40004400
</span></span><span class=line><span class=cl>  bbt options 0x00008000
</span></span></code></pre></div></li><li>讲图片文件的数据从NandFlash读到内存的特定地址，并校验：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># nand read 0x92000000 0x1EA80000 0x6000</span>
</span></span><span class=line><span class=cl>NAND read: device <span class=m>0</span> offset 0x1ea80000, size 0x6000
</span></span><span class=line><span class=cl> <span class=m>24576</span> bytes read: OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># crc32 0x92000000 0x580c</span>
</span></span><span class=line><span class=cl>crc32 <span class=k>for</span> <span class=m>92000000</span> ... <span class=nv>9200580b</span> <span class=o>==</span>&gt; 4a21ff43
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># md.b 0x92000000 0x40</span>
</span></span><span class=line><span class=cl>92000000: ff d8 ff e0 <span class=m>00</span> <span class=m>10</span> 4a <span class=m>46</span> <span class=m>49</span> <span class=m>46</span> <span class=m>00</span> <span class=m>01</span> <span class=m>01</span> <span class=m>01</span> <span class=m>00</span> <span class=m>60</span>  ......JFIF.....<span class=sb>`</span>
</span></span><span class=line><span class=cl>92000010: <span class=m>00</span> <span class=m>60</span> <span class=m>00</span> <span class=m>00</span> ff db <span class=m>00</span> <span class=m>43</span> <span class=m>00</span> <span class=m>03</span> <span class=m>02</span> <span class=m>02</span> <span class=m>03</span> <span class=m>02</span> <span class=m>02</span> <span class=m>03</span>  .<span class=sb>`</span>.....C........
</span></span><span class=line><span class=cl>92000020: <span class=m>03</span> <span class=m>03</span> <span class=m>03</span> <span class=m>04</span> <span class=m>03</span> <span class=m>03</span> <span class=m>04</span> <span class=m>05</span> <span class=m>08</span> <span class=m>05</span> <span class=m>05</span> <span class=m>04</span> <span class=m>04</span> <span class=m>05</span> 0a <span class=m>07</span>  ................
</span></span><span class=line><span class=cl>92000030: <span class=m>07</span> <span class=m>06</span> <span class=m>08</span> 0c 0a 0c 0c 0b 0a 0b 0b 0d 0e <span class=m>12</span> <span class=m>10</span> 0d  ................
</span></span></code></pre></div></li><li>设置JPEG界面的必要参数：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># setenv jpeg_addr 0x92000000         # 存放JPG图片的内存地址</span>
</span></span><span class=line><span class=cl><span class=c1># setenv jpeg_size 0x580c             # JPG图片的实际大小</span>
</span></span><span class=line><span class=cl><span class=c1># setenv jpeg_emar_buf 0x96000000     # 解码过程中使用到的buffer地址</span>
</span></span><span class=line><span class=cl><span class=c1># setenv vobuf 0xa0000000             # 解码后输出的图片的存放地址</span>
</span></span><span class=line><span class=cl><span class=c1># saveenv</span>
</span></span></code></pre></div></li><li>启动解码，注意解码成功后输出的<code>stride 832</code>：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># dcache off</span>
</span></span><span class=line><span class=cl><span class=c1># decjpg 0</span>
</span></span><span class=line><span class=cl>you should first set:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>args: <span class=o>[</span>format<span class=o>]</span>
</span></span><span class=line><span class=cl>        -&lt;format&gt; : 0: semi-plannar yvu420
</span></span><span class=line><span class=cl>        - setenv jpeg_addr     0x--------
</span></span><span class=line><span class=cl>        - setenv jpeg_size     0x--------
</span></span><span class=line><span class=cl>        - setenv vobuf         0x--------
</span></span><span class=line><span class=cl>        - setenv jpeg_emar_buf 0x--------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>jpeg decoding ...
</span></span><span class=line><span class=cl><span class=s>&lt;&lt;addr=0x92000000, size=0x580c, jpeg_ema</span>r_buf<span class=o>=</span>0x96000000, <span class=nv>vobuf</span><span class=o>=</span>0xa0000000&gt;&gt;
</span></span><span class=line><span class=cl>hardware decoding success! 800x600, stride 832.
</span></span><span class=line><span class=cl>decode jpeg!
</span></span><span class=line><span class=cl><span class=c1># dcache on</span>
</span></span></code></pre></div></li><li>先开启VO：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># startvo 0 1024 48</span>
</span></span><span class=line><span class=cl>load mipi_tx driver successful!
</span></span><span class=line><span class=cl>mipi intf <span class=nv>sync</span> <span class=o>=</span> <span class=m>48</span>
</span></span><span class=line><span class=cl>cmd count is 48!
</span></span><span class=line><span class=cl>dev <span class=m>0</span> opened!
</span></span></code></pre></div></li><li>开启视频层，从解码后的内存地址读取图片显示。注意startvl的第三个参数<code>stride</code>要写832：<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># startvl 0 0xa0000000 832 0 0 800 600</span>
</span></span><span class=line><span class=cl>video layer <span class=m>0</span> opened!
</span></span></code></pre></div></li></ol><p>一切正常的话，会显示启动画面。</p></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=flex><picture class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full"><img width=568 height=568 class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full" alt=Shaocheng.Li loading=lazy decoding=async src=/img/author.png></picture><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Shaocheng.Li</div><div class="text-sm text-neutral-700 dark:text-neutral-400">A Linux software engineer.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/exbob target=_blank aria-label=Github rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/2025/08/11/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">追求注意力自由</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2025-08-11 09:54:03 +0800 +0800">2025 八月 11</time>
</span></span></a></span><span></span></div></div></footer></article></main><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12" id=to-top hidden=true><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=回到顶部 title=回到顶部>&uarr;</a></div><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
Shaocheng.Li</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a> 强力驱动</p></div><div class="flex flex-row items-center"></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://shaocheng.li/><div id=search-modal class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex flex-none items-center justify-between px-2"><form class="flex min-w-0 flex-auto items-center"><div class="flex h-8 w-8 items-center justify-center text-neutral-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto overflow-auto px-2"><ul id=search-results></ul></section></div></div></div></body></html>