<!doctype html><html lang=zh-Hans dir=Chinese-Simplified class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#FFFFFF"><title>用Qemu搭建Linux和u-boot的调试环境 &#183; Shaocheng.Li</title>
<meta name=title content="用Qemu搭建Linux和u-boot的调试环境 &#183; Shaocheng.Li"><script type=text/javascript src=/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.900ab2ce3e7db5eba67d1f7dae7f22410bddd4cd42fd9cd8ee95ecca31e5564e.css integrity="sha256-kAqyzj59teumfR99rn8iQQvd1M1C/ZzY7pXsyjHlVk4="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.af5d9722112bedac95702865c340bcd6286c4e9b2c15ce26b531ea1fba974cb8.js integrity="sha256-r12XIhEr7ayVcChlw0C81ihsTpssFc4mtTHqH7qXTLg=" data-copy=复制 data-copied=已复制></script><meta name=description content="
      
        
      
    "><link rel=canonical href=https://shaocheng.li/posts/2025/11/05/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://shaocheng.li/posts/2025/11/05/"><meta property="og:site_name" content="Shaocheng.Li"><meta property="og:title" content="用Qemu搭建Linux和u-boot的调试环境"><meta property="og:description" content="LiShaocheng's Blog"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-05T09:42:20+08:00"><meta property="article:modified_time" content="2025-11-05T09:42:20+08:00"><meta property="article:tag" content="Untagged"><meta name=twitter:card content="summary"><meta name=twitter:title content="用Qemu搭建Linux和u-boot的调试环境"><meta name=twitter:description content="LiShaocheng's Blog"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"文章","name":"用Qemu搭建Linux和u-boot的调试环境","headline":"用Qemu搭建Linux和u-boot的调试环境","inLanguage":"zh-Hans","url":"https:\/\/shaocheng.li\/posts\/2025\/11\/05\/","author":{"@type":"Person","name":"Shaocheng.Li"},"copyrightYear":"2025","dateCreated":"2025-11-05T09:42:20\u002b08:00","datePublished":"2025-11-05T09:42:20\u002b08:00","dateModified":"2025-11-05T09:42:20\u002b08:00","keywords":["untagged"],"mainEntityOfPage":"true","wordCount":"1522"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://shaocheng.li/","name":"Shaocheng. Li","position":1},{"@type":"ListItem","item":"https://shaocheng.li/posts/","name":"文章","position":2},{"@type":"ListItem","name":"用 Qemu搭建 Linux和u Boot的调试环境","position":3}]}</script><meta name=author content="Shaocheng.Li"><link href=https://github.com/exbob rel=me></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>跳到主要内容</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Shaocheng.Li</a></div><ul class="flex list-none flex-col text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/posts/ title=文章><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">文章</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/movies/ title=看过的电影><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">观影</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/exercise/ title=运动记录><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">运动</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/share/ title=好物分享><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">好物</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=search-button-1 title="搜索 (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=appearance-switcher-1 type=button aria-label="appearance switcher">
<span class="group-dark:hover:text-primary-400 inline transition-colors group-hover:text-primary-600 dark:hidden" title=切换为深色模式><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span>
</span><span class="group-dark:hover:text-primary-400 hidden transition-colors group-hover:text-primary-600 dark:inline" title=切换为浅色模式><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></span></button></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">用Qemu搭建Linux和u-boot的调试环境</h1><div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2025-11-05 09:42:20 +0800 +0800">2025 十一月 5</time><span class="px-2 text-primary-500">&#183;</span><span>1522 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>8 分钟</span></div></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 lg:sticky lg:top-10 print:hidden"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#1-准备宿主机>1. 准备宿主机</a></li><li><a href=#2-编译linux内核>2. 编译Linux内核</a><ul><li><a href=#21-下载>2.1 下载</a></li><li><a href=#22-配置>2.2 配置</a></li><li><a href=#23-修改配置>2.3 修改配置</a></li><li><a href=#24-编译>2.4 编译</a></li></ul></li><li><a href=#3-编译busybox并生成rootfs>3. 编译BusyBox并生成rootfs</a><ul><li><a href=#31-下载>3.1 下载</a></li><li><a href=#32-配置>3.2 配置</a></li><li><a href=#33-编译>3.3 编译</a></li><li><a href=#34-创建基本的根文件系统>3.4 创建基本的根文件系统</a></li></ul></li><li><a href=#4-用qemu虚拟机启动>4. 用Qemu虚拟机启动</a></li><li><a href=#5-文件共享>5. 文件共享</a></li><li><a href=#6-改用initramfs>6. 改用initramfs</a></li><li><a href=#7-启动u-boot>7. 启动u-boot</a></li></ul></nav></div></details></div></div><div class="min-h-0 min-w-0 max-w-prose grow"><p>用Qemu虚拟机来研究Linux和u-boot有很多好处，可以脱离硬件环境束缚，成本更低，相对于其他虚拟机速度快效率高，调试更方便。缺点是无法模拟实际的硬件外设，主要是研究内部原理。</p><h2 id=1-准备宿主机 class="relative group">1. 准备宿主机 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-%e5%87%86%e5%a4%87%e5%ae%bf%e4%b8%bb%e6%9c%ba aria-label=锚点>#</a></span></h2><p>需要在一个Linux主机上启动Qemu，以 WSL 的 Ubuntu24.04 系统为例，在开始之前，我们需要准备一些必要的工具和库：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt-get install git cmake build-essential bison flex swig python3-dev <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>libssl-dev libncurses-dev libelf-dev bc zstd libtirpc-dev rpcbind libnsl-dev pkgconf
</span></span></code></pre></div><p>安装Qemu虚拟机：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt-get install qemu-system
</span></span></code></pre></div><p>默认安装的Qemu版本是8.2.2：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; qemu-system-x86_64 --version
</span></span><span class=line><span class=cl>QEMU emulator version 8.2.2 <span class=o>(</span>Debian 1:8.2.2+ds-0ubuntu1.10<span class=o>)</span>
</span></span><span class=line><span class=cl>Copyright <span class=o>(</span>c<span class=o>)</span> 2003-2023 Fabrice Bellard and the QEMU Project developers
</span></span></code></pre></div><h2 id=2-编译linux内核 class="relative group">2. 编译Linux内核 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-%e7%bc%96%e8%af%91linux%e5%86%85%e6%a0%b8 aria-label=锚点>#</a></span></h2><p>以 Linux 5.15.193 版本为例。</p><h3 id=21-下载 class="relative group">2.1 下载 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#21-%e4%b8%8b%e8%bd%bd aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5.15.193.tar.gz
</span></span><span class=line><span class=cl>tar -zxvf linux-5.15.193.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> linux-5.15.193
</span></span></code></pre></div><p>下载linux-5.15.193的内核源码，这是一个LTS版本。</p><h3 id=22-配置 class="relative group">2.2 配置 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#22-%e9%85%8d%e7%bd%ae aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ARCH</span><span class=o>=</span>x86
</span></span><span class=line><span class=cl>make <span class=nv>O</span><span class=o>=</span>./build x86_64_defconfig
</span></span></code></pre></div><p>选项参数<code>O=./build</code>表示编译过程生成的文件都输出到<code>./build</code>路径下。我们构建的是x86_64架构的虚拟机，所以要配置<code>ARCH=x86</code>，这样编译系统会在相应架构的路径<code>arch/x86/configs/</code>下找到配置文件<code>x86_64_defconfig</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; ls -l arch/x86/configs/
</span></span><span class=line><span class=cl>total <span class=m>24</span>
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> lsc lsc <span class=m>5970</span> Sep <span class=m>11</span> 23:17 i386_defconfig
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> lsc lsc  <span class=m>147</span> Sep <span class=m>11</span> 23:17 tiny.config
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> lsc lsc <span class=m>5919</span> Sep <span class=m>11</span> 23:17 x86_64_defconfig
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> lsc lsc  <span class=m>744</span> Sep <span class=m>11</span> 23:17 xen.config
</span></span></code></pre></div><h3 id=23-修改配置 class="relative group">2.3 修改配置 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#23-%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 添加RAMDisk支持</span>
</span></span><span class=line><span class=cl>./scripts/config --file ./build/.config --enable CONFIG_BLK_DEV_RAM
</span></span><span class=line><span class=cl>./scripts/config --file ./build/.config --set-val CONFIG_BLK_DEV_RAM_COUNT <span class=m>1</span>
</span></span><span class=line><span class=cl>./scripts/config --file ./build/.config --set-val CONFIG_BLK_DEV_RAM_SIZE <span class=m>65536</span>
</span></span><span class=line><span class=cl>make <span class=nv>O</span><span class=o>=</span>./build olddefconfig
</span></span></code></pre></div><p><code>./scripts/config</code>是Linux内核源码提供的一个实用工具脚本，用于在命令行中修改内核配置文件（通常是<code>.config</code>文件），而无需通过交互式的配置界面（如<code>make menuconfig</code>等）。基本语法是<code>./scripts/config [option] &lt;command></code>，默认修改的是<code>./.config</code>文件，可以用<code>--file</code>选项指定配置文件，常用的命令有：</p><ul><li><code>--enable [option]</code>，将指定的内核配置设为y。</li><li><code>--disable [option]</code>，将指定的内核配置设为n。</li><li><code>--set-val [option] [value]</code>，设置指定内核配置的数值。</li><li><code>--set-str [option] [value]</code>，设置指定内核配置的字符串。</li></ul><p>因为我们要用 ramdisk 启动根文件系统，所以这里要使能内核的RAMdisk设备支持，并设置数量和大小。</p><p>使用<code>./scripts/config</code>就是手动修改<code>.config</code>文件，不会处理依赖关系，所以需要运行<code>make olddefconfig</code>，它会自动启用所有依赖项，解决一些冲突，还会使用默认值填充新的配置选项。</p><h3 id=24-编译 class="relative group">2.4 编译 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#24-%e7%bc%96%e8%af%91 aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make <span class=nv>O</span><span class=o>=</span>./build -j<span class=k>$(</span>nproc<span class=k>)</span>
</span></span></code></pre></div><p>选项<code>-j$(nproc)</code>表示根据CPU核心数量启动并行编译，编译完成后，内核镜像文件位于<code>build/arch/x86/boot/bzImage</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; file build/arch/x86/boot/bzImage
</span></span><span class=line><span class=cl>build/arch/x86/boot/bzImage: Linux kernel x86 boot executable bzImage, version 5.15.193 <span class=o>(</span>lsc@Bob<span class=o>)</span> <span class=c1>#1 SMP Wed Sep 24A</span>
</span></span></code></pre></div><p>bzImage 是一个经过gzip压缩的内核镜像文件。</p><h2 id=3-编译busybox并生成rootfs class="relative group">3. 编译BusyBox并生成rootfs <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3-%e7%bc%96%e8%af%91busybox%e5%b9%b6%e7%94%9f%e6%88%90rootfs aria-label=锚点>#</a></span></h2><p>BusyBox是一个集成了众多Unix工具的单一可执行文件，非常适合构建微型Linux系统。</p><h3 id=31-下载 class="relative group">3.1 下载 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#31-%e4%b8%8b%e8%bd%bd aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://www.busybox.net/downloads/busybox-1.36.1.tar.bz2
</span></span><span class=line><span class=cl>tar -xvf busybox-1.36.1.tar.bz2
</span></span><span class=line><span class=cl><span class=nb>cd</span> busybox-1.36.1
</span></span></code></pre></div><h3 id=32-配置 class="relative group">3.2 配置 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#32-%e9%85%8d%e7%bd%ae aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make defconfig
</span></span></code></pre></div><p>先使用默认配置，然后改为静态编译：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make menuconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Location:                                                                              
</span></span><span class=line><span class=cl>    -&gt; Settings
</span></span><span class=line><span class=cl>        <span class=o>[</span>*<span class=o>]</span> Build static binary <span class=o>(</span>no shared libs<span class=o>)</span>
</span></span></code></pre></div><p>另外注意，在Ubuntu24.04上编译有个<a href=https://lists.busybox.net/pipermail/busybox-cvs/2024-January/041752.html target=_blank rel=noreferrer>Bug 15934</a>，需要禁用<code>CONFIG_TC</code>，否则无法编译通过。</p><h3 id=33-编译 class="relative group">3.3 编译 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#33-%e7%bc%96%e8%af%91 aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make -j<span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=cl>make install
</span></span></code></pre></div><p>编译完成后，生成的安装文件位于<code>_install</code>目录下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; ls -l _install/
</span></span><span class=line><span class=cl>total <span class=m>12</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> lsc lsc <span class=m>4096</span> Sep <span class=m>24</span> 16:50 bin
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> lsc lsc   <span class=m>11</span> Sep <span class=m>24</span> 16:50 linuxrc -&gt; bin/busybox
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> lsc lsc <span class=m>4096</span> Sep <span class=m>24</span> 16:50 sbin
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>4</span> lsc lsc <span class=m>4096</span> Sep <span class=m>24</span> 16:50 usr
</span></span></code></pre></div><h3 id=34-创建基本的根文件系统 class="relative group">3.4 创建基本的根文件系统 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#34-%e5%88%9b%e5%bb%ba%e5%9f%ba%e6%9c%ac%e7%9a%84%e6%a0%b9%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f aria-label=锚点>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> _install
</span></span><span class=line><span class=cl><span class=c1># 新建必要的目录</span>
</span></span><span class=line><span class=cl>mkdir -p etc proc sys mnt dev tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建inittab文件</span>
</span></span><span class=line><span class=cl>cat &gt; etc/inittab <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>::sysinit:/etc/init.d/rcS
</span></span></span><span class=line><span class=cl><span class=s>::respawn:-/bin/sh
</span></span></span><span class=line><span class=cl><span class=s>::askfirst:-/bin/sh
</span></span></span><span class=line><span class=cl><span class=s>::ctrlaltdel:/bin/umount -a -r
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>chmod <span class=m>755</span> etc/inittab
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建启动脚本</span>
</span></span><span class=line><span class=cl>mkdir -p etc/init.d
</span></span><span class=line><span class=cl>cat &gt; etc/init.d/rcS <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=s>/bin/mount -a
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>chmod <span class=m>755</span> etc/init.d/rcS
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建fstab文件</span>
</span></span><span class=line><span class=cl>cat &gt; etc/fstab <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>proc    /proc    proc    defaults    0    0
</span></span></span><span class=line><span class=cl><span class=s>tmpfs   /tmp     tmpfs   defaults    0    0
</span></span></span><span class=line><span class=cl><span class=s>sysfs   /sys     sysfs   defaults    0    0
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>根文件系统的结构可以参考 Filesystem Hierarchy Standard，这是Linux基金会维护的文件系统层次结构标准，最新版本是3.0：<a href=https://refspecs.linuxfoundation.org/FHS_3.0/fhs-3.0.html target=_blank rel=noreferrer>https://refspecs.linuxfoundation.org/FHS_3.0/fhs-3.0.html</a>。主要的几个文件：</p><ul><li><code>etc/inittab</code>，根文件系统启动后第一个执行的是 init 进程，这是 init 进程的核心配置文件，第一行定义了 init 首先要执行 <code>/etc/init.d/rcS</code>，接下来要启动 <code>/bin/sh</code> shell。详细说明可以参考busybox源码的 <code>examples/inittab</code> 文件。</li><li><code>etc/init.d/rcS</code>，这是init 进程执行的第一个脚本，<code>/bin/mount -a</code>命令的作用是挂载<code>/etc/fstab</code>文件中定义的所有文件系统。</li><li><code>etc/fstab</code>，描述了默认的文件系统挂载配置。</li></ul><p>用上面制作的根文件系统生成 ext4 格式的<a href=https://docs.kernel.org/admin-guide/initrd.html target=_blank rel=noreferrer>initial RAM disk (initrd)</a> 镜像：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/zero <span class=nv>of</span><span class=o>=</span>rootfs.ext4 <span class=nv>bs</span><span class=o>=</span>1M <span class=nv>count</span><span class=o>=</span><span class=m>32</span>
</span></span><span class=line><span class=cl>mkfs.ext4 rootfs.ext4
</span></span><span class=line><span class=cl>mkdir rootfs_tmp
</span></span><span class=line><span class=cl>sudo mount -o loop rootfs.ext4 rootfs_tmp
</span></span><span class=line><span class=cl>sudo cp -rf _install/* rootfs_tmp/
</span></span><span class=line><span class=cl>sudo umount rootfs_tmp
</span></span><span class=line><span class=cl>gzip --best -c rootfs.ext4 &gt; rootfs.img.gz
</span></span></code></pre></div><h2 id=4-用qemu虚拟机启动 class="relative group">4. 用Qemu虚拟机启动 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4-%e7%94%a8qemu%e8%99%9a%e6%8b%9f%e6%9c%ba%e5%90%af%e5%8a%a8 aria-label=锚点>#</a></span></h2><p>至此，我们已经准备好了内核镜像 bzImage 和根文件系统镜像 rootfs.img.gz，可以使用Qemu启动我们的微型Linux系统了：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qemu-system-x86_64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-name kardel <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-smp <span class=m>2</span> -m <span class=m>1024</span> -nographic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-kernel ./bzImage <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-initrd ./rootfs.img.gz <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-append <span class=s2>&#34;root=/dev/ram rw rootfstype=ext4 console=ttyS0 init=/sbin/init&#34;</span>
</span></span></code></pre></div><ul><li><code>-name</code> 定义了虚拟机的名字</li><li><code>-smp 2 -m 1024 -nographic</code> 是虚拟机的硬件配置，表示2个CPU核，1024M内存，没有图形界面，使用文本控制台。</li><li><code>-kernel</code> 定义了使用的内核文件，这个配置会跳过BIOS/UEFI启动过程，直接启动内核。</li><li><code>-initrd</code> 指定了初始RAM磁盘文件（init RAM Disk），initrd是在启动阶段被Linux内核调用的临时文件系统，用于根目录被挂载之前的准备工作，我们直接用它来研究Linux比较简单。</li><li><code>-append</code> 定义了内核启动参数字符串：<ul><li><code>root=/dev/ram</code>表示用<code>/dev/ram</code>作为挂载根文件系统的设备，内核将压缩的ext4镜像解压到RAM Disk设备</li><li><code>console=ttyS0</code> 定义了控制台输出到串口0（配合-nographic使用）</li><li><code>init=/sbin/init</code> 定义了init进程。传统的 initrd (Initial RAM Disk) 系统会默认执行 <code>/linuxrc</code> 作为临时初始化脚本进行过渡，执行完毕后，内核会尝试加载真正的rootfs并执行init进程，现在已经基本废弃这种方式。我们直接定义 <code>/sbin/init</code> 为系统启动后的第一个进程，内核会将 <code>/sbin/init</code> 启动为 PID 1，会一直运行，不会再进行根文件系统切换的特殊处理。</li></ul></li></ul><p>启动后的Qemu虚拟机：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>    2.819865<span class=o>]</span> devtmpfs: mounted
</span></span><span class=line><span class=cl><span class=o>[</span>    2.903966<span class=o>]</span> Freeing unused kernel image <span class=o>(</span>initmem<span class=o>)</span> memory: 1488K
</span></span><span class=line><span class=cl><span class=o>[</span>    2.904265<span class=o>]</span> Write protecting the kernel read-only data: 24576k
</span></span><span class=line><span class=cl><span class=o>[</span>    2.907148<span class=o>]</span> Freeing unused kernel image <span class=o>(</span>text/rodata gap<span class=o>)</span> memory: 2032K
</span></span><span class=line><span class=cl><span class=o>[</span>    2.908811<span class=o>]</span> Freeing unused kernel image <span class=o>(</span>rodata/data gap<span class=o>)</span> memory: 1292K
</span></span><span class=line><span class=cl><span class=o>[</span>    2.909390<span class=o>]</span> Run /sbin/init as init process
</span></span><span class=line><span class=cl><span class=o>[</span>    3.046032<span class=o>]</span> mount <span class=o>(</span>79<span class=o>)</span> used greatest stack depth: <span class=m>14272</span> bytes left
</span></span><span class=line><span class=cl><span class=o>[</span>    3.050250<span class=o>]</span> rcS <span class=o>(</span>78<span class=o>)</span> used greatest stack depth: <span class=m>14128</span> bytes left
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please press Enter to activate this console.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>~ <span class=c1># poweroff</span>
</span></span><span class=line><span class=cl>The system is going down NOW!
</span></span><span class=line><span class=cl>Sent SIGTERM to all processes
</span></span><span class=line><span class=cl>Sent SIGKILL to all processes
</span></span><span class=line><span class=cl>Requesting system poweroff
</span></span><span class=line><span class=cl><span class=o>[</span>  305.271084<span class=o>]</span> sh <span class=o>(</span>80<span class=o>)</span> used greatest stack depth: <span class=m>13960</span> bytes left
</span></span><span class=line><span class=cl><span class=o>[</span>  306.527946<span class=o>]</span> ACPI: PM: Preparing to enter system sleep state S5
</span></span><span class=line><span class=cl><span class=o>[</span>  306.534926<span class=o>]</span> reboot: Power down
</span></span></code></pre></div><p>可以执行 <code>poweroff</code> 命令关机，如果要直接关闭 Qemu 虚拟机，可以按下组合键<code>Ctrl+a</code>，然后按 <code>x</code> 键。</p><p>启动后，可以查看文件系统挂载情况符合 <code>/etc/fstab</code> 的配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>~ <span class=c1># df -a</span>
</span></span><span class=line><span class=cl>Filesystem           1K-blocks      Used Available Use% Mounted on
</span></span><span class=line><span class=cl>/dev/root                <span class=m>26596</span>      <span class=m>2496</span>     <span class=m>21812</span>  10% /
</span></span><span class=line><span class=cl>devtmpfs                <span class=m>495408</span>         <span class=m>0</span>    <span class=m>495408</span>   0% /dev
</span></span><span class=line><span class=cl>proc                         <span class=m>0</span>         <span class=m>0</span>         <span class=m>0</span>   0% /proc
</span></span><span class=line><span class=cl>tmpfs                   <span class=m>498472</span>         <span class=m>0</span>    <span class=m>498472</span>   0% /tmp
</span></span><span class=line><span class=cl>sysfs                        <span class=m>0</span>         <span class=m>0</span>         <span class=m>0</span>   0% /sys
</span></span></code></pre></div><p>但是，<code>/dev</code> 目录的自动挂载是Linux内核的内置机制，不需要在 <code>/etc/fstab</code> 中配置。还会发现，命令行参数配置的是<code>root=/dev/ram</code>，但是系统只有<code>/dev/ram0</code>设备，没有 <code>/dev/ram</code> 也没有 <code>/dev/root</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>~ <span class=c1># ls -l /dev/ram*</span>
</span></span><span class=line><span class=cl>brw-------    <span class=m>1</span> <span class=m>0</span>        <span class=m>0</span>           1,   <span class=m>0</span> Sep <span class=m>25</span> 01:27 /dev/ram0
</span></span><span class=line><span class=cl>~ <span class=c1># ls /dev/root</span>
</span></span><span class=line><span class=cl>ls: /dev/root: No such file or directory
</span></span></code></pre></div><p>这是因为内核历史问题和兼容性考虑，启动时，如果命令行参数中指定 <code>root=/dev/ram</code> ，内核会自动将其内部转换为 <code>root=/dev/ram0</code> ，直接设置 <code>root=/dev/ram0</code> 也可以。而显示时，无论实际设备是什么，都会显示<code>/dev/root</code>，用于表示"当前的根文件系统设备"。内核解析过程：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>用户指定: <span class=nv>root</span><span class=o>=</span>/dev/ram
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>内核解析: /dev/ram → /dev/ram0 <span class=o>(</span>主设备号1，次设备号0<span class=o>)</span>
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>内核挂载: 实际挂载 /dev/ram0 作为根文件系统
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>显示名称: 在用户空间显示为 /dev/root
</span></span></code></pre></div><h2 id=5-文件共享 class="relative group">5. 文件共享 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5-%e6%96%87%e4%bb%b6%e5%85%b1%e4%ba%ab aria-label=锚点>#</a></span></h2><p>调试过程中，需要在主机和Qemu虚拟机之间进行文件传输，可选的方式很多，使用 9P virtio 较为方便，这是一种网络文件系统，可以在虚拟机里挂载主机的共享目录，实现文件共享。</p><p>首先要在内核配置中添加 9P virtio 支持：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./scripts/config --file ./build/.config --enable CONFIG_FUSE_FS
</span></span><span class=line><span class=cl>./scripts/config --file ./build/.config --enable CONFIG_VIRTIO_FS
</span></span><span class=line><span class=cl>./scripts/config --file ./build/.config --enable CONFIG_VIRTIO_PCI
</span></span><span class=line><span class=cl>./scripts/config --file ./build/.config --enable CONFIG_NET_9P
</span></span><span class=line><span class=cl>./scripts/config --file ./build/.config --enable CONFIG_NET_9P_VIRTIO
</span></span><span class=line><span class=cl>./scripts/config --file ./build/.config --enable CONFIG_9P_FS
</span></span><span class=line><span class=cl>./scripts/config --file ./build/.config --enable CONFIG_9P_FS_POSIX_ACL
</span></span></code></pre></div><p>启动 Qemu 虚拟机是添加相关参数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>-fsdev local,security_model<span class=o>=</span>none,id<span class=o>=</span>fsdev0,path<span class=o>=</span><span class=si>${</span><span class=nv>HOST_SHARE_PATH</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-device virtio-9p-pci,fsdev<span class=o>=</span>fsdev0,mount_tag<span class=o>=</span>hostshare
</span></span></code></pre></div><p>参数 <code>path=${HOST_SHARE_PATH}</code> 定义了主机的共享目录，可以自定义。这样启动系统后，可以将共享目录挂载到虚拟机的 <code>/mnt</code> 路径下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>~ <span class=c1># mount -t 9p -o trans=virtio,version=9p2000.L hostshare /mnt</span>
</span></span><span class=line><span class=cl>~ <span class=c1># df</span>
</span></span><span class=line><span class=cl>Filesystem           1K-blocks      Used Available Use% Mounted on
</span></span><span class=line><span class=cl>/dev/root                <span class=m>27620</span>      <span class=m>2736</span>     <span class=m>22596</span>  11% /
</span></span><span class=line><span class=cl>devtmpfs                <span class=m>495340</span>         <span class=m>0</span>    <span class=m>495340</span>   0% /dev
</span></span><span class=line><span class=cl>tmpfs                   <span class=m>498436</span>         <span class=m>0</span>    <span class=m>498436</span>   0% /tmp
</span></span><span class=line><span class=cl>hostshare            <span class=m>1055762784</span>  <span class=m>78147900</span> <span class=m>923911352</span>   8% /mnt
</span></span></code></pre></div><h2 id=6-改用initramfs class="relative group">6. 改用initramfs <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#6-%e6%94%b9%e7%94%a8initramfs aria-label=锚点>#</a></span></h2><p>Linux内核支持的rootfs启动介质类似非常多，常用的包括：</p><ol><li>传统块设备，例如硬盘<code>root=/dev/sda1</code>,eMMC/SD卡<code>root=/dev/mmcblk0p1</code>。</li><li>网络文件系统，<code>root=/dev/nfs</code></li><li>RamDisk设备，<code>root=/dev/ram</code></li></ol><p>我们用的RamDisk设备，属于传统的 initrd 镜像，需要块设备和文件系统（ext4）支持，制作方式比较复杂，且大小固定，需要分配固定大小的内存，使用时内核需要挂载整个块设备，启动流程也比较复杂：</p><pre tabindex=0><code>内核启动 → 加载initrd到/dev/ram → 挂载/dev/ram → 执行/sbin/init → 读取/etc/inittab
</code></pre><p>从 Linux 2.6.13 开始，内核支持 <a href=https://docs.kernel.org/filesystems/ramfs-rootfs-initramfs.html target=_blank rel=noreferrer>initramfs</a> 启动，它以ramfs技术为基础，rootfs存储在cpio格式的压缩包里，启动时直接解压到内存，没有文件系统开销，作为临时过渡的rootfs，启动过程简单直接，速度更快：</p><pre tabindex=0><code>内核启动 → 解压initramfs到内存 → 直接执行/init
</code></pre><p>要使用initramfs，需要使能内核支持：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./scripts/config --file ./build/.config --enable CONFIG_INITRAMFS_SOURCE
</span></span><span class=line><span class=cl>./scripts/config --file ./build/.config --enable CONFIG_INITRAMFS_COMPRESSION_GZIP
</span></span><span class=line><span class=cl><span class=c1># 可以关闭 RAMDisk 支持，不需要。</span>
</span></span><span class=line><span class=cl><span class=c1># ./scripts/config --file ./build/.config --disable CONFIG_BLK_DEV_RAM</span>
</span></span><span class=line><span class=cl>make <span class=nv>O</span><span class=o>=</span>./build olddefconfig
</span></span></code></pre></div><p>然后做一个最简单的initramfs镜像：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 新建一个HelloWord程序，编译为 init 可执行文件，因为内核对于initramfs会默认从/init启动</span>
</span></span><span class=line><span class=cl>cat &gt; hello.c <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>#include &lt;stdio.h&gt;
</span></span></span><span class=line><span class=cl><span class=s>#include &lt;unistd.h&gt;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>int main(int argc, char *argv[])
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  printf(&#34;Hello world!\n&#34;);
</span></span></span><span class=line><span class=cl><span class=s>  sleep(999999999);
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>gcc -static hello.c -o init
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成 cpio 格式的压缩包</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> init <span class=p>|</span> cpio -o -H newc <span class=p>|</span> gzip &gt; test.cpio.gz
</span></span></code></pre></div><p>启动虚拟机：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qemu-system-x86_64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-name kardel <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-smp <span class=m>2</span> -m <span class=m>1024</span> -nographic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-kernel ./bzImage <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-initrd ./test.cpio.gz <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-append <span class=s2>&#34;rw rootfstype=ramfs console=ttyS0&#34;</span>
</span></span></code></pre></div><p>因为内核默认使能了<code>CONFIG_TMPFS</code>，所以必须在命令行参数中定义rootfs的类型<code>rootfstype=ramfs</code>，否则会默认为tmpfs，导致无法启动。命令行参数没有设置 init，内核就会默认启动 <code>/init</code> 程序：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>    2.375607<span class=o>]</span> Freeing unused kernel image <span class=o>(</span>initmem<span class=o>)</span> memory: 1488K
</span></span><span class=line><span class=cl><span class=o>[</span>    2.376463<span class=o>]</span> Write protecting the kernel read-only data: 24576k
</span></span><span class=line><span class=cl><span class=o>[</span>    2.380567<span class=o>]</span> Freeing unused kernel image <span class=o>(</span>text/rodata gap<span class=o>)</span> memory: 2032K
</span></span><span class=line><span class=cl><span class=o>[</span>    2.382223<span class=o>]</span> Freeing unused kernel image <span class=o>(</span>rodata/data gap<span class=o>)</span> memory: 1292K
</span></span><span class=line><span class=cl><span class=o>[</span>    2.382931<span class=o>]</span> Run /init as init process
</span></span><span class=line><span class=cl>Hello world!
</span></span></code></pre></div><p>因为没有启动Shell，无法进行任何操作。下面用busybox制作一个initramfs镜像。</p><p>编译busybox的方式不变，还是在 <code>_install/</code> 下制作基本的根文件系统，需要修改 <code>etc/fstab</code> 文件，加入devtmpfs挂载配置。这是因为initrd (Initial RAM Disk)是一个真正的文件系统镜像（通常是ext2/ext4/cramfs），内核会将其挂载为块设备，系统启动时，内核会自动创建基本的设备节点。而initramfs(Initial RAM File System)只是一个cpio 归档，直接解压到内存中运行，没有块设备概念，是纯内存文件系统，内核不会自动创建设备节点。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建fstab文件</span>
</span></span><span class=line><span class=cl>cat &gt; etc/fstab <span class=s>&lt;&lt; EOF
</span></span></span><span class=line><span class=cl><span class=s>proc    /proc    proc    defaults    0    0
</span></span></span><span class=line><span class=cl><span class=s>tmpfs   /tmp     tmpfs   defaults    0    0
</span></span></span><span class=line><span class=cl><span class=s>sysfs   /sys     sysfs   defaults    0    0
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><p>然后改变最后的打包方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> _install/
</span></span><span class=line><span class=cl>find . <span class=p>|</span> cpio -o -H newc <span class=p>|</span> gzip &gt; ../../rootfs.cpio.gz
</span></span></code></pre></div><p>启动虚拟机时，需要修改命令行参数。改用<code>rdinit=</code>指定 init 程序，这个选项专用指定initramfs/initrd中的 init 程序，而<code>init=</code>参数用于指定根文件系统挂载后的init程序，initramfs没有挂载的过程，会找不到程序：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>qemu-system-x86_64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-name kardel <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-smp <span class=m>2</span> -m <span class=m>1024</span> -nographic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-kernel ./bzImage <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-initrd ./rootfs.cpio.gz <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-append <span class=s2>&#34;rw rootfstype=ramfs console=ttyS0 rdinit=/sbin/init&#34;</span>
</span></span></code></pre></div><p>启动正常：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>    2.539957<span class=o>]</span> Run /sbin/init as init process
</span></span><span class=line><span class=cl><span class=o>[</span>    2.608081<span class=o>]</span> mount <span class=o>(</span>76<span class=o>)</span> used greatest stack depth: <span class=m>14696</span> bytes left
</span></span><span class=line><span class=cl><span class=o>[</span>    2.617947<span class=o>]</span> rcS <span class=o>(</span>75<span class=o>)</span> used greatest stack depth: <span class=m>14640</span> bytes left
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please press Enter to activate this console. 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>~ <span class=c1># df -a</span>
</span></span><span class=line><span class=cl>Filesystem           1K-blocks      Used Available Use% Mounted on
</span></span><span class=line><span class=cl>none                         <span class=m>0</span>         <span class=m>0</span>         <span class=m>0</span>   0% /
</span></span><span class=line><span class=cl>proc                         <span class=m>0</span>         <span class=m>0</span>         <span class=m>0</span>   0% /proc
</span></span><span class=line><span class=cl>tmpfs                   <span class=m>498472</span>         <span class=m>0</span>    <span class=m>498472</span>   0% /tmp
</span></span><span class=line><span class=cl>sysfs                        <span class=m>0</span>         <span class=m>0</span>         <span class=m>0</span>   0% /sys
</span></span><span class=line><span class=cl>devtmpfs                <span class=m>495428</span>         <span class=m>0</span>    <span class=m>495428</span>   0% /dev
</span></span></code></pre></div><p>更多关于Linux启动方式的早期历史，可以参考initrd和LILO作者的文章：<a href=https://www.almesberger.net/cv/papers/ols2k-9.pdf target=_blank rel=noreferrer>https://www.almesberger.net/cv/papers/ols2k-9.pdf</a></p><h2 id=7-启动u-boot class="relative group">7. 启动u-boot <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#7-%e5%90%af%e5%8a%a8u-boot aria-label=锚点>#</a></span></h2><p>假设已经生成了内核文件 bzImage 和初始化 RAMDisk 文件 rootfs.img.gz，下面介绍如何使用Qemu虚拟机启动 u-boot。</p><p>首先从 u-boot 的官网 <a href=https://u-boot.org/ target=_blank rel=noreferrer>https://u-boot.org/</a> 获取源码。我们下载了u-boot-v2024.04.tar.bz2，然后解压：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; tar xvf u-boot-v2024.04.tar.bz2
</span></span><span class=line><span class=cl>&gt; <span class=nb>cd</span> u-boot-v2024.04
</span></span><span class=line><span class=cl>&gt; ls
</span></span><span class=line><span class=cl>Kbuild       Makefile  board   config.mk  drivers   fs       post
</span></span><span class=line><span class=cl>Kconfig      README    boot    configs    dts       include  scripts
</span></span><span class=line><span class=cl>Licenses     api       cmd     disk       env       lib      <span class=nb>test</span>
</span></span><span class=line><span class=cl>MAINTAINERS  arch      common  doc        examples  net      tools
</span></span></code></pre></div><p>直接使用默认的适配Qemu-X86_64虚拟机的配置，然后编译：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make qemu-x86_64_defconfig
</span></span><span class=line><span class=cl>make
</span></span></code></pre></div><p>生成u-boot.rom文件用于Qemu启动，使用<code>-bios</code>选项指定u-boot文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; qemu-system-x86_64 -smp <span class=m>2</span> -m <span class=m>1024</span> -nographic -bios ./u-boot.rom
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>U-Boot SPL 2024.04 <span class=o>(</span>Sep <span class=m>26</span> <span class=m>2025</span> - 16:54:54 +0800<span class=o>)</span>
</span></span><span class=line><span class=cl>Video: 1024x768x32
</span></span><span class=line><span class=cl>Trying to boot from SPI
</span></span><span class=line><span class=cl>Jumping to 64-bit U-Boot: Note many features are missing
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>U-Boot 2024.04 <span class=o>(</span>Sep <span class=m>26</span> <span class=m>2025</span> - 16:54:54 +0800<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>CPU:   QEMU Virtual CPU version 2.5+
</span></span><span class=line><span class=cl>DRAM:  <span class=m>1</span> GiB
</span></span><span class=line><span class=cl>Core:  <span class=m>20</span> devices, <span class=m>13</span> uclasses, devicetree: separate
</span></span><span class=line><span class=cl>Loading Environment from nowhere... OK
</span></span><span class=line><span class=cl>Video: 1024x768x0
</span></span><span class=line><span class=cl>Model: QEMU x86 <span class=o>(</span>I440FX<span class=o>)</span>
</span></span><span class=line><span class=cl>Net:   e1000: 52:54:00:12:34:56
</span></span><span class=line><span class=cl>       eth0: e1000#0
</span></span><span class=line><span class=cl>Hit any key to stop autoboot:  <span class=m>0</span>
</span></span></code></pre></div><p>此时已经可以启动u-boot并调试。如果要启动Linux系统，还要指定kernel和initrd文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; qemu-system-x86_64 -smp <span class=m>2</span> -m <span class=m>1024</span> -nographic -bios ./u-boot.rom -kernel ../bzImage -initrd ../rootfs.img.gz
</span></span></code></pre></div><p>启动后进入u-boot，查看变量：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span>&gt; env print
</span></span><span class=line><span class=cl><span class=nv>arch</span><span class=o>=</span>x86
</span></span><span class=line><span class=cl><span class=nv>baudrate</span><span class=o>=</span><span class=m>115200</span>
</span></span><span class=line><span class=cl><span class=nv>board</span><span class=o>=</span>qemu-x86
</span></span><span class=line><span class=cl><span class=nv>board_name</span><span class=o>=</span>qemu-x86
</span></span><span class=line><span class=cl><span class=nv>bootargs</span><span class=o>=</span><span class=nv>root</span><span class=o>=</span>/dev/sdb3 <span class=nv>init</span><span class=o>=</span>/sbin/init rootwait ro
</span></span><span class=line><span class=cl><span class=nv>bootcmd</span><span class=o>=</span>bootflow scan -lb
</span></span><span class=line><span class=cl><span class=nv>bootdelay</span><span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl><span class=nv>bootp_arch</span><span class=o>=</span><span class=m>6</span>
</span></span><span class=line><span class=cl><span class=nv>bootp_vci</span><span class=o>=</span>PXEClient:Arch:00006:UNDI:003000
</span></span><span class=line><span class=cl><span class=nv>consoledev</span><span class=o>=</span>ttyS0
</span></span><span class=line><span class=cl><span class=nv>dnsip</span><span class=o>=</span>10.0.2.3
</span></span><span class=line><span class=cl><span class=nv>ethact</span><span class=o>=</span>e1000#0
</span></span><span class=line><span class=cl><span class=nv>ethaddr</span><span class=o>=</span>52:54:00:12:34:56
</span></span><span class=line><span class=cl><span class=nv>fdtcontroladdr</span><span class=o>=</span>3ecf9df0
</span></span><span class=line><span class=cl><span class=nv>filesize</span><span class=o>=</span>1497e7
</span></span><span class=line><span class=cl><span class=nv>gatewayip</span><span class=o>=</span>10.0.2.2
</span></span><span class=line><span class=cl><span class=nv>hostname</span><span class=o>=</span>x86
</span></span><span class=line><span class=cl><span class=nv>ipaddr</span><span class=o>=</span>10.0.2.15
</span></span><span class=line><span class=cl><span class=nv>kernel_addr_r</span><span class=o>=</span>0x1000000
</span></span><span class=line><span class=cl><span class=nv>loadaddr</span><span class=o>=</span>0x02000000
</span></span><span class=line><span class=cl><span class=nv>netdev</span><span class=o>=</span>eth0
</span></span><span class=line><span class=cl><span class=nv>netmask</span><span class=o>=</span>255.255.255.0
</span></span><span class=line><span class=cl><span class=nv>pciconfighost</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>ramdisk_addr_r</span><span class=o>=</span>0x4000000
</span></span><span class=line><span class=cl><span class=nv>ramdiskfile</span><span class=o>=</span>initramfs.gz
</span></span><span class=line><span class=cl><span class=nv>rootpath</span><span class=o>=</span>/opt/nfsroot
</span></span><span class=line><span class=cl><span class=nv>scriptaddr</span><span class=o>=</span>0x7000000
</span></span><span class=line><span class=cl><span class=nv>serverip</span><span class=o>=</span>10.0.2.2
</span></span><span class=line><span class=cl><span class=nv>soc</span><span class=o>=</span>qemu
</span></span><span class=line><span class=cl><span class=nv>stderr</span><span class=o>=</span>serial,vidconsole
</span></span><span class=line><span class=cl><span class=nv>stdin</span><span class=o>=</span>serial,i8042-kbd,usbkbd
</span></span><span class=line><span class=cl><span class=nv>stdout</span><span class=o>=</span>serial,vidconsole
</span></span><span class=line><span class=cl><span class=nv>vendor</span><span class=o>=</span>emulation
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Environment size: 680/262140 bytes
</span></span></code></pre></div><p>注意打印出的几个env变量：</p><ul><li>bootargs是传递给内核的命令行参数，用于内核启动rootfs。</li><li>bootcmd是u-boot启动内核的命令。</li><li>kernel_addr_r是u-boot加载内核文件的内存地址。</li><li>ramdisk_addr_r是u-boot加载initrd文件的内存地址。</li><li>filesize=1497e7是initrd文件的大小</li></ul><p>先设置bootargs，内核启动时需要到的命令行参数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span>&gt; setenv bootargs <span class=s2>&#34;root=/dev/ram rw rootfstype=ext4 console=ttyS0 init=/sbin/init&#34;</span>
</span></span><span class=line><span class=cl><span class=o>=</span>&gt; env print bootargs
</span></span><span class=line><span class=cl><span class=nv>bootargs</span><span class=o>=</span><span class=nv>root</span><span class=o>=</span>/dev/ram rw <span class=nv>rootfstype</span><span class=o>=</span>ext4 <span class=nv>console</span><span class=o>=</span>ttyS0 <span class=nv>init</span><span class=o>=</span>/sbin/init
</span></span></code></pre></div><p>然后手动执行启动命令，先用qfw命令将kernle和initrd文件加载到内存，这是u-boot用于向QEMU虚拟机加载固件的接口：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span>&gt; qfw load <span class=si>${</span><span class=nv>kernel_addr_r</span><span class=si>}</span> <span class=si>${</span><span class=nv>ramdisk_addr_r</span><span class=si>}</span><span class=p>;</span>
</span></span><span class=line><span class=cl>loading kernel to address <span class=m>1000000</span> size a27980 initrd <span class=m>4000000</span> size 1497e7
</span></span></code></pre></div><p>可以看到，qfw会自动计算并打印出加载的内存地址和大小，然后用zboot命令启动内核：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>=</span>&gt; zboot <span class=si>${</span><span class=nv>kernel_addr_r</span><span class=si>}</span> a27980 <span class=si>${</span><span class=nv>ramdisk_addr_r</span><span class=si>}</span> 1497e7
</span></span><span class=line><span class=cl>Valid Boot Flag
</span></span><span class=line><span class=cl>Magic signature found
</span></span><span class=line><span class=cl>Linux kernel version 5.15.193 <span class=o>(</span>lsc@Bob<span class=o>)</span> <span class=c1>#3 SMP Thu Sep 25 15:17:20 CST 2025</span>
</span></span><span class=line><span class=cl>Building boot_params at 0x00090000
</span></span><span class=line><span class=cl>Loading bzImage at address <span class=m>100000</span> <span class=o>(</span><span class=m>10647936</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>Initial RAM disk at linear address 0x04000000, size <span class=m>1349607</span> bytes
</span></span><span class=line><span class=cl>Kernel <span class=nb>command</span> line: <span class=s2>&#34;root=/dev/ram rw rootfstype=ext4 console=ttyS0 init=/sbin/init&#34;</span>
</span></span><span class=line><span class=cl>Kernel loaded at 00100000, <span class=nv>setup_base</span><span class=o>=</span><span class=m>0000000000090000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Starting kernel ...
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=o>[</span>    3.194519<span class=o>]</span> Run /sbin/init as init process
</span></span><span class=line><span class=cl><span class=o>[</span>    3.320081<span class=o>]</span> mount <span class=o>(</span>80<span class=o>)</span> used greatest stack depth: <span class=m>14240</span> bytes left
</span></span><span class=line><span class=cl><span class=o>[</span>    3.326269<span class=o>]</span> rcS <span class=o>(</span>79<span class=o>)</span> used greatest stack depth: <span class=m>13664</span> bytes left
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please press Enter to activate this console.
</span></span></code></pre></div><p>也可以在编译前配置bootargs和bootcmd两个变量，这样启动虚拟机后，u-boot会自动加载并启动内核：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; make menuconfig
</span></span><span class=line><span class=cl>Boot options  ---&gt;
</span></span><span class=line><span class=cl>    <span class=o>[</span>*<span class=o>]</span> Enable boot arguments                                                
</span></span><span class=line><span class=cl>        <span class=o>(</span><span class=nv>root</span><span class=o>=</span>/dev/ram rw <span class=nv>rootfstype</span><span class=o>=</span>ext4 <span class=nv>console</span><span class=o>=</span>ttyS0 <span class=nv>init</span><span class=o>=</span>/sbin/init<span class=o>)</span> Boot arg
</span></span><span class=line><span class=cl>    <span class=o>[</span>*<span class=o>]</span> Enable a default value <span class=k>for</span> bootcmd
</span></span><span class=line><span class=cl>        <span class=o>(</span>qfw load <span class=si>${</span><span class=nv>kernel_addr_r</span><span class=si>}</span> <span class=si>${</span><span class=nv>ramdisk_addr_r</span><span class=si>}</span><span class=p>;</span> zboot <span class=si>${</span><span class=nv>kernel_addr_r</span><span class=si>}</span> - <span class=si>${</span><span class=nv>ramdisk_addr_r</span><span class=si>}</span> <span class=si>${</span><span class=nv>filesize</span><span class=si>}</span><span class=o>)</span>
</span></span><span class=line><span class=cl>&gt; make
</span></span><span class=line><span class=cl>&gt; qemu-system-x86_64 -smp <span class=m>2</span> -m <span class=m>1024</span> -nographic -bios ./u-boot.rom -kernel ../bzImage -initrd ../rootfs.img.gz
</span></span></code></pre></div><p>更多在x86平台使用u-boot的资料可以参考官方文档：</p><ul><li><a href=https://docs.u-boot.org/en/stable/board/emulation/qemu-x86.html target=_blank rel=noreferrer>https://docs.u-boot.org/en/stable/board/emulation/qemu-x86.html</a></li><li><a href=https://docs.u-boot.org/en/v2024.04/usage/fit/x86-fit-boot.html target=_blank rel=noreferrer>https://docs.u-boot.org/en/v2024.04/usage/fit/x86-fit-boot.html</a></li><li><a href=https://docs.u-boot.org/en/v2024.04/arch/x86/manual_boot.html target=_blank rel=noreferrer>https://docs.u-boot.org/en/v2024.04/arch/x86/manual_boot.html</a></li></ul></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=flex><picture class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full"><img width=568 height=568 class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full" alt=Shaocheng.Li loading=lazy decoding=async src=/img/author.png></picture><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Shaocheng.Li</div><div class="text-sm text-neutral-700 dark:text-neutral-400">A Linux software engineer.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/exbob target=_blank aria-label=Github rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/2025/09/11/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">使用LGPLv3许可证开发Qt闭源软件的研究</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2025-09-11 08:41:59 +0800 +0800">2025 九月 11</time>
</span></span></a></span><span></span></div></div></footer></article></main><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12" id=to-top hidden=true><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=回到顶部 title=回到顶部>&uarr;</a></div><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
Shaocheng.Li</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a> 强力驱动</p></div><div class="flex flex-row items-center"></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://shaocheng.li/><div id=search-modal class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex flex-none items-center justify-between px-2"><form class="flex min-w-0 flex-auto items-center"><div class="flex h-8 w-8 items-center justify-center text-neutral-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto overflow-auto px-2"><ul id=search-results></ul></section></div></div></div></body></html>