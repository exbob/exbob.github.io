<!doctype html><html lang=zh-Hans dir=Chinese-Simplified class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#FFFFFF"><title>基于虚拟机的 Yocto 入门笔记 &#183; Shaocheng.Li</title>
<meta name=title content="基于虚拟机的 Yocto 入门笔记 &#183; Shaocheng.Li"><script type=text/javascript src=/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.900ab2ce3e7db5eba67d1f7dae7f22410bddd4cd42fd9cd8ee95ecca31e5564e.css integrity="sha256-kAqyzj59teumfR99rn8iQQvd1M1C/ZzY7pXsyjHlVk4="><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.af5d9722112bedac95702865c340bcd6286c4e9b2c15ce26b531ea1fba974cb8.js integrity="sha256-r12XIhEr7ayVcChlw0C81ihsTpssFc4mtTHqH7qXTLg=" data-copy=复制 data-copied=已复制></script><meta name=description content="
      
        
      
    "><link rel=canonical href=https://shaocheng.li/posts/2023/12/30/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://shaocheng.li/posts/2023/12/30/"><meta property="og:site_name" content="Shaocheng.Li"><meta property="og:title" content="基于虚拟机的 Yocto 入门笔记"><meta property="og:description" content="LiShaocheng's Blog"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-30T20:34:49+08:00"><meta property="article:modified_time" content="2023-12-30T20:34:49+08:00"><meta property="article:tag" content="Untagged"><meta name=twitter:card content="summary"><meta name=twitter:title content="基于虚拟机的 Yocto 入门笔记"><meta name=twitter:description content="LiShaocheng's Blog"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"文章","name":"基于虚拟机的 Yocto 入门笔记","headline":"基于虚拟机的 Yocto 入门笔记","inLanguage":"zh-Hans","url":"https:\/\/shaocheng.li\/posts\/2023\/12\/30\/","author":{"@type":"Person","name":"Shaocheng.Li"},"copyrightYear":"2023","dateCreated":"2023-12-30T20:34:49\u002b08:00","datePublished":"2023-12-30T20:34:49\u002b08:00","dateModified":"2023-12-30T20:34:49\u002b08:00","keywords":["untagged"],"mainEntityOfPage":"true","wordCount":"3224"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://shaocheng.li/","name":"Shaocheng. Li","position":1},{"@type":"ListItem","item":"https://shaocheng.li/posts/","name":"文章","position":2},{"@type":"ListItem","name":"基于虚拟机的 Yocto 入门笔记","position":3}]}</script><meta name=author content="Shaocheng.Li"><link href=https://github.com/exbob rel=me></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>跳到主要内容</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Shaocheng.Li</a></div><ul class="flex list-none flex-col text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/posts/ title=文章><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">文章</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/projects/ title=做过的项目><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">项目</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/movies/ title=看过的电影><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">观影</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/exercise/ title=运动记录><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">运动</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/share/ title=好物分享><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">好物</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=search-button-1 title="搜索 (/)">
<span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></button></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><button id=appearance-switcher-1 type=button aria-label="appearance switcher">
<span class="group-dark:hover:text-primary-400 inline transition-colors group-hover:text-primary-600 dark:hidden" title=切换为深色模式><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span>
</span><span class="group-dark:hover:text-primary-400 hidden transition-colors group-hover:text-primary-600 dark:inline" title=切换为浅色模式><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg>
</span><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></span></button></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">基于虚拟机的 Yocto 入门笔记</h1><div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2023-12-30 20:34:49 +0800 +0800">2023 十二月 30</time><span class="px-2 text-primary-500">&#183;</span><span>3224 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>16 分钟</span></div></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8"><div class="toc pe-5 lg:sticky lg:top-10 print:hidden"><details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5"><summary class="block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">目录</summary><div class="border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#1-前言>1. 前言</a></li><li><a href=#2-快速开始>2. 快速开始</a><ul><li><a href=#21-宿主机>2.1 宿主机</a></li><li><a href=#22-获取源码>2.2 获取源码</a></li><li><a href=#23-开始构建>2.3 开始构建</a></li></ul></li><li><a href=#3-解析工作流>3. 解析工作流</a></li><li><a href=#4-基础定制>4. 基础定制</a><ul><li><a href=#41-新建layer>4.1 新建layer</a></li><li><a href=#42-添加软件包>4.2 添加软件包</a></li><li><a href=#43-设置hostname>4.3 设置hostname</a></li><li><a href=#44-新建一个recipe>4.4 新建一个recipe</a></li><li><a href=#45-使用packagegroup>4.5 使用packagegroup</a></li><li><a href=#46-修改欢迎信息>4.6 修改欢迎信息</a></li><li><a href=#47-生成sdk>4.7 生成SDK</a></li><li><a href=#48-应用开发和调试>4.8 应用开发和调试</a></li></ul></li><li><a href=#5-内核开发>5. 内核开发</a><ul><li><a href=#51-添加外部模块>5.1 添加外部模块</a></li><li><a href=#52-修改内核源码>5.2 修改内核源码</a></li><li><a href=#53-修改内核配置>5.3 修改内核配置</a></li><li><a href=#54-设置defconfig>5.4 设置defconfig</a></li><li><a href=#55-使用devtool>5.5 使用devtool</a></li><li><a href=#56-使用virtual-provider>5.6 使用Virtual Provider</a></li></ul></li></ul></nav></div></details></div></div><div class="min-h-0 min-w-0 max-w-prose grow"><h2 id=1-前言 class="relative group">1. 前言 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-%e5%89%8d%e8%a8%80 aria-label=锚点>#</a></span></h2><p>通常情况下，一个嵌入式Linux系统由三个部分组成：</p><ol><li>bootloader：对于X86架构，大部分用GRUB，对于ARM架构，以前的处理器用一个u-boot就可以，而ARMv8之后，还要在u-boot前加上ATF等固件。</li><li>kernel：就是Linux内核，最常见的是一个bzImage文件，如果是ARM架构，还需要设备树文件，但是内核模块会包含在rootfs中。</li><li>rootfs：包含了内核模块和用户空间的所有软件（配置文件，可执行文件，运行库等），一些极简的系统只用busybox就可以完成基本的rootfs。</li></ol><blockquote><p>除了运行时的系统镜像，通常还要提供一个用于应用程序开发的SDK，包含了编译工具链和开发链接库。</p></blockquote><pre tabindex=0><code>- 嵌入式Linux系统镜像
  - bootloader
    - u-boot
    - atf-a
  - kernel
    - bzImage
    - devicetree
  - rootfs
    - kernel modules
    - busybox
    - glibc
    - Qt
    - etc.
</code></pre><p>最开始的时候，嵌入式Linux系统比较简单，BSP工程师只需要编译u-boot，linux kernel 和 busybox ，就可以构建一个系统，然后再根据需要添加软件包，整个构建过程基本都是手动操作，先下载源码，然后逐一编译，再写入系统盘中执行，或者组合成一个可以写入系统盘的系统文件。后来，随着嵌入式Linux系统日渐复杂，尤其是rootfs所需的包越来越多，彼此直接的依赖关系也非常复杂，为了使构建过程更加简便和可靠，也为了便于开发维护，人们开始创造一些自动化的工具，Yocto就是现在最流行的方案之一。</p><p>在2003年的时候，OpenEmbedded社区成立，它的目的是提供一套用于构建嵌入式Linux系统的框架和工具。在这里，构建Linux系统的过程就像做一桌宴席：</p><ol><li>首先，确定宴席的菜单，用什么桌椅和餐具。就是确定有一些系统级的特性，为此，OpenEmbedded定义了后缀为<code>.conf/.cfg</code>的configure（配置）文件，来描述系统内包含哪些软件包，包管理的种类（rpm，dpkg等），文件系统的格式（ext3，ext4等），目标磁盘的大小等。</li><li>然后，根据菜单，确定每一道菜需要什么食材，如何采买，怎么烹饪，如何装盘上菜，把每一道菜做好。每个软件包就相当于一道菜，OpenEmbedded定义了后缀为<code>.bb</code>的recipe（食谱）配置文件，来描述构建一个软件包所需的信息，包括：源码下载地址，下载后放在那里，如何配置编译，生成的文件安装到哪里等。</li><li>最后，就是烹饪和上菜的过程，我们需要做好每一道菜，摆好桌椅餐具，把做好的菜摆到桌子上，一桌宴席就成了。这就是编译和打包的过程，为此，OpenEmbedded提供了bitbake，这是一个python写成的工具，它通过解析recipe和configure文件，先把每个软件包编译出来，再把它们打包组合成一个Linux系统镜像。</li></ol><p>到2010年，Linux基金会发起了Yocto项目，它的目标是创造一套构建嵌入式Linux系统发行版的软件工具，改善Linux发行版的构建流程，于是就与OpenEmbedded合并了，在此基础上开发了一个Linux系统发行版Poky。整个项目主要由三个部分组成：</p><ul><li>OpenEmbedded-Core：包括基础核心的recipe和configure，还通过class文件提供了通用功能的类和方法，可以供多个recipe共享。</li><li>BitBake：OpenEmbedded提供的构建工具套件，用Python 写成，核心就行bitbake命令，它是一个多任务引擎，可以并行执行 shell 和 Python 任务，解析recipes和conf等配置文件，管理和执行源码下载、配置、编译、打包等构建过程，并最终将每个任务生成的文件集合成为系统镜像。构建Linux系统发行版涉及到很多方面的工作，如果你玩过 LFS ，就会了解这个过程的复杂性。BitBake 存在的意义就是提供了一个高效的工具，将这个过程标准化、流程化。BitBake 与 GNU Make 的关系就像 GNU Make 之于 GCC ，运作方式也类似 GNU Make ，又有很多不同。</li><li>Poky：Yocto基于OpenEmbedded开发的一个Linux系统发行版，基于Qemu运行，与具体硬件无关。作为一个参考，Yocto 的很多文档，都是以Poky作为实例进行讲解的，其他硬件厂商也可以基于Poky开发自己的Linux发行版。</li></ul><p><figure><img src=./pics/image_kWzZiT1rl6.png alt class="mx-auto my-0 rounded-md"></figure></p><p>在这里可以查到Yocto 发行版的历史：</p><ul><li><a href=https://wiki.yoctoproject.org/wiki/Releases title=https://wiki.yoctoproject.org/wiki/Releases target=_blank rel=noreferrer>https://wiki.yoctoproject.org/wiki/Releases</a>。</li></ul><p>其中，<a href=https://docs.yoctoproject.org/4.0.14/ title="Yocto Kirkstone 4.0" target=_blank rel=noreferrer>Yocto Kirkstone 4.0</a>是一个LST版本，2022年发布，预计支持到2026年。我们以此为例，循序渐进的学习Yocto。该版本的详细文档，可以在这里查到：</p><ul><li><a href=https://docs.yoctoproject.org/4.0.14/ title=https://docs.yoctoproject.org/4.0.14/ target=_blank rel=noreferrer>https://docs.yoctoproject.org/4.0.14/</a></li></ul><p>需要注意，Yocto的学习曲线比较陡峭，好在官方文档非常丰富，最好的方式就是循序渐进的做一些任务，然后查询文档理解其原理。</p><h2 id=2-快速开始 class="relative group">2. 快速开始 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-%e5%bf%ab%e9%80%9f%e5%bc%80%e5%a7%8b aria-label=锚点>#</a></span></h2><p>先搭建 Yocto 的宿主机环境，然后构建一个最简单系统，这样对Yocto有一个直观的认识。后面涉及的 Yocto 源码已经推送到 github ：<a href=https://github.com/exbob/yocto-kirkstone target=_blank rel=noreferrer>https://github.com/exbob/yocto-kirkstone</a>。</p><h3 id=21-宿主机 class="relative group">2.1 宿主机 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#21-%e5%ae%bf%e4%b8%bb%e6%9c%ba aria-label=锚点>#</a></span></h3><p>通常情况下，构建Yocto是个庞大的工程，根据目标文件的不同，可能需要执行成千上万个任务，对宿主机的CPU，内存和硬盘空间有较高要求。这里做最小的系统，可以用虚拟机，或者WSL，分配8核以上CPU，16G以上内存，100G以上的硬盘空间，操作系统选择Ubuntu20.04 Server，构建过程中会下载大量源码包，要确保网络畅通。</p><p>然后安装如下软件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo apt install gawk wget git diffstat unzip texinfo gcc build-essential chrpath socat cpio python3 python3-pip python3-pexpect xz-utils debianutils iputils-ping python3-git python3-jinja2 libegl1-mesa libsdl1.2-dev pylint3 xterm python3-subunit mesa-common-dev zstd liblz4-tool
</span></span></code></pre></div><p>配置git：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=err>$</span> <span class=n>git</span> <span class=n>config</span> <span class=o>--</span><span class=n>global</span> <span class=n>user</span><span class=p>.</span><span class=n>name</span> <span class=s>&#34;Your Name&#34;</span>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=n>git</span> <span class=n>config</span> <span class=o>--</span><span class=n>global</span> <span class=n>user</span><span class=p>.</span><span class=n>email</span> <span class=s>&#34;Your Email&#34;</span>
</span></span><span class=line><span class=cl><span class=err>$</span> <span class=n>git</span> <span class=n>config</span> <span class=o>--</span><span class=n>list</span>
</span></span></code></pre></div><h3 id=22-获取源码 class="relative group">2.2 获取源码 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#22-%e8%8e%b7%e5%8f%96%e6%ba%90%e7%a0%81 aria-label=锚点>#</a></span></h3><p>这一步是获取 poky 发行版的yocto源码。先新建一个工作目录：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mkdir yocto-kirkstone
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> yocto-kirkstone
</span></span></code></pre></div><p>克隆 poky ，并检出 kirkostone分支：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ git clone git://git.yoctoproject.org/poky
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> poky
</span></span><span class=line><span class=cl>$ git checkout -t origin/kirkstone -b my-kirkstone
</span></span></code></pre></div><p>分析一下poky源码的包括：</p><ul><li>oe-init-build-env，初始化构建环境的脚本，主要是把Yocto的工具路径添加到PATH中，然后生成基础配置。</li><li>bitbake/，bitbake工具套件的路径。</li><li>scritps/，包含了很多构建过程需要的脚本工具。</li><li>meta-*/，以meta开头的文件夹是layer。<a href=https://docs.yoctoproject.org/4.0.12/overview-manual/yp-intro.html#the-yocto-project-layer-model title="Layer Model" target=_blank rel=noreferrer>Layer Model</a>是Yocto的重要概念，可以简单的理解为对recipe的分类，例如，meta-yocto-bsp下包含的是与硬件相关的recipe，例如bootloader，kernel等，meta-selftest包含的是各种测试程序。</li></ul><h3 id=23-开始构建 class="relative group">2.3 开始构建 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#23-%e5%bc%80%e5%a7%8b%e6%9e%84%e5%bb%ba aria-label=锚点>#</a></span></h3><p>初始化构建环境：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>source</span> poky/oe-init-build-env x86_build
</span></span></code></pre></div><p>输出如下内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>You had no conf/local.conf file. This configuration file has therefore been
</span></span><span class=line><span class=cl>created <span class=k>for</span> you from /home/lsc/yocto-kirkstone/poky/meta-poky/conf/local.conf.sample
</span></span><span class=line><span class=cl>You may wish to edit it to, <span class=k>for</span> example, <span class=k>select</span> a different MACHINE <span class=o>(</span>target
</span></span><span class=line><span class=cl>hardware<span class=o>)</span>. See conf/local.conf <span class=k>for</span> more information as common configuration
</span></span><span class=line><span class=cl>options are commented.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You had no conf/bblayers.conf file. This configuration file has therefore been
</span></span><span class=line><span class=cl>created <span class=k>for</span> you from /home/lsc/yocto-kirkstone/poky/meta-poky/conf/bblayers.conf.sample
</span></span><span class=line><span class=cl>To add additional metadata layers into your configuration please add entries
</span></span><span class=line><span class=cl>to conf/bblayers.conf.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The Yocto Project has extensive documentation about OE including a reference
</span></span><span class=line><span class=cl>manual which can be found at:
</span></span><span class=line><span class=cl>    https://docs.yoctoproject.org
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>For more information about OpenEmbedded see the website:
</span></span><span class=line><span class=cl>    https://www.openembedded.org/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### Shell environment set up for builds. ###</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You can now run <span class=s1>&#39;bitbake &lt;target&gt;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Common targets are:
</span></span><span class=line><span class=cl>    core-image-minimal
</span></span><span class=line><span class=cl>    core-image-full-cmdline
</span></span><span class=line><span class=cl>    core-image-sato
</span></span><span class=line><span class=cl>    core-image-weston
</span></span><span class=line><span class=cl>    meta-toolchain
</span></span><span class=line><span class=cl>    meta-ide-support
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You can also run generated qemu images with a <span class=nb>command</span> like <span class=s1>&#39;runqemu qemux86&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Other commonly useful commands are:
</span></span><span class=line><span class=cl> - <span class=s1>&#39;devtool&#39;</span> and <span class=s1>&#39;recipetool&#39;</span> handle common recipe tasks
</span></span><span class=line><span class=cl> - <span class=s1>&#39;bitbake-layers&#39;</span> handles common layer tasks
</span></span><span class=line><span class=cl> - <span class=s1>&#39;oe-pkgdata-util&#39;</span> handles common target package tasks
</span></span></code></pre></div><p>这个初始化过程会设置一些环境变量，然后新建一个名为x86_build文件夹，作为该项目的工作路径。这个路径会设置到<code>BUILDDIR</code>环境变量中。<code>x86_build/conf/</code>下有三个配置文件：</p><ul><li>templateconf.cfg：设置配置文件模板的路径。文件内容默认为 <code>meta-poky/conf</code>，这个路径下包含了很多配置文件的模板。</li><li>bblayers.conf：该文件列出了本项目用到的layer，bitbake只会在这些layer下搜索recipe。</li><li>local.conf：本地配置文件，在这个文件里设置针对本项目的全局变量。</li></ul><p>在conf/local.conf 文件添加配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>BB_NUMBER_THREADS</span> <span class=o>=</span> <span class=s2>&#34;4&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PARALLEL_MAKE</span> <span class=o>=</span> <span class=s2>&#34;-j 4&#34;</span>
</span></span></code></pre></div><ul><li><a href="https://docs.yoctoproject.org/4.0.11/ref-manual/variables.html?highlight=bb_number_threads#term-BB_NUMBER_THREADS" title=BB_NUMBER_THREADS target=_blank rel=noreferrer>BB_NUMBER_THREADS</a> ，设置最大任务数。bitbake 会同时开启多个任务，并行处理构建过程，默认最大值为CPU的线程数，为了避免影响其他工作，可以设置调小一点。</li><li><a href="https://docs.yoctoproject.org/4.0.11/ref-manual/variables.html?highlight=bb_number_threads#term-PARALLEL_MAKE" title=PARALLEL_MAKE target=_blank rel=noreferrer>PARALLEL_MAKE</a> ，传递给make命令的参数，通过 bitbake调用 do_compile任务时传递。设置为<code>-j 4</code> 表示编译时最大线程数。</li></ul><p>打印信息已经告诉我们下一步可以构建多种target，我们选择构建一个最小的发行版：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake core-image-minimal
</span></span></code></pre></div><p>这个发行版包含的软件包较少，构建过程在数小时就可以完成，简单看一下build目录下的文件：</p><ul><li>conf，包含了一些全局配置文件。</li><li>downloads，所有的源码包都下载到了这个路径。</li><li>sstate-cache，构建过程中产生的缓存文件。</li><li>tmp/deploy/rpm/qemux86_64，安装到最终系统镜像中的所有 rpm 包都在这个路径下。</li><li>tmp/deploy/images/qemux86-64，最终生成的bootloader，kernel和rootfs等系统镜像文件都在这个路径下。</li></ul><p>然后运行qemu启动虚拟机：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ runqemu qemux86-64
</span></span></code></pre></div><p>在打印信息中可以看到完整的qemu配置参数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>runqemu - INFO - Setting up tap interface under sudo
</span></span><span class=line><span class=cl>runqemu - INFO - Network configuration: <span class=nv>ip</span><span class=o>=</span>192.168.7.2::192.168.7.1:255.255.255.0::eth0:off:8.8.8.8
</span></span><span class=line><span class=cl>runqemu - INFO - Running /home/lsc/yocto-kirkstone/x86_build/tmp/work/x86_64-linux/qemu-helper-native/1.0-r1/recipe-sysroot-native/usr/bin/qemu-system-x86_64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-device virtio-net-pci,netdev<span class=o>=</span>net0,mac<span class=o>=</span>52:54:00:12:34:02 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-netdev tap,id<span class=o>=</span>net0,ifname<span class=o>=</span>tap0,script<span class=o>=</span>no,downscript<span class=o>=</span>no <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-object rng-random,filename<span class=o>=</span>/dev/urandom,id<span class=o>=</span>rng0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-device virtio-rng-pci,rng<span class=o>=</span>rng0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-drive <span class=nv>file</span><span class=o>=</span>/home/lsc/yocto-kirkstone/x86_build/tmp/deploy/images/qemux86-64/core-image-minimal-qemux86-64-20230919015802.rootfs.ext4,if<span class=o>=</span>virtio,format<span class=o>=</span>raw <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-usb -device usb-tablet   -cpu IvyBridge -machine q35 -smp <span class=m>4</span> -m <span class=m>256</span> -serial mon:vc -serial null -device virtio-vga  -display sdl,show-cursor<span class=o>=</span>on  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-kernel /home/lsc/yocto-kirkstone/x86_build/tmp/deploy/images/qemux86-64/bzImage <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-append <span class=s1>&#39;root=/dev/vda rw  ip=192.168.7.2::192.168.7.1:255.255.255.0::eth0:off:8.8.8.8 oprofile.timer=1 tsc=reliable no_timer_check rcupdate.rcu_expedited=1 &#39;</span>
</span></span></code></pre></div><p>虚拟机会启动了一个新的窗口，用户名是 root，没有密码：</p><p><figure><img src=./pics/image_AQaCHR2L0u.png alt class="mx-auto my-0 rounded-md"></figure></p><p>关于qemu的更多内容可以参考<a href=https://docs.yoctoproject.org/4.0.12/dev-manual/qemu.html#using-the-quick-emulator-qemu title="Using the Quick EMUlator " target=_blank rel=noreferrer>Using the Quick EMUlator </a>。</p><blockquote><p>📌也可以先下载所有软件包的源码，下载完毕后再编译：<strong>bitbake core-image-minimal &ndash;runall=fetch</strong></p></blockquote><h2 id=3-解析工作流 class="relative group">3. 解析工作流 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3-%e8%a7%a3%e6%9e%90%e5%b7%a5%e4%bd%9c%e6%b5%81 aria-label=锚点>#</a></span></h2><p>下图展示了使用Yocto生成系统镜像image和应用开发工具SDK的工作流程：</p><p><figure><img src=./pics/image_n-cNcn0oCB.png alt class="mx-auto my-0 rounded-md"></figure></p><ol><li>开发人员从上游厂家获取Upstream Source，例如poky。</li><li>开发人员对Upstream Source进行必要的配置，包括增删软件包，修改软件配置，修改系统特性等。</li><li>开始构建，Build Systeam按如下流程工作：<ol><li>从指定位置获取并下载源代码，这个过程支持标准方法，例如ftp，git等。</li><li>下载成功后，再将源代码提取到本地工作区，在该工作区中应用补丁并运行配置和编译等软件的常见步骤。</li><li>将软件安装到暂存区，然后使用您选择的二进制包格式（deb、rpm或 ipk）来打包软件。</li><li>不同的 QA 和健全性检查贯穿整个构建过程。</li><li>软件包构建完毕后，放到一个Package Feeds中，用于生成image和SDK。</li><li>生成image（用于写入磁盘的系统镜像）和SDK (包含工具链和链接库，用于应用程序开发）。</li></ol></li></ol><p>更多详细信息可以参考：<a href=https://docs.yoctoproject.org/4.0.13/overview-manual/concepts.html title=https://docs.yoctoproject.org/4.0.13/overview-manual/concepts.html target=_blank rel=noreferrer>https://docs.yoctoproject.org/4.0.13/overview-manual/concepts.html</a>，可以先通篇浏览，然后在遇到问题时回溯，加深理解。下面以构建<code>core-image-minimal</code>为例简单分析一下。</p><p>bitbake的基本语法是<code>bitbake [options] [recipe_name/target]</code> ，当我们执行bitbake时，它解析<code>${BUILDDIR}/conf/bblayers.conf</code>文件，确定搜索recipe的路径，然后在这些路径下搜索recipce或者target，<code>core-image-minimal</code>作为一个target，也是由recipe文件描述的，可以用如下命令确定该文件的路径：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake -e core-image-minimal <span class=p>|</span> grep ^FILE<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>FILE</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/poky/meta/recipes-core/images/core-image-minimal.bb&#34;</span>
</span></span></code></pre></div><p>看一下这个文件的内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  <span class=m>1</span> <span class=nv>SUMMARY</span> <span class=o>=</span> <span class=s2>&#34;A small image just capable of allowing a device to boot.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=m>2</span>
</span></span><span class=line><span class=cl>  <span class=m>3</span> <span class=nv>IMAGE_INSTALL</span> <span class=o>=</span> <span class=s2>&#34;packagegroup-core-boot </span><span class=si>${</span><span class=nv>CORE_IMAGE_EXTRA_INSTALL</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=m>4</span>
</span></span><span class=line><span class=cl>  <span class=m>5</span> <span class=nv>IMAGE_LINGUAS</span> <span class=o>=</span> <span class=s2>&#34; &#34;</span>
</span></span><span class=line><span class=cl>  <span class=m>6</span>
</span></span><span class=line><span class=cl>  <span class=m>7</span> <span class=nv>LICENSE</span> <span class=o>=</span> <span class=s2>&#34;MIT&#34;</span>
</span></span><span class=line><span class=cl>  <span class=m>8</span>
</span></span><span class=line><span class=cl>  <span class=m>9</span> inherit core-image
</span></span><span class=line><span class=cl> <span class=m>10</span>
</span></span><span class=line><span class=cl> <span class=m>11</span> IMAGE_ROOTFS_SIZE ?<span class=o>=</span> <span class=s2>&#34;8192&#34;</span>
</span></span><span class=line><span class=cl> <span class=m>12</span> IMAGE_ROOTFS_EXTRA_SPACE:append <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=p>@bb.utils.contains(</span><span class=s2>&#34;DISTRO_FEATURES&#34;</span><span class=p>, </span><span class=s2>&#34;systemd&#34;</span><span class=p>, </span><span class=s2>&#34; + 4096&#34;</span><span class=p>,     </span><span class=s2>&#34;&#34;</span><span class=p>, d)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span></code></pre></div><ul><li><code>SUMMARY</code>简要的说明了这个target是什么。</li><li><code>IMAGE_INSTALL</code>列出了该系统要安装的recipes。</li><li><code>inherit core-image</code>表示它继承了core-image。</li></ul><p>从这个文件开始，继续深入解析，bitbake就会得到该系统依赖的所有recipes，然后依次执行每个recipe的构建过程。可以使用<code>-g</code>选项解析target与recipe之间的依赖关系：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake -g core-image-minimal
</span></span><span class=line><span class=cl>Loading cache: 100% <span class=p>|</span><span class=c1>################################################################| Time: 0:00:00</span>
</span></span><span class=line><span class=cl>Loaded <span class=m>1644</span> entries from dependency cache.
</span></span><span class=line><span class=cl>NOTE: Resolving any missing task queue dependencies
</span></span><span class=line><span class=cl>NOTE: PN build list saved to <span class=s1>&#39;pn-buildlist&#39;</span>
</span></span><span class=line><span class=cl>NOTE: Task dependencies saved to <span class=s1>&#39;task-depends.dot&#39;</span>
</span></span></code></pre></div><p>生成了两个文件：</p><ul><li>task-depends.dot: 这是一个<a href=http://www.graphviz.org/ title=Graphviz target=_blank rel=noreferrer>Graphviz</a>格式的文件，显示是所有任务之间的依赖关系。</li><li>pn-buildlist: 文本文件，列出了构建target过程中依赖的所有recipe。</li></ul><p>Yocto提供了<code>oe-depends-dot</code>工具，可以对<code>task-depends.dot</code>进行简单分析：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查询busybox的生成关系</span>
</span></span><span class=line><span class=cl>$ oe-depends-dot -k busybox -w task-depends.dot
</span></span><span class=line><span class=cl>Because: core-image-minimal packagegroup-core-boot
</span></span><span class=line><span class=cl>core-image-minimal -&gt; packagegroup-core-boot -&gt; busybox
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查询busybox依赖的包</span>
</span></span><span class=line><span class=cl>$ oe-depends-dot -k busybox -d task-depends.dot
</span></span><span class=line><span class=cl>Depends: gcc-cross-x86_64 gcc-runtime zip rpm-native opkg-utils-native pseudo-native opkg-utils libxcrypt kern-tools-native quilt-native ptest-runner update-rc initscripts patch-native glibc binutils-cross-x86_64 dwarfsrcfiles-native
</span></span></code></pre></div><p>这个文件很大，可以删除一下冗余信息缩小文件体积，然后用dot命令把它转换为pdf文件，方便查看：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ oe-depends-dot -r ./task-depends.dot
</span></span><span class=line><span class=cl>Saving reduced dot file to ./task-depends-reduced.dot
</span></span><span class=line><span class=cl>$ ls -l task-depends*
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> lsc lsc   <span class=m>23056</span> Sep <span class=m>28</span> 15:55 task-depends-reduced.dot
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> lsc lsc <span class=m>1297931</span> Sep <span class=m>12</span> 22:16 task-depends.dot
</span></span><span class=line><span class=cl>$ sudo apt install graphviz
</span></span><span class=line><span class=cl>$ dot -Tpdf task-depends-reduced.dot -o task-depends-reduced.pdf
</span></span></code></pre></div><p>也可以把文件内容负责到在线平台查看，例如：<a href=https://edotor.net/ title=https://edotor.net/ target=_blank rel=noreferrer>https://edotor.net/</a> 。</p><p>查看pn-buildlist文件，会发现有些recipe带有<code>native</code>后缀，有些则没有，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; cat pn-buildlist <span class=p>|</span> grep unzip
</span></span><span class=line><span class=cl>unzip-native
</span></span><span class=line><span class=cl>unzip
</span></span></code></pre></div><p>带有<code>native</code>后缀的recipe是运行宿主机上的软件，通常是辅助构建所需的工具，或者交叉编译工具链等，而没有后缀的recipe是运行在目标机上的软件。最终会发现，安装到目标机上的软件只有一百多个：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat pn-buildlist <span class=p>|</span> wc -l
</span></span><span class=line><span class=cl><span class=m>295</span>
</span></span><span class=line><span class=cl>$ cat pn-buildlist <span class=p>|</span> grep native <span class=p>|</span> wc -l
</span></span><span class=line><span class=cl><span class=m>149</span>
</span></span></code></pre></div><p>执行<code>bitbake -e &lt;recipe_name></code> 可以将一个recipe的所有内容全部解析出来，还包含大量的注释，这个非常重要，后面的各种工作都可以从中获得线索。以busybox为例，我们把它解析后的内容保存到一个文件，简单分析一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake -e busybox &gt; busybox-bb.log
</span></span></code></pre></div><p>首先，<code>FILE</code>变量记录了recipe文件的位置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat busybox-bb.log <span class=p>|</span> grep ^FILE<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>FILE</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/poky/meta/recipes-core/busybox/busybox_1.35.0.bb&#34;</span>
</span></span></code></pre></div><p>通过<code>WORKDIR</code>可以定位bitbake构建这个包时的工作目录：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat busybox-bb.log <span class=p>|</span> grep ^WORKDIR<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>WORKDIR</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/work/core2-64-poky-linux/busybox/1.35.0-r0&#34;</span>
</span></span></code></pre></div><p>构建过程会执行很多任务，每个包会略有不同，执行任务的顺序由其任务调度器控制。在<code>${WORKDIR}/temp/</code> 目录下，以 <code>run.do_</code> 开头的文件记录了每个任务执行的python/shell程序源码，以 <code>log.do_</code> 开头的文件记录任务执行时的日志，<code>log.task_order</code> 文件按顺序记录了当前目标执行了哪些任务。看一下busybox_1.35.0.bb执行了哪些任务：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat log.task_order
</span></span><span class=line><span class=cl>do_fetch <span class=o>(</span>1564520<span class=o>)</span>: log.do_fetch.1564520
</span></span><span class=line><span class=cl>do_unpack <span class=o>(</span>1605094<span class=o>)</span>: log.do_unpack.1605094
</span></span><span class=line><span class=cl>do_patch <span class=o>(</span>1653034<span class=o>)</span>: log.do_patch.1653034
</span></span><span class=line><span class=cl>do_deploy_source_date_epoch <span class=o>(</span>1707365<span class=o>)</span>: log.do_deploy_source_date_epoch.1707365
</span></span><span class=line><span class=cl>do_prepare_recipe_sysroot <span class=o>(</span>1707727<span class=o>)</span>: log.do_prepare_recipe_sysroot.1707727
</span></span><span class=line><span class=cl>do_configure <span class=o>(</span>1707736<span class=o>)</span>: log.do_configure.1707736
</span></span><span class=line><span class=cl>do_configure_ptest_base <span class=o>(</span>1781759<span class=o>)</span>: log.do_configure_ptest_base.1781759
</span></span><span class=line><span class=cl>do_compile <span class=o>(</span>1781797<span class=o>)</span>: log.do_compile.1781797
</span></span><span class=line><span class=cl>do_compile_ptest_base <span class=o>(</span>1949513<span class=o>)</span>: log.do_compile_ptest_base.1949513
</span></span><span class=line><span class=cl>do_install <span class=o>(</span>1949868<span class=o>)</span>: log.do_install.1949868
</span></span><span class=line><span class=cl>do_install_ptest_base <span class=o>(</span>2060604<span class=o>)</span>: log.do_install_ptest_base.2060604
</span></span><span class=line><span class=cl>do_package <span class=o>(</span>2064697<span class=o>)</span>: log.do_package.2064697
</span></span><span class=line><span class=cl>do_packagedata <span class=o>(</span>2173119<span class=o>)</span>: log.do_packagedata.2173119
</span></span><span class=line><span class=cl>do_populate_lic <span class=o>(</span>2262819<span class=o>)</span>: log.do_populate_lic.2262819
</span></span><span class=line><span class=cl>do_package_write_rpm <span class=o>(</span>2374209<span class=o>)</span>: log.do_package_write_rpm.2374209
</span></span><span class=line><span class=cl>do_package_qa <span class=o>(</span>2374261<span class=o>)</span>: log.do_package_qa.2374261
</span></span></code></pre></div><p>主要的任务有：</p><ol><li><a href="https://docs.yoctoproject.org/4.0.12/ref-manual/tasks.html?highlight=oe_runmake#do-fetch" title=fetch target=_blank rel=noreferrer>fetch</a> ：从远程或者本地获取源码，并放到<code>${DL_DIR}</code>路径下</li><li><a href="https://docs.yoctoproject.org/4.0.12/ref-manual/tasks.html?highlight=oe_runmake#do-unpack" title=unpack target=_blank rel=noreferrer>unpack</a> ：将源码从<code>${DL_DIR}</code>释放到<code>${WORKDIR}</code>下的相应路径下，并用<code>${S}</code>指向这个路径。</li><li><a href="https://docs.yoctoproject.org/4.0.12/ref-manual/tasks.html?highlight=oe_runmake#do-patch" title=patch target=_blank rel=noreferrer>patch</a> ： 将补丁文件应用到<code>${S}</code>路径下的源码中</li><li><a href="https://docs.yoctoproject.org/4.0.12/ref-manual/tasks.html?highlight=oe_runmake#do-configure" title=configure target=_blank rel=noreferrer>configure</a> ：在<code>${S}</code>路径下执行配置</li><li><a href="https://docs.yoctoproject.org/4.0.12/ref-manual/tasks.html?highlight=oe_runmake#do-compile" title=compile target=_blank rel=noreferrer>compile</a> ：在<code>${S}</code>路径下执行编译，编译生成的文件会放在<code>${B}</code>下，默认与<code>${S}</code>相同。</li><li><a href="https://docs.yoctoproject.org/4.0.12/ref-manual/tasks.html?highlight=oe_runmake#do-install" title=install target=_blank rel=noreferrer>install</a> ：从<code>${B}</code>把文件复制到<code>${D}</code>路径下。</li><li><a href="https://docs.yoctoproject.org/4.0.12/ref-manual/tasks.html?highlight=oe_runmake#do-package" title=package target=_blank rel=noreferrer>package</a> ：分析<code>${D}</code>路径下的文件，按照<code>${PACKAGES}</code>和<code>${FILES}</code>的设置，把他们分类放入<code>${PKGDEST}</code>下的文件夹，最后打包生成<code>${WORKDIR}/deploy/</code>和<code>${TMPDIR}/deploy</code>路径下软件安装包，软件安装包的数据会记录到<code>${PKGDATA_DIR}</code>下的相应文件。</li><li><a href="https://docs.yoctoproject.org/4.0.12/ref-manual/tasks.html?highlight=oe_runmake#do-clean" title=clean target=_blank rel=noreferrer>clean</a> ：删除<code>${B}</code>路径下编译生成的文件</li><li><a href="https://docs.yoctoproject.org/4.0.12/ref-manual/tasks.html?highlight=oe_runmake#do-cleansstate" title=clearsstate target=_blank rel=noreferrer>clearsstate</a> ：删除编译过程产生的所有文件和缓存文件</li><li><a href="https://docs.yoctoproject.org/4.0.12/ref-manual/tasks.html?highlight=oe_runmake#do-cleanall" title=cleanall target=_blank rel=noreferrer>cleanall</a> ：删除所有文件，包括<code>${DL_DIR}</code>路径下的源码和<code>${WORKDIR}</code>下的所有文件。</li></ol><p>可以看到busybox的源码路径和编译路径是一样的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat busybox-bb.log <span class=p>|</span> grep ^S<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>S</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/work/core2-64-poky-linux/busybox/1.35.0-r0/busybox-1.35.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ cat busybox-bb.log <span class=p>|</span> grep ^B<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>B</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/work/core2-64-poky-linux/busybox/1.35.0-r0/busybox-1.35.0&#34;</span>
</span></span></code></pre></div><p>各种任务的具体内容也可以查到，例如do_compile任务：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat busybox-bb.log <span class=p>|</span> grep -C <span class=m>2</span> <span class=s2>&#34;^do_compile&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># line: 147, file: /home/lsc/yocto-kirkstone/poky/meta/recipes-core/busybox/busybox.inc</span>
</span></span><span class=line><span class=cl>do_compile<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>unset</span> CFLAGS CPPFLAGS CXXFLAGS LDFLAGS
</span></span><span class=line><span class=cl>        <span class=nb>export</span> <span class=nv>KCONFIG_NOTIMESTAMP</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>--
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># line: 33, file: /home/lsc/yocto-kirkstone/poky/meta/classes/ptest.bbclass</span>
</span></span><span class=line><span class=cl>do_compile_ptest<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    :
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># line: 37, file: /home/lsc/yocto-kirkstone/poky/meta/classes/ptest.bbclass</span>
</span></span><span class=line><span class=cl>do_compile_ptest_base<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    do_compile_ptest
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>这些任务可以通过 <code>-c</code> 参数单独执行，例如只下载源码可以执行 <code>bitbake &lt;recipe_name> -c fetch</code> 。执行 <code>listtasks</code> 任务可以查看所有可用任务的解释：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bitbake linux-imx -c listtasks
</span></span></code></pre></div><p>更详细的任务解释可以在官方文档查看：<a href=https://docs.yoctoproject.org/4.0.14/ref-manual/tasks.html title=https://docs.yoctoproject.org/4.0.14/ref-manual/tasks.htm target=_blank rel=noreferrer>https://docs.yoctoproject.org/4.0.14/ref-manual/tasks.htm</a>。</p><p>依赖的recipe都构建完毕后，<code>core-image-minimal</code>会执行do_rootfs任务，它根据<code>${IMAGE_ROOTFS}</code>的值新建一个文件夹，把image需要安装的rpm安装包都安装到这里：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake -e core-image-minimal <span class=p>|</span> grep <span class=nv>IMAGE_ROOTFS</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>IMAGE_ROOTFS</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/work/qemux86_64-poky-linux/core-image-minimal/1.0-r0/rootfs&#34;</span>
</span></span><span class=line><span class=cl>$ ls tmp/work/qemux86_64-poky-linux/core-image-minimal/1.0-r0/rootfs
</span></span><span class=line><span class=cl>bin  boot  dev  etc  home  lib  media  mnt  proc  run  sbin  sys  tmp  usr  var
</span></span></code></pre></div><p>还会根据<code>${IMAGE_MANIFEST}</code>的值生成一个文件，在里面逐行列出了所有安装到image的rpm安装包，每行分三列，分别是名称，架构和版本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake -e core-image-minimal <span class=p>|</span> grep <span class=nv>IMAGE_MANIFEST</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>IMAGE_MANIFEST</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/work/qemux86_64-poky-linux/core-image-minimal/1.0-r0/deploy-core-image-minimal-image-complete/core-image-minimal-qemux86-64-20230914042751.rootfs.manifest&#34;</span>
</span></span><span class=line><span class=cl>$ cat tmp/work/qemux86_64-poky-linux/core-image-minimal/1.0-r0/deploy-core-image-minimal-image-complete/core-image-minimal-qemux86-64-20230914042751.rootfs.manifest
</span></span><span class=line><span class=cl>base-files qemux86_64 3.0.14
</span></span><span class=line><span class=cl>base-passwd core2_64 3.5.29
</span></span><span class=line><span class=cl>busybox core2_64 1.35.0
</span></span><span class=line><span class=cl>busybox-hwclock core2_64 1.35.0
</span></span><span class=line><span class=cl>busybox-syslog core2_64 1.35.0
</span></span><span class=line><span class=cl>busybox-udhcpc core2_64 1.35.0
</span></span><span class=line><span class=cl>eudev core2_64 3.2.10
</span></span><span class=line><span class=cl>init-ifupdown qemux86_64 1.0
</span></span><span class=line><span class=cl>init-system-helpers-service core2_64 1.62
</span></span><span class=line><span class=cl>initscripts core2_64 1.0
</span></span><span class=line><span class=cl>initscripts-functions core2_64 1.0
</span></span><span class=line><span class=cl>kernel-5.15.120-yocto-standard qemux86_64 5.15.120+git0+820b9bdb19_74c80e559b
</span></span><span class=line><span class=cl>kernel-image-5.15.120-yocto-standard qemux86_64 5.15.120+git0+820b9bdb19_74c80e559b
</span></span><span class=line><span class=cl>kernel-image-bzimage-5.15.120-yocto-standard qemux86_64 5.15.120+git0+820b9bdb19_74c80e559b
</span></span><span class=line><span class=cl>kernel-module-uvesafb-5.15.120-yocto-standard qemux86_64 5.15.120+git0+820b9bdb19_74c80e559b
</span></span><span class=line><span class=cl>ldconfig core2_64 2.35
</span></span><span class=line><span class=cl>libblkid1 core2_64 2.37.4
</span></span><span class=line><span class=cl>libc6 core2_64 2.35
</span></span><span class=line><span class=cl>libkmod2 core2_64 <span class=m>29</span>
</span></span><span class=line><span class=cl>liblzma5 core2_64 5.2.6
</span></span><span class=line><span class=cl>libz1 core2_64 1.2.11
</span></span><span class=line><span class=cl>modutils-initscripts core2_64 1.0
</span></span><span class=line><span class=cl>netbase noarch 6.3
</span></span><span class=line><span class=cl>packagegroup-core-boot qemux86_64 1.0
</span></span><span class=line><span class=cl>sysvinit core2_64 3.01
</span></span><span class=line><span class=cl>sysvinit-inittab qemux86_64 2.88dsf
</span></span><span class=line><span class=cl>sysvinit-pidof core2_64 3.01
</span></span><span class=line><span class=cl>update-alternatives-opkg core2_64 0.5.0
</span></span><span class=line><span class=cl>update-rc.d noarch 0.8
</span></span><span class=line><span class=cl>v86d qemux86_64 0.1.10
</span></span></code></pre></div><p>最后执行do_image任务，将kernel，rootfs等image组件放到<code>${DEPLOY_DIR_IMAGE}</code>路径下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat core-image-minimal-bb.log <span class=p>|</span> grep ^DEPLOY_DIR
</span></span><span class=line><span class=cl><span class=nv>DEPLOY_DIR</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/deploy&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DEPLOY_DIR_DEB</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/deploy/deb&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DEPLOY_DIR_IMAGE</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/deploy/images/qemux86-64&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DEPLOY_DIR_IPK</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/deploy/ipk&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DEPLOY_DIR_RPM</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/deploy/rpm&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DEPLOY_DIR_TAR</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/deploy/tar&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DEPLOY_DIR_TOOLS</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/deploy/tools&#34;</span>
</span></span><span class=line><span class=cl>$ ls tmp/deploy/images/qemux86-64/
</span></span><span class=line><span class=cl>bzImage
</span></span><span class=line><span class=cl>bzImage--5.15.120+git0+820b9bdb19_74c80e559b-r0-qemux86-64-20230912081542.bin
</span></span><span class=line><span class=cl>bzImage-qemux86-64.bin
</span></span><span class=line><span class=cl>core-image-minimal-qemux86-64-20230914081917.rootfs.manifest
</span></span><span class=line><span class=cl>core-image-minimal-qemux86-64-20230914081917.testdata.json
</span></span><span class=line><span class=cl>core-image-minimal-qemux86-64-20230914083045.qemuboot.conf
</span></span><span class=line><span class=cl>core-image-minimal-qemux86-64-20230914083045.rootfs.ext4
</span></span><span class=line><span class=cl>core-image-minimal-qemux86-64-20230914083045.rootfs.tar.bz2
</span></span><span class=line><span class=cl>core-image-minimal-qemux86-64.ext4
</span></span><span class=line><span class=cl>core-image-minimal-qemux86-64.manifest
</span></span><span class=line><span class=cl>core-image-minimal-qemux86-64.qemuboot.conf
</span></span><span class=line><span class=cl>core-image-minimal-qemux86-64.tar.bz2
</span></span><span class=line><span class=cl>core-image-minimal-qemux86-64.testdata.json
</span></span><span class=line><span class=cl>modules--5.15.120+git0+820b9bdb19_74c80e559b-r0-qemux86-64-20230912081542.tgz
</span></span><span class=line><span class=cl>modules-qemux86-64.tgz
</span></span></code></pre></div><p>关于BitBake的详细内容可以参考手册：<a href=https://docs.yoctoproject.org/bitbake/2.0/index.html title=https://docs.yoctoproject.org/bitbake/2.0/index.html target=_blank rel=noreferrer>https://docs.yoctoproject.org/bitbake/2.0/index.html</a>。</p><h2 id=4-基础定制 class="relative group">4. 基础定制 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4-%e5%9f%ba%e7%a1%80%e5%ae%9a%e5%88%b6 aria-label=锚点>#</a></span></h2><p>本章对<code>core-image-minimal</code>做一些基本的定制工作，循序渐进的理解Yocto。需要注意，重启Linux会话后，都要执行如下命令初始化Yocto环境：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>source</span> poky/oe-init-build-env x86_build
</span></span></code></pre></div><h3 id=41-新建layer class="relative group">4.1 新建layer <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#41-%e6%96%b0%e5%bb%balayer aria-label=锚点>#</a></span></h3><p>在Yocto中，recipe不是独立存在的，必须通过不同layer分类存放，官方和社区都发布了很多layer，例如：</p><ul><li>OpenEmedded Layer ：<a href=https://layers.openembedded.org/layerindex/branch/master/layers/ title=https://layers.openembedded.org/layerindex/branch/master/layers/ target=_blank rel=noreferrer>https://layers.openembedded.org/layerindex/branch/master/layers/</a></li><li>Yocto Layer ：<a href=https://www.yoctoproject.org/software-overview/layers/ title=https://www.yoctoproject.org/software-overview/layers/ target=_blank rel=noreferrer>https://www.yoctoproject.org/software-overview/layers/</a></li></ul><p>当我们要对poky进一步定制的时候，可以先现在社区找一找，有没有别人已经写好layer或者recipe，如果没找到，就应该新建自己的layer ，存放自定义的recipe。layer本质是一个文件夹和一些特定配置文件，这些可以手动逐个新建，详细情况可以参考<a href=https://docs.yoctoproject.org/4.0.12/dev-manual/common-tasks.html#understanding-and-creating-layers title="Understand and Creating Layers" target=_blank rel=noreferrer>Understand and Creating Layers</a>。</p><p>同时，bitbake套件提供bitbake-layers工具，简化了管理layer 的操作，它的<code>create-layer</code>子命令用于新建layer：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake-layers create-layer meta-mylayer
</span></span><span class=line><span class=cl>NOTE: Starting bitbake server...
</span></span><span class=line><span class=cl>Add your new layer with <span class=s1>&#39;bitbake-layers add-layer meta-mylayer&#39;</span>
</span></span></code></pre></div><p>这条命令新建了一个名为 meta-mylayer 的文件夹，内部包含如下文件：</p><ul><li>COPYING.MIT文件，这是layer的版权声明文件。</li><li>README 文件，这是一个描述layer内容的文件。</li><li>包含 layer.conf 文件的 conf 子目录，是layer的默认配置文件。</li><li>一个 recipes-example 子目录，其中包含一个名为 example 的子目录，该子目录包含一个 example.bb 文件，这是一个recipe的例子。</li></ul><p>然后需要把这个layer添加到项目中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake-layers add-layer meta-mylayer
</span></span></code></pre></div><p>这条命令会把meta-mylayer的路径添加到<code>${BUILDDIR}/conf/bblayers.conf</code>文件的<code>BBLAYERS</code>变量中，这样bitbake在执行时才能找到这个layer下的recipe：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; cat conf/bblayers.conf
</span></span><span class=line><span class=cl><span class=c1># POKY_BBLAYERS_CONF_VERSION is increased each time build/conf/bblayers.conf</span>
</span></span><span class=line><span class=cl><span class=c1># changes incompatibly</span>
</span></span><span class=line><span class=cl><span class=nv>POKY_BBLAYERS_CONF_VERSION</span> <span class=o>=</span> <span class=s2>&#34;2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>BBPATH</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>TOPDIR</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>BBFILES ?<span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>BBLAYERS ?<span class=o>=</span> <span class=s2>&#34; \
</span></span></span><span class=line><span class=cl><span class=s2>  /home/lsc/yocto-kirkstone/poky/meta \
</span></span></span><span class=line><span class=cl><span class=s2>  /home/lsc/yocto-kirkstone/poky/meta-poky \
</span></span></span><span class=line><span class=cl><span class=s2>  /home/lsc/yocto-kirkstone/poky/meta-yocto-bsp \
</span></span></span><span class=line><span class=cl><span class=s2>  /home/lsc/yocto-kirkstone/x86_build/meta-mylayer \
</span></span></span><span class=line><span class=cl><span class=s2>  &#34;</span>
</span></span></code></pre></div><p>查看一下当前项目包含的layer ：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake-layers show-layers
</span></span><span class=line><span class=cl>NOTE: Starting bitbake server...
</span></span><span class=line><span class=cl>layer                 path                                      <span class=nv>priority</span>
</span></span><span class=line><span class=cl><span class=o>==========================================================================</span>
</span></span><span class=line><span class=cl>meta                  /home/lsc/yocto-kirkstone/poky/meta       <span class=m>5</span>
</span></span><span class=line><span class=cl>meta-poky             /home/lsc/yocto-kirkstone/poky/meta-poky  <span class=m>5</span>
</span></span><span class=line><span class=cl>meta-yocto-bsp        /home/lsc/yocto-kirkstone/poky/meta-yocto-bsp  <span class=m>5</span>
</span></span><span class=line><span class=cl>meta-mylayer          /home/lsc/yocto-kirkstone/x86_build/meta-mylayer  <span class=m>6</span>
</span></span></code></pre></div><p>几个layer包含不同的内容：</p><ul><li>mate源于OpenEmbedded项目，是Yocto项目的核心内容，包括各种核心recipe，共享库和工具等。例如内核的recipe就在<code>meta/recipes-kernel/linux/</code>下。</li><li>meta-yocto-bsp包含硬件相关的内容，例如，<code>meta-yocto-bsp/conf/machine</code>下是目标硬件的配置文件，<code>meta-yocto-bsp/recipes-kernel/linux</code>下面是硬件相关的内核补丁。</li><li>meta-poky是poky这个发行版的核心内容，<code>meta-poky/conf/distro</code>下面是发行版的配置文件，从顶层决定了发行版包含的内容。</li><li>meta-mylayer就是我们在poky发行版基础上添加的自定义内容。</li></ul><p>注意最后一列表示优先级（priority），它在<code>${LAYERDIR}/conf/layer.conf</code>文件的<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-BBFILE_PRIORITY title=BBFILE_PRIORITY target=_blank rel=noreferrer>BBFILE_PRIORITY</a>变量中定义，数字越大表示优先级越高。bitbake会从低到高读取解析各layer中的配置，这样，对应同名的配置选项，高优先级中的配置就会把低优先级中的覆盖。如果要从bblayers.conf文件删除一个layer可以执行remove-layer子命令。</p><h3 id=42-添加软件包 class="relative group">4.2 添加软件包 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#42-%e6%b7%bb%e5%8a%a0%e8%bd%af%e4%bb%b6%e5%8c%85 aria-label=锚点>#</a></span></h3><p>因为<code>core-image-minimal</code> 的image只安装了少量的软件，大部分命令是由busybox生成的，数量较少，功能也比较简陋，例如没有可以追踪系统调用strace命令，我们要安装一个。</p><p>首先要确定现有的layer中，有没有包含strace的recipe。可以用bitbake的<code>-s</code>选项列出当前layer中的所有recipe，从中检索一下即可：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake -s <span class=p>|</span> grep strace
</span></span><span class=line><span class=cl>strace                                               :5.16-r0
</span></span><span class=line><span class=cl>strace-native                                        :5.16-r0
</span></span></code></pre></div><p>需要注意的是，当前项目的<code>${BBLAYERS}</code>并没有包含poky的所有layer，如果bitbake命令没找到，还是要去poky下搜索一下。</p><p>向image添加软件包的方法有很多种，最常用的是向<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-IMAGE_INSTALL title=IMAGE_INSTALL target=_blank rel=noreferrer>IMAGE_INSTALL</a>变量追加recpie，IMAGE_INSTALL的值是由空格分隔的recipe名称，bitbake会向image安装这个变量设置的recipe。我们在meta-mylayer下面新建<code>recipes-core/images/core-image-minimal.bbappend</code>文件，内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>IMAGE_INSTALL:append <span class=o>=</span> <span class=s2>&#34; strace&#34;</span>
</span></span></code></pre></div><p>它的含义是向<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-IMAGE_INSTALL title=IMAGE_INSTALL target=_blank rel=noreferrer>IMAGE_INSTALL</a>变量的尾部追加一个字符串，如果要在前面添加一个字符串，可以用<code>:prepend</code>语法，需要注意的是，这两个语法不会自动添加空格，所以要在recipe名的前后加一个空格，如果要删除一个字符串，可以用<code>:remove</code>语法。bitbake修改变量的语法有很多种，有很多注意事项，可以参考<a href=https://docs.yoctoproject.org/bitbake/2.0/bitbake-user-manual/bitbake-user-manual-metadata.html#basic-syntax title="Basic Syntax" target=_blank rel=noreferrer>Basic Syntax</a>探索一下。</p><p>每个recipe可以由一个<code>.bb</code>文件和多个<code>.bbappend</code>文件组成，bitbake会先读取<code>.bb</code>文件，然后按照layer的优先级由低到高，逐个读取<code>.bbappend</code>文件，然后深入解析。现在检查一下，可以看到strace已经加上：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake -e core-image-minimal <span class=p>|</span> grep ^IMAGE_INSTALL<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>IMAGE_INSTALL</span><span class=o>=</span><span class=s2>&#34;packagegroup-core-boot  strace&#34;</span>
</span></span></code></pre></div><p>重新编译image：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake core-image-minimal -c cleanall
</span></span><span class=line><span class=cl>$ bitbake core-image-minimal
</span></span></code></pre></div><p>查看<code>${IMAGE_ROOTFS}</code>和<code>${IMAGE_MANIFEST}</code>中的内容，确认安装成功，就可以启动虚拟机使用了：</p><p><figure><img src=./pics/image_U7CtPI7Uku.png alt class="mx-auto my-0 rounded-md"></figure></p><p>这是添加软件包最直接的方式，但是影响image包含哪些软件包的因素还有很多，后面会逐渐遇到。</p><h3 id=43-设置hostname class="relative group">4.3 设置hostname <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#43-%e8%ae%be%e7%bd%aehostname aria-label=锚点>#</a></span></h3><p>在Linux系统中，通过<code>/etc/hostname</code>文件设置主机名：</p><p><figure><img src=./pics/image_v8eUrr5C6T.png alt class="mx-auto my-0 rounded-md"></figure></p><p>如果要修改这个文件，首先要确定它是由哪个recipe安装到image的。每个recipe生成了哪些安装包都记录在<code>${PKGDATA_DIR}</code>路径下的同名文件中。以busybox为例，<code>${PKGDATA_DIR}/busybox</code>文件列出来busybox生成的所有安装包：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat busybox
</span></span><span class=line><span class=cl>PACKAGES: busybox-src busybox-dbg busybox-ptest busybox-httpd busybox-udhcpd busybox-udhcpc busybox-syslog busybox-mdev busybox-hwclock busybox-staticdev busybox-dev busybox-doc busybox-locale busybox
</span></span></code></pre></div><p>查看<code>${IMAGE_MANIFEST}</code>文件的内容可以确定，image只安装了如下几个安装包：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>busybox core2_64 1.35.0
</span></span><span class=line><span class=cl>busybox-hwclock core2_64 1.35.0
</span></span><span class=line><span class=cl>busybox-syslog core2_64 1.35.0
</span></span><span class=line><span class=cl>busybox-udhcpc core2_64 1.35.0
</span></span></code></pre></div><p>每个安装包向image安装的文件，都存放在<code>${PKGDEST}</code>路径下的同名文件夹里：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat busybox-bb.log <span class=p>|</span> grep ^PKGDEST<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>PKGDEST</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/work/core2-64-poky-linux/busybox/1.35.0-r0/packages-split&#34;</span>
</span></span><span class=line><span class=cl>$ ls tmp/work/core2-64-poky-linux/busybox/1.35.0-r0/packages-split
</span></span><span class=line><span class=cl>busybox      busybox-doc      busybox-locale  busybox-src        busybox-udhcpc
</span></span><span class=line><span class=cl>busybox-dbg  busybox-httpd    busybox-mdev    busybox-staticdev  busybox-udhcpd
</span></span><span class=line><span class=cl>busybox-dev  busybox-hwclock  busybox-ptest   busybox-syslog     busybox.shlibdeps
</span></span></code></pre></div><p>例如busybox-hwclock只安装了一个hwclock.sh脚本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ tree tmp/work/core2-64-poky-linux/busybox/1.35.0-r0/packages-split/busybox-hwclock
</span></span><span class=line><span class=cl>tmp/work/core2-64-poky-linux/busybox/1.35.0-r0/packages-split/busybox-hwclock
</span></span><span class=line><span class=cl>└── etc
</span></span><span class=line><span class=cl>    └── init.d
</span></span><span class=line><span class=cl>        └── hwclock.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>2</span> directories, <span class=m>1</span> file
</span></span></code></pre></div><p>通过上面这个查询次序，可以确定image安装哪些软件包，每个软件包都安装了什么文件，反过来也就可以确定image中的某个文件来自于哪个recipe 。OpenEmbedded为此提供了oe-pkgdata-util工具，它会解析<code>${PKGDATA_DIR}</code>下的文件，然后找出我们想要的数据。其中find-path子命令用户找到image中的某个文件来自于哪个安装包，执行如下命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ oe-pkgdata-util find-path /etc/hostname
</span></span><span class=line><span class=cl>base-files: /etc/hostname
</span></span></code></pre></div><p>因为一个recipe可能会生成多个软件安装包，所以，要进一步使用lookup-recipe子命令找到base-files这个软件包是哪个recipe生成的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ oe-pkgdata-util lookup-recipe base-files
</span></span><span class=line><span class=cl>base-files
</span></span></code></pre></div><p>至此，可以确定<code>/etc/hostname</code>是由<code>base-files_*.bb</code>构建的base-files软件包安装的，找到它：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake -e base-files <span class=p>|</span> grep ^PKGDEST<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>PKGDEST</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/tmp/work/qemux86_64-poky-linux/base-files/3.0.14-r89/packages-split&#34;</span>
</span></span><span class=line><span class=cl>$ ls tmp/work/qemux86_64-poky-linux/base-files/3.0.14-r89/packages-split
</span></span><span class=line><span class=cl>base-files  base-files-dbg  base-files-dev  base-files-doc  base-files-src
</span></span><span class=line><span class=cl>$ cat tmp/work/qemux86_64-poky-linux/base-files/3.0.14-r89/packages-split/base-files/etc/hostname
</span></span><span class=line><span class=cl>qemux86-64
</span></span></code></pre></div><p>找到它的recipe文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake -e base-files <span class=p>|</span> grep ^FILE<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>FILE</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/poky/meta/recipes-core/base-files/base-files_3.0.14.bb&#34;</span>
</span></span></code></pre></div><p>在<code>base-files_3.0.14.bb</code>文件可以看到如下内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>hostname</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>MACHINE</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>do_install <span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>hostname</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=si>${</span><span class=nv>hostname</span><span class=si>}</span> &gt; <span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>sysconfdir</span><span class=si>}</span>/hostname
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;127.0.1.1 </span><span class=si>${</span><span class=nv>hostname</span><span class=si>}</span><span class=s2>&#34;</span> &gt;&gt; <span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>sysconfdir</span><span class=si>}</span>/hosts
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>首先用<code>${MACHINE}</code>的值设置了hostname变量，然后把它写入了<code>${D}${sysconfdir}/hostname</code>文件。<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-MACHINE title=MACHINE target=_blank rel=noreferrer>MACHINE</a>定义在<code>${BUILDDIR}/conf/local.conf</code>文件中，这就是hostname的默认值：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat conf/local.conf <span class=p>|</span> grep ^MACHINE
</span></span><span class=line><span class=cl>MACHINE ??<span class=o>=</span> <span class=s2>&#34;qemux86-64&#34;</span>
</span></span></code></pre></div><p>当然可以在<code>base-files_3.0.14.bb</code>文件中的修改hostname 变量，但是这样不利于系统维护，更好的做法是在meta-mylayer下面新建<code>recipes-core/base-files/base-files_3.0.14.bbappend</code>文件，重新设置hostname：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>hostname</span> <span class=o>=</span> <span class=s2>&#34;localhost&#34;</span>
</span></span></code></pre></div><p>重新构建时，bitbake会先找到<code>base-files_3.0.14.bb</code>，然后找到同名的<code>.bbappend</code>文件，依据layer的优先级合并解析这些文件。很多时候会有有多个<code>.bbappend</code>文件，我们可以用bitbake-layer的show-appends子命令列出某个recipe依赖的所有<code>.bb</code>和<code>.bbappend</code>文件，以base-files为例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; bitbake-layers show-appends base-files
</span></span><span class=line><span class=cl>NOTE: Starting bitbake server...
</span></span><span class=line><span class=cl>Loading cache: 100% <span class=p>|</span><span class=c1>################################################################| Time: 0:00:00</span>
</span></span><span class=line><span class=cl>Loaded <span class=m>1645</span> entries from dependency cache.
</span></span><span class=line><span class=cl>Parsing recipes: 100% <span class=p>|</span><span class=c1>##############################################################| Time: 0:00:00</span>
</span></span><span class=line><span class=cl>Parsing of <span class=m>884</span> .bb files <span class=nb>complete</span> <span class=o>(</span><span class=m>883</span> cached, <span class=m>1</span> parsed<span class=o>)</span>. <span class=m>1645</span> targets, <span class=m>45</span> skipped, <span class=m>0</span> masked, <span class=m>0</span> errors.
</span></span><span class=line><span class=cl><span class=o>===</span> Matched appended <span class=nv>recipes</span> <span class=o>===</span>
</span></span><span class=line><span class=cl>base-files_3.0.14.bb:
</span></span><span class=line><span class=cl>  /home/lsc/yocto-kirkstone/x86_build/meta-mylayer/recipes-core/base-files/base-files_3.0.14.bbappend
</span></span></code></pre></div><p>所以，base-files_3.0.14.bbappend对hostname的重新赋值会把base-files_3.0.14.bb中的相应配置覆盖掉。我们重新构建一下就可以确认：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake base-files -c cleansstate
</span></span><span class=line><span class=cl>$ bitbake base-files 
</span></span><span class=line><span class=cl>$ cat tmp/work/qemux86_64-poky-linux/base-files/3.0.14-r89/packages-split/base-files/etc/hostname
</span></span><span class=line><span class=cl>localhost
</span></span></code></pre></div><h3 id=44-新建一个recipe class="relative group">4.4 新建一个recipe <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#44-%e6%96%b0%e5%bb%ba%e4%b8%80%e4%b8%aarecipe aria-label=锚点>#</a></span></h3><p>其实，Yocto通过<code>poky/meta-skeleton</code>提供了多种reciep和configure的例子，其中的recipes-<code>skeleton/hello-single</code>是一个添加应用程序的简单实例，我们参考这个例子改造一下，向image添加一个C语言的串口测试程序comperf。</p><p>首先在meta-mylayer下新建<code>recipes-app</code>文件夹，之所以用<code>recipes-</code>开头，是因为<code>conf/layer.conf</code>文件中默认配置的<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-BBFILES title=BBFILES target=_blank rel=noreferrer>BBFILES</a>变量，规定了只会检索<code>recipes-*</code>文件夹下的<code>.bb</code>和 <code>.bbappend</code>文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>BBFILES</span> <span class=o>+=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>LAYERDIR</span><span class=si>}</span><span class=s2>/recipes-*/*/*.bb \
</span></span></span><span class=line><span class=cl><span class=s2>            </span><span class=si>${</span><span class=nv>LAYERDIR</span><span class=si>}</span><span class=s2>/recipes-*/*/*.bbappend&#34;</span>
</span></span></code></pre></div><p>然后在此目录下新建comperf文件夹，包含如下文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; tree comperf/
</span></span><span class=line><span class=cl>comperf/
</span></span><span class=line><span class=cl>├── comperf_1.0.bb
</span></span><span class=line><span class=cl>└── files
</span></span><span class=line><span class=cl>    ├── Makefile
</span></span><span class=line><span class=cl>    ├── README.md
</span></span><span class=line><span class=cl>    └── comperf.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>1</span> directory, <span class=m>4</span> files
</span></span></code></pre></div><p>Makefile 的内容是：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>comperf:comperf.c
</span></span><span class=line><span class=cl>  <span class=k>$(</span>CC<span class=k>)</span> <span class=si>${</span><span class=nv>CFLAGS</span><span class=si>}</span> $&lt; -o <span class=nv>$@</span> -lrt <span class=k>$(</span>LDFLAGS<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>install:
</span></span><span class=line><span class=cl>  install -d <span class=k>$(</span>DESTDIR<span class=k>)</span>
</span></span><span class=line><span class=cl>  install -m <span class=m>0755</span> comperf <span class=k>$(</span>DESTDIR<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>clean:
</span></span><span class=line><span class=cl>  rm -rf comperf
</span></span></code></pre></div><p>按照bitbake的规定，recipe文件helloworld_1.0.bb的文件名有三个部分组成：</p><ul><li>第一个部分是recipe的名字，bitbake会把它解析到<a href="https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html?highlight=section#term-PN" title=PN target=_blank rel=noreferrer>PN</a>变量中，这里PN=helloworld。</li><li>下划线后面是源码的版本号，bitbake会把它解析到<a href="https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html?highlight=section#term-PV" title=PV target=_blank rel=noreferrer>PV</a>变量中，这里PV=1.0。</li><li>后缀必须是<code>.bb</code>。</li></ul><p>内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>DESCRIPTION</span> <span class=o>=</span> <span class=s2>&#34;Linux UART Serial test application&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>SECTION</span> <span class=o>=</span> <span class=s2>&#34;application&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>LICENSE</span> <span class=o>=</span> <span class=s2>&#34;MIT&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>LIC_FILES_CHKSUM</span> <span class=o>=</span> <span class=s2>&#34;file://</span><span class=si>${</span><span class=nv>COMMON_LICENSE_DIR</span><span class=si>}</span><span class=s2>/MIT;md5=0835ade698e0bcf8506ecda2f7b4f302&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SRC_URI</span> <span class=o>=</span> <span class=s2>&#34;file://comperf.c \
</span></span></span><span class=line><span class=cl><span class=s2>           file://Makefile \
</span></span></span><span class=line><span class=cl><span class=s2>           file://README.md \
</span></span></span><span class=line><span class=cl><span class=s2>           &#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>S</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>EXTRA_OEMAKE</span> <span class=o>=</span> <span class=s2>&#34;CC=&#39;</span><span class=si>${</span><span class=nv>CC</span><span class=si>}</span><span class=s2>&#39; CFLAGS=&#39;</span><span class=si>${</span><span class=nv>CFLAGS</span><span class=si>}</span><span class=s2>&#39; LDCFLAGS=&#39;</span><span class=si>${</span><span class=nv>LDFLAGS</span><span class=si>}</span><span class=s2>&#39; DESTDIR=&#39;</span><span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>bindir</span><span class=si>}</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>do_install<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    oe_runmake install
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>FILES:<span class=si>${</span><span class=nv>PN</span><span class=si>}</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>bindir</span><span class=si>}</span><span class=s2>/comperf&#34;</span> 
</span></span></code></pre></div><p>DESCRIPTION是对这个recipe的整体描述，SECTION的值用于软件安装包分类，rpm等包管理器会用它的值填充软件包的信息，不是必须的。</p><p>LICENSE标识这个recipe使用的License，这里用的是MIT。<a href="https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html?spm=wolai.workspace.0.0.5d1f23abMglYzs#term-LIC_FILES_CHKSUM" title=LIC_FILES_CHKSUM target=_blank rel=noreferrer>LIC_FILES_CHKSUM</a>是License文件的路径和校验和。Yocto在<code>${COMMON_LICENSE_DIR}</code>路径下提供了大量常用的Licesen文件，通常直接用这些就够了，如果要使用其他的Licesen文件，可以放到<code>${SRC_URI}</code>中，然后填写相对路径即可。<code>md5=</code>表示后面跟着License文件的md5校验和。bitbake开始构建前会检查这个，如果校验失败会报错。</p><p>执行do_fetch任务时，bibake会从<code>${SRC_URI}</code>获取源码，然后通过do_unpack任务放到<code>${WORKDIR}</code>路径下。SRC_URI设置了源码的路径，<code>file://</code> 协议表示这些文件在本地，然后是源码文件的路径，这个路径是基于 <code>${FILESPATH}</code> 的相对路径，可以设置单个文件，压缩包或者整个目录，通常是放在recipe文件同一层的<code>files</code>或者<code>${PN}</code>文件夹下。</p><p>后面的编译工作要在<code>${S}</code>设置的路径下进行，但是<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-S title=S target=_blank rel=noreferrer>S</a>的默认值是<code>${WORKDIR}/${BPN}-${PV}</code>，所以要重设<code>S = "${WORKDIR}"</code>。需要注意，如果SRC_URI设置的是压缩包，文件夹或者其他协议，这个路径是不一样的。</p><p>因为有Makefile，bitbake会自动执行基于make的do_compile任务，不用我们重写，可以用<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-EXTRA_OEMAKE title=EXTRA_OEMAKE target=_blank rel=noreferrer>EXTRA_OEMAKE</a>向Makefile传递一些需要的参数。<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-LDFLAGS title=LDFLAGS target=_blank rel=noreferrer>LDFLAGS</a>是向链接器传递的参数，使目标文件与构建系统的链接起来。<code>${bindir}</code>表示image中可执行文件的安装路径，默认值是<code>/usr/bin</code>。这些参数都定义在<code>poky/meta/conf/bitbake.conf</code>文件，常用的还有：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>base_prefix</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>prefix</span> <span class=o>=</span> <span class=s2>&#34;/usr&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>exec_prefix</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>prefix</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>sysconfdir</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>base_prefix</span><span class=si>}</span><span class=s2>/etc&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>bindir</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>exec_prefix</span><span class=si>}</span><span class=s2>/bin&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>sbindir</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>exec_prefix</span><span class=si>}</span><span class=s2>/sbin&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CC</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>CCACHE</span><span class=si>}${</span><span class=nv>HOST_PREFIX</span><span class=si>}</span><span class=s2>gcc </span><span class=si>${</span><span class=nv>HOST_CC_ARCH</span><span class=si>}${</span><span class=nv>TOOLCHAIN_OPTIONS</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CXX</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>CCACHE</span><span class=si>}${</span><span class=nv>HOST_PREFIX</span><span class=si>}</span><span class=s2>g++ </span><span class=si>${</span><span class=nv>HOST_CC_ARCH</span><span class=si>}${</span><span class=nv>TOOLCHAIN_OPTIONS</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CPP</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>HOST_PREFIX</span><span class=si>}</span><span class=s2>gcc -E</span><span class=si>${</span><span class=nv>TOOLCHAIN_OPTIONS</span><span class=si>}</span><span class=s2> </span><span class=si>${</span><span class=nv>HOST_CC_ARCH</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LD</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>HOST_PREFIX</span><span class=si>}</span><span class=s2>ld</span><span class=si>${</span><span class=nv>TOOLCHAIN_OPTIONS</span><span class=si>}</span><span class=s2> </span><span class=si>${</span><span class=nv>HOST_LD_ARCH</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>TARGET_CFLAGS</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>TARGET_CPPFLAGS</span><span class=si>}</span><span class=s2> </span><span class=si>${</span><span class=nv>SELECTED_OPTIMIZATION</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CFLAGS</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>TARGET_CFLAGS</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>TARGET_LDFLAGS</span> <span class=o>=</span> <span class=s2>&#34;-Wl,-O1 </span><span class=si>${</span><span class=nv>TARGET_LINK_HASH_STYLE</span><span class=si>}</span><span class=s2> </span><span class=si>${</span><span class=nv>ASNEEDED</span><span class=si>}</span><span class=s2> </span><span class=si>${</span><span class=nv>DEBUG_PREFIX_MAP</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LDFLAGS</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>TARGET_LDFLAGS</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>但是do_install任务默认是空的，需要我们自定义，这里是调用了Yocto提供的oe_runmake函数执行Makefile的install目标，这是由<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/classes.html#base-bbclass title=base.bbclass target=_blank rel=noreferrer>base.bbclass</a>文件提供的函数，可以在<code>poky/meta/classes/</code> 下找到。如果Makefile没有install目标，可以在do_install中直接添加安装命令，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>do_install<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    install -d <span class=si>${</span><span class=nv>D</span><span class=si>}</span>/usr/bin
</span></span><span class=line><span class=cl>    install -m <span class=m>0755</span> comperf <span class=si>${</span><span class=nv>D</span><span class=si>}</span>/usr/bin
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>编译和安装完毕后，下一步要处理do_package任务。它先根据<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-PACKAGES title=PACKAGES target=_blank rel=noreferrer>PACKAGES</a>变量来确定要新建几个包，以空格分隔，默认值是：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=si>${</span><span class=nv>PN</span><span class=si>}</span>-src <span class=si>${</span><span class=nv>PN</span><span class=si>}</span>-dbg <span class=si>${</span><span class=nv>PN</span><span class=si>}</span>-staticdev <span class=si>${</span><span class=nv>PN</span><span class=si>}</span>-dev <span class=si>${</span><span class=nv>PN</span><span class=si>}</span>-doc <span class=si>${</span><span class=nv>PN</span><span class=si>}</span>-locale <span class=si>${</span><span class=nv>PACKAGE_BEFORE_PN</span><span class=si>}</span> <span class=si>${</span><span class=nv>PN</span><span class=si>}</span>
</span></span></code></pre></div><p>我们没有修改，所以<code>${PKGDEST}</code>路径下有如下文件夹：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>comperf      comperf-dev  comperf-locale  comperf-staticdev
</span></span><span class=line><span class=cl>comperf-dbg  comperf-doc  comperf-src
</span></span></code></pre></div><p>然后遍历<code>${PACKAGES}</code>，根据与每个软件包对应的<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-FILES title=FILES target=_blank rel=noreferrer>FILES</a> 变量，将文件分配给这些软件包。例如<code>FILES:${PN}</code>就是向comperf软件包添加的文件。如果要向comperf-doc软件包添加文件，应该设置<code>FILES:${PN}-doc</code>。如果一个文件与 <code>${PACKAGES}</code> 中多个软件包的 <code>${FILES}</code> 匹配，它将被分配到最早（最左）匹配的软件包。之后会执行do_package_write_rpm任务，把这些文件夹打包成rpm软件包，放到<code>${WORKDIR}/deploy-rpms</code>路径下。最后还要执行<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/tasks.html#do-package-qa title=do_package_qa target=_blank rel=noreferrer>do_package_qa</a>任务，对生成的软件包进行质量检查，确保构建正确，如果有“QA Issue”错误，可以在<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/qa-checks.html title="QA Error and Warning Messages" target=_blank rel=noreferrer>QA Error and Warning Messages</a>查询错误信息的含义和解决方法。</p><p>写好recipe后，构建调试没有问题，就可以把需要的软件包添加到image，在<code>meta-mylayer/recipes-core/images/core-image-minimal.bbappend</code>文件中添加一行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>IMAGE_INSTALL:append <span class=o>=</span> <span class=s2>&#34; comperf&#34;</span>
</span></span></code></pre></div><h3 id=45-使用packagegroup class="relative group">4.5 使用packagegroup <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#45-%e4%bd%bf%e7%94%a8packagegroup aria-label=锚点>#</a></span></h3><p>解析image的IMAGE_INSTALL变量，会发现一个名为<code>packagegroup-core-boot</code>的软件包：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake -e core-image-minimal <span class=p>|</span> grep ^IMAGE_INSTALL<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>IMAGE_INSTALL</span><span class=o>=</span><span class=s2>&#34;packagegroup-core-boot  strace comperf&#34;</span>
</span></span></code></pre></div><p>这种以<code>packagegroup</code>开头的可以叫做包组，就是按特定需求把多个软件包集合到一起，本质也是recipe：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ oe-pkgdata-util lookup-recipe packagegroup-core-boot
</span></span><span class=line><span class=cl>packagegroup-core-boot
</span></span><span class=line><span class=cl>$ bitbake -e packagegroup-core-boot <span class=p>|</span> grep ^FILE<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>FILE</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/poky/meta/recipes-core/packagegroups/packagegroup-core-boot.bb&#34;</span>
</span></span></code></pre></div><p>因为包组本身没有源码，所以文件名里没有设置PV，默认值是“1.0”，分析一下这个文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>SUMMARY</span> <span class=o>=</span> <span class=s2>&#34;Minimal boot requirements&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DESCRIPTION</span> <span class=o>=</span> <span class=s2>&#34;The minimal set of packages required to boot the system&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PR</span> <span class=o>=</span> <span class=s2>&#34;r17&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>PACKAGE_ARCH</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>MACHINE_ARCH</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>inherit packagegroup
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Distro can override the following VIRTUAL-RUNTIME providers:</span>
</span></span><span class=line><span class=cl>VIRTUAL-RUNTIME_dev_manager ?<span class=o>=</span> <span class=s2>&#34;udev&#34;</span>
</span></span><span class=line><span class=cl>VIRTUAL-RUNTIME_keymaps ?<span class=o>=</span> <span class=s2>&#34;keymaps&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>EFI_PROVIDER ??<span class=o>=</span> <span class=s2>&#34;grub-efi&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SYSVINIT_SCRIPTS</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=p>@bb.utils.contains(</span><span class=s1>&#39;MACHINE_FEATURES&#39;</span><span class=p>, </span><span class=s1>&#39;rtc&#39;</span><span class=p>, </span><span class=s1>&#39;${VIRTUAL-RUNTIME_base-utils-hwclock}&#39;</span><span class=p>, </span><span class=s1>&#39;&#39;</span><span class=p>, d)</span><span class=si>}</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>                    modutils-initscripts \
</span></span></span><span class=line><span class=cl><span class=s2>                    init-ifupdown \
</span></span></span><span class=line><span class=cl><span class=s2>                    </span><span class=si>${</span><span class=nv>VIRTUAL</span><span class=p>-RUNTIME_initscripts</span><span class=si>}</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>                   &#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>RDEPENDS:<span class=si>${</span><span class=nv>PN</span><span class=si>}</span> <span class=o>=</span> <span class=s2>&#34;\
</span></span></span><span class=line><span class=cl><span class=s2>    base-files \
</span></span></span><span class=line><span class=cl><span class=s2>    base-passwd \
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=nv>VIRTUAL</span><span class=p>-RUNTIME_base-utils</span><span class=si>}</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=p>@bb.utils.contains(</span><span class=s2>&#34;DISTRO_FEATURES&#34;</span><span class=p>, </span><span class=s2>&#34;sysvinit&#34;</span><span class=p>, </span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>SYSVINIT_SCRIPTS</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>, </span><span class=s2>&#34;&#34;</span><span class=p>, d)</span><span class=si>}</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=p>@bb.utils.contains(</span><span class=s2>&#34;MACHINE_FEATURES&#34;</span><span class=p>, </span><span class=s2>&#34;keyboard&#34;</span><span class=p>, </span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>VIRTUAL</span><span class=p>-RUNTIME_keymaps</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>, </span><span class=s2>&#34;&#34;</span><span class=p>, d)</span><span class=si>}</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=p>@bb.utils.contains(</span><span class=s2>&#34;MACHINE_FEATURES&#34;</span><span class=p>, </span><span class=s2>&#34;efi&#34;</span><span class=p>, </span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>EFI_PROVIDER</span><span class=si>}</span><span class=s2> kernel&#34;</span><span class=p>, </span><span class=s2>&#34;&#34;</span><span class=p>, d)</span><span class=si>}</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>    netbase \
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=nv>VIRTUAL</span><span class=p>-RUNTIME_login_manager</span><span class=si>}</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=nv>VIRTUAL</span><span class=p>-RUNTIME_init_manager</span><span class=si>}</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=nv>VIRTUAL</span><span class=p>-RUNTIME_dev_manager</span><span class=si>}</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=nv>VIRTUAL</span><span class=p>-RUNTIME_update-alternatives</span><span class=si>}</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=nv>MACHINE_ESSENTIAL_EXTRA_RDEPENDS</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>RRECOMMENDS:<span class=si>${</span><span class=nv>PN</span><span class=si>}</span> <span class=o>=</span> <span class=s2>&#34;\
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=nv>VIRTUAL</span><span class=p>-RUNTIME_base-utils-syslog</span><span class=si>}</span><span class=s2> \
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=nv>MACHINE_ESSENTIAL_EXTRA_RRECOMMENDS</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>开头的<a href="https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html?spm=wolai.workspace.0.0.5d1f23abPcawC8#term-PR" title=PR target=_blank rel=noreferrer>PR</a>是recipe文件本身的版本号，如果没有设置，默认值就是“r0”。<code>inherit packagegroup</code>表示继承<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/classes.html#packagegroup-bbclass title=packagegroup.bbclass target=_blank rel=noreferrer>packagegroup.bbclass</a>中的方法，bitbake 会在<a href="https://docs.yoctoproject.org/bitbake/2.0/bitbake-user-manual/bitbake-user-manual-ref-variables.html?highlight=bbpath#term-BBPATH" title=BBPATH target=_blank rel=noreferrer>BBPATH</a>指定的路径中寻找 <code>packagegroup.bbclass</code>文件，<code>inherit</code>是用于继承<code>.bb</code>和<code>.bbclass</code>文件的语法，支持继承多个文件和使用变量。如果要继承其他类型的文件，推荐用<code>include</code>或<code>require</code>语法，二者的作用类似，主要区别是，如果找不到指定文件，<code>require</code>会报错，而<code>include</code>不会。更多共享通用功能的方法可以参考<a href=https://docs.yoctoproject.org/bitbake/2.0/bitbake-user-manual/bitbake-user-manual-metadata.html#sharing-functionality title="Sharing Functionality" target=_blank rel=noreferrer>Sharing Functionality</a>。</p><p>文件里没有设置SRC_URI或者FILES等变量，也没有定义do_compile等任务，所以它不会执行编译，安装和打包等任务。关键是<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-RDEPENDS title=RDEPENDS target=_blank rel=noreferrer>RDEPENDS</a> 和<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-RRECOMMENDS title=RRECOMMENDS target=_blank rel=noreferrer>RRECOMMENDS</a>变量：</p><ul><li><a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-RDEPENDS title=RDEPENDS target=_blank rel=noreferrer>RDEPENDS</a>的作用是列出软件包的运行时依赖项，这里列出的软件包也会安装到image，如果这些依赖项出错，会影响整个构建流程。例如<code>RDEPENDS:foo = "bar baz"</code>表示软件包foo需要安装软件包bar和baz。bitbake会自动检测和添加常见的软件包依赖关系，所以，多数recipe不需要设置 RDEPENDS。更多信息请参考<a href=https://docs.yoctoproject.org/4.0.12/overview-manual/concepts.html#automatically-added-runtime-dependencies title="Automatically Added Runtime Dependencies" target=_blank rel=noreferrer>Automatically Added Runtime Dependencies</a>。</li><li><a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-RRECOMMENDS title=RRECOMMENDS target=_blank rel=noreferrer>RRECOMMENDS</a>的作用是列出软件包的运行时功能扩展项，它们与本软件包是软性依赖关系，可以扩展本软件包的可用性，但不是构建的必要条件。如果存在就编译安装，如果不存在，也不会影响本软件的构建过程。</li></ul><p>通过<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-RDEPENDS title=RDEPENDS target=_blank rel=noreferrer>RDEPENDS</a> 和<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-RRECOMMENDS title=RRECOMMENDS target=_blank rel=noreferrer>RRECOMMENDS</a>变量安装的软件包，不能直接在IMAGE_INSTALL变量中清除，可以使用<code>.bbappend</code>文件修改相应变量，或者在<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html?#term-PACKAGE_EXCLUDE title=PACKAGE_EXCLUDE target=_blank rel=noreferrer>PACKAGE_EXCLUDE</a>变量中列出禁止安装到image的软件包，需要注意处理破坏依赖关系而导致的错误。</p><p>这里涉及到一个重要的函数<code>bb.utils.contains()</code>，由<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/classes.html?#utils-bbclass title=utils.bbclass target=_blank rel=noreferrer>utils.bbclass</a>提供，语法是：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>V</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=p>@bb.utils.contains(</span><span class=s1>&#39;val&#39;</span><span class=p>, </span><span class=s1>&#39;a&#39;</span><span class=p>, </span><span class=s1>&#39;1&#39;</span><span class=p>, </span><span class=s1>&#39;2&#39;</span><span class=p>, d)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>它的作用是，如果变量 val 中包含了 a ，就返回 1 ，否则返回 2 。例如上面的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=si>${</span><span class=p>@bb.utils.contains(</span><span class=s2>&#34;DISTRO_FEATURES&#34;</span><span class=p>, </span><span class=s2>&#34;sysvinit&#34;</span><span class=p>, </span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>SYSVINIT_SCRIPTS</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>, </span><span class=s2>&#34;&#34;</span><span class=p>, d)</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=si>${</span><span class=p>@bb.utils.contains(</span><span class=s2>&#34;MACHINE_FEATURES&#34;</span><span class=p>, </span><span class=s2>&#34;keyboard&#34;</span><span class=p>, </span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>VIRTUAL</span><span class=p>-RUNTIME_keymaps</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>, </span><span class=s2>&#34;&#34;</span><span class=p>, d)</span><span class=si>}</span> <span class=se>\
</span></span></span></code></pre></div><p>如果<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-DISTRO_FEATURES title=DISTRO_FEATURES target=_blank rel=noreferrer>DISTRO_FEATURES</a>中包含了sysvinit ，就返回<code>${SYSVINIT_SCRIPTS}</code>。类似的<code>*_FEATURES</code>还有<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-MACHINE_FEATURES title=MACHINE_FEATURES target=_blank rel=noreferrer>MACHINE_FEATURES</a>，<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-IMAGE_FEATURES title=IMAGE_FEATURES target=_blank rel=noreferrer>IMAGE_FEATURES</a>，<a href=https://docs.yoctoproject.org/4.0.12/ref-manual/variables.html#term-EXTRA_IMAGE_FEATURES title=EXTRA_IMAGE_FEATURES target=_blank rel=noreferrer>EXTRA_IMAGE_FEATURES</a>等，它们的值都会通过这种方式影响安装到image的软件包，我们可以在<code>conf/local.conf</code>或者<code>&lt;image>.bbappend</code>文件中修改这些变量。更多信息可以参考<a href=https://docs.yoctoproject.org/4.0.14/ref-manual/features.html? title=Features target=_blank rel=noreferrer>Features</a>。</p><p>要确定哪些recipe会检查某个特性，可以用grep命令查找，例如查找bluetooth的相关特性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>cd</span> poky/
</span></span><span class=line><span class=cl>$ grep -rn <span class=s1>&#39;contains.*MACHINE_FEATURES.*bluetooth&#39;</span> ./*
</span></span><span class=line><span class=cl>$ grep -rn <span class=s1>&#39;contains.*DISTRO_FEATURES.*bluetooth&#39;</span> ./*
</span></span></code></pre></div><h3 id=46-修改欢迎信息 class="relative group">4.6 修改欢迎信息 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#46-%e4%bf%ae%e6%94%b9%e6%ac%a2%e8%bf%8e%e4%bf%a1%e6%81%af aria-label=锚点>#</a></span></h3><p>Linux 系统启动时，会显示欢迎信息，这些信息来自<code>/etc/issue*</code>文件：</p><p><figure><img src=./pics/image_20240315144905.png alt class="mx-auto my-0 rounded-md"></figure></p><p>可以查到这个文件是<code>base-files</code>软件包安装的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ oe-pkgdata-util find-path /etc/issue
</span></span><span class=line><span class=cl>base-files: /etc/issue
</span></span></code></pre></div><p>分析这个软件包的recipes文件和任务日志，可以确定<code>issue</code>和<code>issue.net</code>是base-files的源文件，而且是空文件，由<code>do_install()</code>任务安装到image并向文件追加了内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SRC_URI</span> <span class=o>=</span> <span class=s2>&#34;file://rotation \
</span></span></span><span class=line><span class=cl><span class=s2>...
</span></span></span><span class=line><span class=cl><span class=s2>            file://issue.net \
</span></span></span><span class=line><span class=cl><span class=s2>            file://issue \
</span></span></span><span class=line><span class=cl><span class=s2>...
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>do_install () {
</span></span></span><span class=line><span class=cl><span class=s2>...
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>${</span><span class=nv>BASEFILESISSUEINSTALL</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>...
</span></span></span><span class=line><span class=cl><span class=s2>}
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>BASEFILESISSUEINSTALL ?= &#34;</span>do_install_basefilesissue<span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>...
</span></span></span><span class=line><span class=cl><span class=s2>do_install_basefilesissue () {
</span></span></span><span class=line><span class=cl><span class=s2>    install -m 644 </span><span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span><span class=s2>/issue*  </span><span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>sysconfdir</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        if [ -n &#34;</span><span class=si>${</span><span class=nv>DISTRO_NAME</span><span class=si>}</span><span class=s2>&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s2>            printf &#34;</span><span class=si>${</span><span class=nv>DISTRO_NAME</span><span class=si>}</span> <span class=s2>&#34; &gt;&gt; </span><span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>sysconfdir</span><span class=si>}</span><span class=s2>/issue
</span></span></span><span class=line><span class=cl><span class=s2>            printf &#34;</span><span class=si>${</span><span class=nv>DISTRO_NAME</span><span class=si>}</span> <span class=s2>&#34; &gt;&gt; </span><span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>sysconfdir</span><span class=si>}</span><span class=s2>/issue.net
</span></span></span><span class=line><span class=cl><span class=s2>            if [ -n &#34;</span><span class=si>${</span><span class=nv>DISTRO_VERSION</span><span class=si>}</span><span class=s2>&#34; ]; then
</span></span></span><span class=line><span class=cl><span class=s2>                distro_version_nodate=&#34;</span><span class=si>${</span><span class=p>@d.getVar(</span><span class=s1>&#39;DISTRO_VERSION&#39;</span><span class=p>).replace(</span><span class=s1>&#39;snapshot-${DATE}    &#39;</span><span class=p>,</span><span class=s1>&#39;snapshot&#39;</span><span class=p>).replace(</span><span class=s1>&#39;${DATE}&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                printf &#34;</span>%s <span class=s2>&#34; </span><span class=nv>$distro_version_nodate</span><span class=s2> &gt;&gt; </span><span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>sysconfdir</span><span class=si>}</span><span class=s2>/issue
</span></span></span><span class=line><span class=cl><span class=s2>                printf &#34;</span>%s <span class=s2>&#34; </span><span class=nv>$distro_version_nodate</span><span class=s2> &gt;&gt; </span><span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>sysconfdir</span><span class=si>}</span><span class=s2>/issue.net
</span></span></span><span class=line><span class=cl><span class=s2>            fi
</span></span></span><span class=line><span class=cl><span class=s2>            printf &#34;</span><span class=se>\\\n</span> <span class=se>\\\l\n</span><span class=s2>&#34; &gt;&gt; </span><span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>sysconfdir</span><span class=si>}</span><span class=s2>/issue
</span></span></span><span class=line><span class=cl><span class=s2>            echo &gt;&gt; </span><span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>sysconfdir</span><span class=si>}</span><span class=s2>/issue
</span></span></span><span class=line><span class=cl><span class=s2>            echo &#34;</span>%h<span class=s2>&#34;    &gt;&gt; </span><span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>sysconfdir</span><span class=si>}</span><span class=s2>/issue.net
</span></span></span><span class=line><span class=cl><span class=s2>            echo &gt;&gt; </span><span class=si>${</span><span class=nv>D</span><span class=si>}${</span><span class=nv>sysconfdir</span><span class=si>}</span><span class=s2>/issue.net
</span></span></span><span class=line><span class=cl><span class=s2>        fi
</span></span></span><span class=line><span class=cl><span class=s2>}
</span></span></span></code></pre></div><p>我们可以在<code>do_configure()</code>任务中添加语句，修改<code>issue</code>和<code>issue.net</code>源文件的内容。在<code>meta-mylayer/recipes-core/base-files/base-files_3.0.14.bbappend</code>文件中添加：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>do_configure:append<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>system</span><span class=o>=</span><span class=s2>&#34;MyPoky&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>version</span><span class=o>=</span><span class=k>$(</span>date <span class=s2>&#34;+%Y%m%d&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>system</span><span class=si>}</span><span class=s2> </span><span class=si>${</span><span class=nv>version</span><span class=si>}</span><span class=s2>&#34;</span> &gt; <span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span>/issue
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>system</span><span class=si>}</span><span class=s2> </span><span class=si>${</span><span class=nv>version</span><span class=si>}</span><span class=s2>&#34;</span> &gt; <span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span>/issue.net
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p><code>do_configure:append</code>表示向<code>do_configure()</code>任务追加内容，这里设置了用当前日期作为版本号，每次构建时都会自动更新。重新构建base-files，可以看到版本号已经添加到文件，而<code>${WORKDIR}/issue</code>和<code>${WORKDIR}/image/etc/issue</code>文件的内容有所不通：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ls tmp/work/qemux86_64-poky-linux/base-files/3.0.14-r89
</span></span><span class=line><span class=cl>base-files.spec           issue            patches                rotation
</span></span><span class=line><span class=cl>configure.sstate          issue.net        pkgdata                share
</span></span><span class=line><span class=cl>deploy-rpms               license-destdir  pkgdata-pdata-input    shells
</span></span><span class=line><span class=cl>deploy-source-date-epoch  licenses         pkgdata-sysroot        source-date-epoch
</span></span><span class=line><span class=cl>fstab                     motd             profile                sysroot-destdir
</span></span><span class=line><span class=cl>host.conf                 nsswitch.conf    pseudo                 temp
</span></span><span class=line><span class=cl>hosts                     package          recipe-sysroot
</span></span><span class=line><span class=cl>image                     packages-split   recipe-sysroot-native
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ cat tmp/work/qemux86_64-poky-linux/base-files/3.0.14-r89/issue
</span></span><span class=line><span class=cl>MyPoky <span class=m>20240315</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ cat tmp/work/qemux86_64-poky-linux/base-files/3.0.14-r89/image/etc/issue
</span></span><span class=line><span class=cl>MyPoky <span class=m>20240315</span>
</span></span><span class=line><span class=cl>Poky <span class=o>(</span>Yocto Project Reference Distro<span class=o>)</span> 4.0.12 <span class=se>\n</span> <span class=se>\l</span>
</span></span></code></pre></div><p>这是因为<code>do_install()</code>在<code>do_configure()</code>后面执行，又追加了内容，如果要重新设置欢迎信息，可以在<code>base-files_3.0.14.bbappend</code>文件中重写<code>do_install()</code>任务。</p><h3 id=47-生成sdk class="relative group">4.7 生成SDK <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#47-%e7%94%9f%e6%88%90sdk aria-label=锚点>#</a></span></h3><p>执行<code>bitbake [image] -c do_populate_sdk</code>可以生成相应image的SDK，包含了工具链和编译库等：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake core-image-minimal -c do_populate_sdk
</span></span></code></pre></div><p>生成的SDK安装脚本位于<code>tmp/deploy/sdk</code>路径下，执行后默认安装到<code>/opt/poky/4.0.12</code>路径：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ls
</span></span><span class=line><span class=cl>poky-glibc-x86_64-core-image-minimal-core2-64-qemux86-64-toolchain-4.0.12.host.manifest
</span></span><span class=line><span class=cl>poky-glibc-x86_64-core-image-minimal-core2-64-qemux86-64-toolchain-4.0.12.sh
</span></span><span class=line><span class=cl>poky-glibc-x86_64-core-image-minimal-core2-64-qemux86-64-toolchain-4.0.12.target.manifest
</span></span><span class=line><span class=cl>poky-glibc-x86_64-core-image-minimal-core2-64-qemux86-64-toolchain-4.0.12.testdata.json
</span></span><span class=line><span class=cl>$ ./poky-glibc-x86_64-core-image-minimal-core2-64-qemux86-64-toolchain-4.0.12.sh
</span></span><span class=line><span class=cl>Poky <span class=o>(</span>Yocto Project Reference Distro<span class=o>)</span> SDK installer version 4.0.12
</span></span><span class=line><span class=cl><span class=o>==================================================================</span>
</span></span><span class=line><span class=cl>Enter target directory <span class=k>for</span> SDK <span class=o>(</span>default: /opt/poky/4.0.12<span class=o>)</span>:
</span></span><span class=line><span class=cl>You are about to install the SDK to <span class=s2>&#34;/opt/poky/4.0.12&#34;</span>. Proceed <span class=o>[</span>Y/n<span class=o>]</span>?
</span></span><span class=line><span class=cl><span class=o>[</span>sudo<span class=o>]</span> password <span class=k>for</span> lsc:
</span></span><span class=line><span class=cl>Extracting SDK........................................................done
</span></span><span class=line><span class=cl>Setting it up...done
</span></span><span class=line><span class=cl>SDK has been successfully <span class=nb>set</span> up and is ready to be used.
</span></span><span class=line><span class=cl>Each <span class=nb>time</span> you wish to use the SDK in a new shell session, you need to <span class=nb>source</span> the environment setup script e.g.
</span></span><span class=line><span class=cl> $ . /opt/poky/4.0.12/environment-setup-core2-64-poky-linux
</span></span></code></pre></div><p>主要包括如下文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ tree -L <span class=m>2</span>
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── environment-setup-core2-64-poky-linux
</span></span><span class=line><span class=cl>├── site-config-core2-64-poky-linux
</span></span><span class=line><span class=cl>├── sysroots
</span></span><span class=line><span class=cl>│   ├── core2-64-poky-linux
</span></span><span class=line><span class=cl>│   └── x86_64-pokysdk-linux
</span></span><span class=line><span class=cl>└── version-core2-64-poky-linux
</span></span></code></pre></div><ul><li>environment-setup-core2-64-poky-linux 是初始化SDK环境的脚本</li><li>x86_64-pokysdk-linux是宿主机的开发环境，包含了交叉编译工具链，和运行SDK需要的各种库。</li><li>core2-64-poky-linux是目标机的运行环境，包含了编译链接的库和头文件等。</li></ul><p>使用时，执行如下命令初始化SDK使用环境：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ . /opt/poky/4.0.12/environment-setup-core2-64-poky-linux
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=si>${</span><span class=nv>CC</span><span class=si>}</span>
</span></span><span class=line><span class=cl>x86_64-poky-linux-gcc -m64 -march<span class=o>=</span>core2 -mtune<span class=o>=</span>core2 -msse3 -mfpmath<span class=o>=</span>sse -fstack-protector-strong -O2 -D_FORTIFY_SOURCE<span class=o>=</span><span class=m>2</span> -Wformat -Wformat-security -Werror<span class=o>=</span>format-security --sysroot<span class=o>=</span>/opt/poky/4.0.12/sysroots/core2-64-poky-linux
</span></span></code></pre></div><p>一些关键的变量：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>CC</span><span class=o>=</span>x86_64-poky-linux-gcc  -m64 -march<span class=o>=</span>core2 -mtune<span class=o>=</span>core2 -msse3 -mfpmath<span class=o>=</span>sse -fstack-protector-strong  -O2 -D_FORTIFY_SOURCE<span class=o>=</span><span class=m>2</span> -Wformat -Wformat-security -Werror<span class=o>=</span>format-security --sysroot<span class=o>=</span>/opt/poky/4.0.12/sysroots/core2-64-poky-linux
</span></span><span class=line><span class=cl><span class=nv>CFLAGS</span><span class=o>=</span> -O2 -pipe -g -feliminate-unused-debug-types
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>CXX</span><span class=o>=</span>x86_64-poky-linux-g++  -m64 -march<span class=o>=</span>core2 -mtune<span class=o>=</span>core2 -msse3 -mfpmath<span class=o>=</span>sse -fstack-protector-strong  -O2 -D_FORTIFY_SOURCE<span class=o>=</span><span class=m>2</span> -Wformat -Wformat-security -Werror<span class=o>=</span>format-security --sysroot<span class=o>=</span>/opt/poky/4.0.12/sysroots/core2-64-poky-linux
</span></span><span class=line><span class=cl><span class=nv>CXXFLAGS</span><span class=o>=</span> -O2 -pipe -g -feliminate-unused-debug-types
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>LD</span><span class=o>=</span>x86_64-poky-linux-ld   --sysroot<span class=o>=</span>/opt/poky/4.0.12/sysroots/core2-64-poky-linux
</span></span><span class=line><span class=cl><span class=nv>LDFLAGS</span><span class=o>=</span>-Wl,-O1 -Wl,--hash-style<span class=o>=</span>gnu -Wl,--as-needed  -Wl,-z,relro,-z,now
</span></span></code></pre></div><p>然后编译：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=si>${</span><span class=nv>CC</span><span class=si>}</span> hello.c -o helle
</span></span></code></pre></div><h3 id=48-应用开发和调试 class="relative group">4.8 应用开发和调试 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#48-%e5%ba%94%e7%94%a8%e5%bc%80%e5%8f%91%e5%92%8c%e8%b0%83%e8%af%95 aria-label=锚点>#</a></span></h3><p>参考<a href=https://docs.yoctoproject.org/4.0.14/dev-manual/debugging.html#debugging-with-the-gnu-project-debugger-gdb-remotely title="Debugging With the GNU Project Debugger (GDB) Remotely" target=_blank rel=noreferrer>Debugging With the GNU Project Debugger (GDB) Remotely</a>。</p><p>系统的DISTRO_FEATURES变量默认已经包含了<code>debuginfod</code>特性，这个特性会使gdb使能debuginfod特性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># recipes-devtools/gdb/gdb-common.inc</span>
</span></span><span class=line><span class=cl>PACKAGECONFIG ??<span class=o>=</span> <span class=s2>&#34;readline </span><span class=si>${</span><span class=p>@bb.utils.filter(</span><span class=s1>&#39;DISTRO_FEATURES&#39;</span><span class=p>, </span><span class=s1>&#39;debuginfod&#39;</span><span class=p>, d)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>PACKAGECONFIG<span class=o>[</span>debuginfod<span class=o>]</span> <span class=o>=</span> <span class=s2>&#34;--with-debuginfod, --without-debuginfod, elfutils&#34;</span>
</span></span></code></pre></div><p>这里涉及到一个重要的函数<code>bb.utils.filter()</code>，由<a href=https://docs.yoctoproject.org/4.0.14/ref-manual/classes.html?#utils-bbclass title=utils.bbclass target=_blank rel=noreferrer>utils.bbclass</a>提供，语法是：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bb.utils.filter<span class=o>(</span><span class=s1>&#39;variable&#39;</span>, <span class=s1>&#39;checkvalue&#39;</span>, d<span class=o>)}</span>
</span></span></code></pre></div><p>它的作用是检查<code>${variable}</code>中是否包含字符串<code>'checkvalue'</code>，成功则返回<code>'checkvalue'</code>，否则返回空。所以，第一行<a href=https://docs.yoctoproject.org/4.0.14/ref-manual/variables.html#term-PACKAGECONFIG title=PACKAGECONFIG target=_blank rel=noreferrer>PACKAGECONFIG</a>变量的值是<code>readline debuginfod</code>。第二行利用了bitbake的<a href=https://docs.yoctoproject.org/bitbake/2.0/bitbake-user-manual/bitbake-user-manual-metadata.html#variable-flag-syntax title="Variable Flag" target=_blank rel=noreferrer>Variable Flag</a>语法，可以影响<a href=https://docs.yoctoproject.org/4.0.14/ref-manual/variables.html#term-PACKAGECONFIG_CONFARGS title=PACKAGECONFIG_CONFARGS target=_blank rel=noreferrer>PACKAGECONFIG_CONFARGS</a>和<a href=https://docs.yoctoproject.org/4.0.14/ref-manual/variables.html#term-DEPENDS title=DEPENDS target=_blank rel=noreferrer>DEPENDS</a>变量的值，这里的含义是：</p><ol><li>如果PACKAGECONFIG中定义了debuginfod，则向PACKAGECONFIG_CONFARGS添加<code>--with-debuginfod</code>。</li><li>如果PACKAGECONFIG没有定义debuginfod，则向PACKAGECONFIG_CONFARGS添加<code>--without-debuginfod</code>。</li><li>如果PACKAGECONFIG中定义了debuginfod，则向DEPENDS中添加<code>elfutils</code>。</li></ol><p>使用方法就很简单了，在宿主机上执行<code>oe-debuginfod</code>命令启动debuginfod server，在目标机上设置服务器地址：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@qemux86-64:~# <span class=nb>export</span> <span class=nv>DEBUGINFOD_URLS</span><span class=o>=</span><span class=s2>&#34;http://192.168.7.1:8002/&#34;</span>
</span></span></code></pre></div><p>然后可以用<code>gdb</code>, <code>readelf</code> 或者 <code>objdump</code>与debuginfod server建立连接，获取调试信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@qemux86-64:~# gdb /bin/cat
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Reading symbols from /bin/cat...
</span></span><span class=line><span class=cl>Downloading separate debug info <span class=k>for</span> /bin/cat...
</span></span><span class=line><span class=cl>Reading symbols from /home/root/.cache/debuginfod_client/923dc4780cfbc545850c616bffa884b6b5eaf322/debuginfo...
</span></span></code></pre></div><h2 id=5-内核开发 class="relative group">5. 内核开发 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5-%e5%86%85%e6%a0%b8%e5%bc%80%e5%8f%91 aria-label=锚点>#</a></span></h2><p>内核开发的详细内容可以参考 <a href=https://docs.yoctoproject.org/4.0.14/kernel-dev/index.html title="Yocto Project Linux Kernel Development Manual" target=_blank rel=noreferrer>Yocto Project Linux Kernel Development Manual</a>。poky的内核recipe文件是<code>meta/recipes-kernel/linux/linux-yocto_5.15.bb</code>。</p><h3 id=51-添加外部模块 class="relative group">5.1 添加外部模块 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#51-%e6%b7%bb%e5%8a%a0%e5%a4%96%e9%83%a8%e6%a8%a1%e5%9d%97 aria-label=锚点>#</a></span></h3><p>脱离内核源码树，独立存在的内核模块，可以像软件包一样添加到image中，<code>poky/meta-skeleton/recipes-kernel/hello-mod</code>是一个简单实例，我们参考这个向系统添加一个内核模块。</p><p>在<code>meta-mylayer</code>新建<code>recipes-kernel/hello-mod</code>文件夹，添加如下文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ tree hello-mod
</span></span><span class=line><span class=cl>hello-mod
</span></span><span class=line><span class=cl>├── files
</span></span><span class=line><span class=cl>│   └── hello-mod
</span></span><span class=line><span class=cl>│       ├── COPYING
</span></span><span class=line><span class=cl>│       ├── Makefile
</span></span><span class=line><span class=cl>│       └── hello.c
</span></span><span class=line><span class=cl>└── hello-mod_0.1.bb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>2</span> directories, <span class=m>4</span> files
</span></span></code></pre></div><p><code>files/hello-mod</code>路径下就是内核模块的源码，需要注意Makefile的写法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>obj-m :<span class=o>=</span> hello.o
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SRC :<span class=o>=</span> <span class=k>$(</span>shell <span class=nb>pwd</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>all:
</span></span><span class=line><span class=cl>  <span class=k>$(</span>MAKE<span class=k>)</span> -C <span class=k>$(</span>KERNEL_SRC<span class=k>)</span> <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>SRC<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>modules_install:
</span></span><span class=line><span class=cl>  <span class=k>$(</span>MAKE<span class=k>)</span> -C <span class=k>$(</span>KERNEL_SRC<span class=k>)</span> <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>SRC<span class=k>)</span> modules_install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>clean:
</span></span><span class=line><span class=cl>  rm -f *.o *~ core .depend .*.cmd *.ko *.mod.c
</span></span><span class=line><span class=cl>  rm -f Module.markers Module.symvers modules.order
</span></span><span class=line><span class=cl>  rm -rf .tmp_versions Modules.symvers
</span></span></code></pre></div><p><code>hello-mod_0.1.bb</code>的内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>SUMMARY</span> <span class=o>=</span> <span class=s2>&#34;Example of how to build an external Linux kernel module&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DESCRIPTION</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>SUMMARY</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>LICENSE</span> <span class=o>=</span> <span class=s2>&#34;GPL-2.0-only&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>LIC_FILES_CHKSUM</span> <span class=o>=</span> <span class=s2>&#34;file://COPYING;md5=12f884d2ae1ff87c09e5b7ccc2c4ca7e&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>inherit module
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SRC_URI</span> <span class=o>=</span> <span class=s2>&#34;file://hello-mod&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>S</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span><span class=s2>/hello-mod&#34;</span>
</span></span></code></pre></div><p><code>LIC_FILES_CHKSUM</code>是License文件的相对路径和校验和，需要注意相对路径是指相对<code>${S}</code>。<code>SRC_URI</code>设置了源码路径，因为源码放在本地的<code>files/hello-mod</code>路径下，所以指设置一个文件夹名称即可。<code>inherit module</code>表示继承module.bbclass的相关任务，它会自动使用<code>kernel-module-</code>前缀命名软件安装包，生成的软件包是<code>kernel-module-hello-5.15.120-yocto-standard-0.1-r0.qemux86_64.rpm</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ls deploy-rpms/qemux86_64/
</span></span><span class=line><span class=cl>hello-mod-0.1-r0.qemux86_64.rpm
</span></span><span class=line><span class=cl>hello-mod-dbg-0.1-r0.qemux86_64.rpm
</span></span><span class=line><span class=cl>hello-mod-dev-0.1-r0.qemux86_64.rpm
</span></span><span class=line><span class=cl>kernel-module-hello-5.15.120-yocto-standard-0.1-r0.qemux86_64.rpm
</span></span></code></pre></div><p>然后在<code>core-image-minimal.bbappend</code>中将模块添加到image：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>IMAGE_INSTALL:append <span class=o>=</span> <span class=s2>&#34; hello-mod&#34;</span>
</span></span></code></pre></div><p>模块安装在<code>/lib/modules/5.15.120-yocto-standard/extra/</code>路径下。启动虚拟机后验证加载卸载：</p><p><figure><img src=./pics/image_zIKc9Pbda5.png alt class="mx-auto my-0 rounded-md"></figure></p><h3 id=52-修改内核源码 class="relative group">5.2 修改内核源码 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#52-%e4%bf%ae%e6%94%b9%e5%86%85%e6%a0%b8%e6%ba%90%e7%a0%81 aria-label=锚点>#</a></span></h3><p>修改内核源码树的方法有很多，这里推荐用git生产源码补丁，再添加都recipe中，下面是一个简单的例子。</p><p>找到内核源码的路径<code>${S}</code>，修改<code>init/calibrate.c</code>文件，在<code>calibrate_delay()</code>函数添加几行打印启动信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>calibrate_delay</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>lpj</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=kt>bool</span> <span class=n>printed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>this_cpu</span> <span class=o>=</span> <span class=nf>smp_processor_id</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;*************************************</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;*                                   *</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;*        HELLO YOCTO KERNEL         *</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;*                                   *</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=s>&#34;*************************************</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>per_cpu</span><span class=p>(</span><span class=n>cpu_loops_per_jiffy</span><span class=p>,</span> <span class=n>this_cpu</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>保存后使用git提交，并对此次修改生产一个补丁，补丁文件自动命名为<code>0001-feat-add-boot-message.patch</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ git add init/calibrate.c
</span></span><span class=line><span class=cl>$ git commit -m <span class=s2>&#34;feat:add boot message&#34;</span>
</span></span><span class=line><span class=cl>$ git format-patch -1
</span></span><span class=line><span class=cl>0001-feat-add-boot-message.patch
</span></span></code></pre></div><p>在<code>meta-mylayer/recipes-kernel</code>下新建<code>linux</code>文件夹，准备如下文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ tree linux/
</span></span><span class=line><span class=cl>linux/
</span></span><span class=line><span class=cl>├── linux-yocto
</span></span><span class=line><span class=cl>│   └── 0001-feat-add-boot-message.patch
</span></span><span class=line><span class=cl>└── linux-yocto_%.bbappend
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>1</span> directory, <span class=m>2</span> files
</span></span></code></pre></div><p>把前面生成的补丁文件放到了<code>linux-yocto</code>目录下，<code>linux-yocto_%.bbappend</code>文件名中的百分号<code>%</code>是通配符，表示这个<a href=https://docs.yoctoproject.org/bitbake/2.0/bitbake-user-manual/bitbake-user-manual-intro.html#append-files title=append文件 target=_blank rel=noreferrer>append文件</a>可以匹配任何前缀<code>linux-yocto_</code>的recipe文件，文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>FILESEXTRAPATHS:prepend :<span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>THISDIR</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=nv>PN</span><span class=si>}</span><span class=s2>:&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SRC_URI:append <span class=o>=</span> <span class=s2>&#34; file://0001-feat-add-boot-message.patch&#34;</span>
</span></span></code></pre></div><p><a href=https://docs.yoctoproject.org/4.0.14/ref-manual/variables.html#term-FILESEXTRAPATHS title=FILESEXTRAPATHS target=_blank rel=noreferrer>FILESEXTRAPATHS</a>变量是告诉bitbake查找文件和补丁的搜索路径，这里把<code>./linux-yocto</code>也加进去，因为补丁文件存放在这里，下面向SRC_URI添加补丁文件是，就是相对这里的路径。bitbake在执行patch任务时，会自动判断文件类型，然后把补丁合并到源码中，可以单独执行patch任务，确认补丁是否合并成功。最后依次执行如下命令生产新的内核和系统镜像：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake linux-yocto -c cleansstate
</span></span><span class=line><span class=cl>$ bitbake linux-yocto 
</span></span><span class=line><span class=cl>$ bitbake core-image-minimal -c cleanall
</span></span><span class=line><span class=cl>$ bitbake core-image-minimal 
</span></span></code></pre></div><p>启动虚拟机可以看到添加的启动信息：</p><p><figure><img src=./pics/image_EIC7tEk9Vl.png alt class="mx-auto my-0 rounded-md"></figure></p><h3 id=53-修改内核配置 class="relative group">5.3 修改内核配置 <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#53-%e4%bf%ae%e6%94%b9%e5%86%85%e6%a0%b8%e9%85%8d%e7%bd%ae aria-label=锚点>#</a></span></h3><p>单独编译内核时，标准做法是执行<code>make menuconfig</code>命令修改配置，bitbake也可以执行相应的<code>do_menuconfig</code>任务，打开内核的配置界面：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake linux-yocto -c menuconfig
</span></span></code></pre></div><p>这里的配置来自于<code>${B}/.config</code>文件，它是由上一个任务<code>do_kernel_configme</code>集合多个配置片段而成的，详细情况稍后再讲。这里我们修改一下<code>CONFIG_DEFAULT_HOSTNAME</code>配置：</p><p><figure><img src=./pics/image_hEiUWCSk3X.png alt class="mx-auto my-0 rounded-md"></figure></p><p>然后保存并退出。在编译目录<code>${B}</code>下面会生成更新后的 <code>.config</code> 文件，原有的 <code>.config</code> 被重命名为 <code>.config.old</code> ，对比一下二者的差异：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl>$ diff -u .config.old .config
</span></span><span class=line><span class=cl><span class=gd>--- .config.old 2023-11-20 16:46:10.061458785 +0800
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ .config     2023-11-20 17:01:28.021316267 +0800
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -16,7 +16,7 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> CONFIG_CC_HAS_ASM_GOTO_TIED_OUTPUT=y
</span></span><span class=line><span class=cl> CONFIG_CC_HAS_ASM_INLINE=y
</span></span><span class=line><span class=cl> CONFIG_CC_HAS_NO_PROFILE_FN_ATTR=y
</span></span><span class=line><span class=cl><span class=gd>-CONFIG_PAHOLE_VERSION=0
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+CONFIG_PAHOLE_VERSION=121
</span></span></span><span class=line><span class=cl><span class=gi></span> CONFIG_IRQ_WORK=y
</span></span><span class=line><span class=cl> CONFIG_BUILDTIME_TABLE_SORT=y
</span></span><span class=line><span class=cl> CONFIG_THREAD_INFO_IN_TASK=y
</span></span><span class=line><span class=cl><span class=gu>@@ -45,7 +45,7 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> # CONFIG_KERNEL_LZ4 is not set
</span></span><span class=line><span class=cl> # CONFIG_KERNEL_ZSTD is not set
</span></span><span class=line><span class=cl> CONFIG_DEFAULT_INIT=&#34;&#34;
</span></span><span class=line><span class=cl><span class=gd>-CONFIG_DEFAULT_HOSTNAME=&#34;(none)&#34;
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+CONFIG_DEFAULT_HOSTNAME=&#34;lsc-yocto&#34;
</span></span></span><span class=line><span class=cl><span class=gi></span> CONFIG_SWAP=y
</span></span><span class=line><span class=cl> CONFIG_SYSVIPC=y
</span></span><span class=line><span class=cl> CONFIG_SYSVIPC_SYSCTL=y
</span></span></code></pre></div><p>然后调用 diffconfig任务，它会对比 <code>.config</code> 和 <code>.config.old</code> ，确定修改的内容，生成一个补丁文件，称之为配置片段：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake linux-yocto -c diffconfig
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Config fragment has been dumped into:
</span></span><span class=line><span class=cl> /home/lsc/yocto-kirkstone/x86_build/tmp/work/qemux86_64-poky-linux/linux-yocto/5.15.120+gitAUTOINC+820b9bdb19_74c80e559b-r0/fragment.cfg
</span></span></code></pre></div><p>生成的配置片段文件是位于<code>${WORKDIR}</code>目录下的 <code>fragment.cfg</code> 。把这个文件复制到 <code>meta-mylayer/recipes-kernel/linux/linux-yocto</code> 目录下，然后在 <code>linux-yocto_%.bbappend</code> 文件中添加一行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>SRC_URI:append <span class=o>=</span> <span class=s2>&#34; file://fragment.cfg&#34;</span>
</span></span></code></pre></div><p>可以为<code>fragment.cfg</code>更改一个有意义的文件名，因为通常会使用多个配置片段来添加不同类型的修改内容，清除后重新编译，可以调用 <code>kernel_configcheck</code> 任务检查内核配置是否正确：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake linux-yocto -c cleansstate
</span></span><span class=line><span class=cl>$ bitbake linux-yocto -c kernel_configcheck
</span></span><span class=line><span class=cl>$ bitbake linux-yocto
</span></span></code></pre></div><p>这里要注意几个任务的执行顺序：</p><ol><li><code>do_patch</code>任务会把<code>.patch</code>文件应用到源码上。</li><li><code>do_kernel_configme</code>任务负责将defconfig和各种配置片段合并为<code>.config</code>。</li><li><code>do_configure</code>任务是执行内核配置工作，<code>do_menuconfig</code>也是在这个任务之后。</li></ol><p>在menuconfig中修改完配置，如果没有清除直接编译，后面的任务是继续进行，而不是从头开始，不会应用recipes文件中添加的配置片段，这样调试没有问题，如果想要使配置片段生效，还是要执行<code>do_cleansstate</code>任务后重新开始。</p><p><code>do_kernel_configme</code>任务定义在<code>poky/meta/classes/kernel-yocto.bbclass</code>文件中，它利用了Linux 内核源码的<code>/scripts/kconfig/merge_config.sh</code> 脚本来完成合并配置，脚本的语法如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./merge_config.sh -h
</span></span><span class=line><span class=cl>Usage: ./merge_config.sh <span class=o>[</span>OPTIONS<span class=o>]</span> <span class=o>[</span>CONFIG <span class=o>[</span>...<span class=o>]]</span>
</span></span><span class=line><span class=cl>  -h    display this <span class=nb>help</span> text
</span></span><span class=line><span class=cl>  -m    only merge the fragments, <span class=k>do</span> not execute the make <span class=nb>command</span>
</span></span><span class=line><span class=cl>  -n    use allnoconfig instead of alldefconfig
</span></span><span class=line><span class=cl>  -r    list redundant entries when merging fragments
</span></span><span class=line><span class=cl>  -y    make <span class=nb>builtin</span> have precedence over modules
</span></span><span class=line><span class=cl>  -O    dir to put generated output files.  Consider setting <span class=nv>$KCONFIG_CONFIG</span> instead.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Used prefix: <span class=s1>&#39;CONFIG_&#39;</span>. You can redefine it with <span class=nv>$CONFIG_</span> environment variable.
</span></span></code></pre></div><p>很多情况下，第三方发布的BSP会重写这个任务，但是基本原理是一样的。我们也可以在内核的 <code>.bbappend</code> 文件中添加一个类似的任务，让它在编译前利用 <code>merge_config.sh</code> 脚本合并配置片段，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>do_merge_fragment<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> -f <span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span>/fragment.cfg <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=si>${</span><span class=nv>S</span><span class=si>}</span>/scripts/kconfig/merge_config.sh -m <span class=si>${</span><span class=nv>B</span><span class=si>}</span>/.config <span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span>/fragment.cfg
</span></span><span class=line><span class=cl>        mv .config <span class=si>${</span><span class=nv>B</span><span class=si>}</span>/.config
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>addtask merge_fragment before do_compile after do_configure
</span></span></code></pre></div><h3 id=54-设置defconfig class="relative group">5.4 设置defconfig <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#54-%e8%ae%be%e7%bd%aedefconfig aria-label=锚点>#</a></span></h3><p>我们单独编译x86架构的内核时，通常是直接执行<code>make defconfig</code>，内核的Makefile会根据主机的<code>uname -m</code>信息，在<code>arch/x86/configs/</code>下找到相应的配置文件。如果是arm架构，通常要指定一个配置文件，Makefile会在<code>arch/${ARCH}/configs/</code>路径下的搜索，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ make imx_v8_defconfig
</span></span></code></pre></div><p>在yocto中，可以通过<a href=https://docs.yoctoproject.org/4.0.14/ref-manual/variables.html#term-KBUILD_DEFCONFIG title=KBUILD_DEFCONFIG target=_blank rel=noreferrer>KBUILD_DEFCONFIG</a>变量设置defconfig，bitbake会把<code>${KBUILD_DEFCONFIG}</code>和其他配置片段合并为<code>.config</code>文件。我们在 <code>linux-yocto_%.bbappend</code> 文件中添加一行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KBUILD_DEFCONFIG</span> <span class=o>=</span> <span class=s2>&#34;x86_64_defconfig&#34;</span>
</span></span></code></pre></div><p>重新编译内核，会发现<code>${WORKDIR}</code>目录下多了一个<code>defconfig</code>文件，这是</p><p><code>arch/x86/configs/x86_64_defconfig</code>文件的拷贝。我们也可以创建自己的defconfig，在<code>linux-yocto_%.bbappend </code>文件中通过SRC_URI添加：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>SRC_URI</span> <span class=o>+=</span> <span class=s2>&#34;file://defconfig&#34;</span>
</span></span></code></pre></div><p>通过SRC_URI添加的defconfig比<code>${KBUILD_DEFCONFIG}</code>的优先级高，在<code>do_kernel_configme</code>任务中可以看到相关代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>   <span class=c1># 如果定义了${KBUILD_DEFCONFIG}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=si>${</span><span class=nv>KBUILD_DEFCONFIG</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=si>${</span><span class=nv>S</span><span class=si>}</span><span class=s2>/arch/</span><span class=si>${</span><span class=nv>ARCH</span><span class=si>}</span><span class=s2>/configs/</span><span class=si>${</span><span class=nv>KBUILD_DEFCONFIG</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>      <span class=c1># 优先使用${WORKDIR}/defconfig</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span><span class=s2>/defconfig&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        cmp <span class=s2>&#34;</span><span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span><span class=s2>/defconfig&#34;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>S</span><span class=si>}</span><span class=s2>/arch/</span><span class=si>${</span><span class=nv>ARCH</span><span class=si>}</span><span class=s2>/configs/</span><span class=si>${</span><span class=nv>KBUILD_DEFCONFIG</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -ne <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>          bbdebug <span class=m>1</span> <span class=s2>&#34;detected SRC_URI or unpatched defconfig in WORKDIR. </span><span class=si>${</span><span class=nv>KBUILD_DEFCONFIG</span><span class=si>}</span><span class=s2> copied over it&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        cp -f <span class=si>${</span><span class=nv>S</span><span class=si>}</span>/arch/<span class=si>${</span><span class=nv>ARCH</span><span class=si>}</span>/configs/<span class=si>${</span><span class=nv>KBUILD_DEFCONFIG</span><span class=si>}</span> <span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span>/defconfig
</span></span><span class=line><span class=cl>      <span class=c1># 如果${WORKDIR}/defconfig不存在，就用${KBUILD_DEFCONFIG}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>        cp -f <span class=si>${</span><span class=nv>S</span><span class=si>}</span>/arch/<span class=si>${</span><span class=nv>ARCH</span><span class=si>}</span>/configs/<span class=si>${</span><span class=nv>KBUILD_DEFCONFIG</span><span class=si>}</span> <span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span>/defconfig
</span></span><span class=line><span class=cl>      <span class=k>fi</span>
</span></span><span class=line><span class=cl>      <span class=nv>in_tree_defconfig</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>WORKDIR</span><span class=si>}</span><span class=s2>/defconfig&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      bbfatal <span class=s2>&#34;A KBUILD_DEFCONFIG &#39;</span><span class=si>${</span><span class=nv>KBUILD_DEFCONFIG</span><span class=si>}</span><span class=s2>&#39; was specified, but not present in the source tree (</span><span class=si>${</span><span class=nv>S</span><span class=si>}</span><span class=s2>/arch/</span><span class=si>${</span><span class=nv>ARCH</span><span class=si>}</span><span class=s2>/configs/)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 如果${KBUILD_DEFCONFIG}没有定义，就用${WORKDIR}/defconfig</span>
</span></span><span class=line><span class=cl>  <span class=nv>sccs_from_src_uri</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=p>@</span><span class=s2>&#34; &#34;</span><span class=p>.join(find_sccs(d))</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>src_uri_defconfig</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$sccs_from_src_uri</span> <span class=p>|</span> awk <span class=s1>&#39;(match($0, &#34;defconfig&#34;) != 0) { print $0 }&#39;</span> <span class=nv>RS</span><span class=o>=</span><span class=s1>&#39; &#39;</span><span class=k>)</span>
</span></span></code></pre></div><p>上面的写法<code>KBUILD_DEFCONFIG = "x86_64_defconfig"</code>虽然有效，但是兼容性不好，常见的作法是用条件语法<a href=https://docs.yoctoproject.org/bitbake/2.0/bitbake-user-manual/bitbake-user-manual-metadata.html#conditional-syntax-overrides title="Conditional Syntax (Overrides)" target=_blank rel=noreferrer>Conditional Syntax (Overrides)</a>，让defconfig跟硬件架构关联起来，例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KBUILD_DEFCONFIG</span> <span class=o>=</span> <span class=s2>&#34;i386_defconfig&#34;</span>
</span></span><span class=line><span class=cl>KBUILD_DEFCONFIG:qemux86-64 <span class=o>=</span> <span class=s2>&#34;x86_64_defconfig&#34;</span>
</span></span><span class=line><span class=cl>KBUILD_DEFCONFIG:beaglebone <span class=o>=</span> <span class=s2>&#34;beaglebone_defconfig&#34;</span>
</span></span></code></pre></div><p>它的含义是KBUILD_DEFCONFIG的默认值是i386_defconfig，如果<code>${OVERRIDES}</code>中包含qemux86-64，就用x86_64_defconfig覆盖，如果<code>${OVERRIDES}</code>中包含beaglebone，就用beaglebone_defconfig覆盖。执行<code>bitbake -e linux-yocto > linux-yocto.bb.log</code>，在导出的日志文件中搜索KBUILD_DEFCONFIG，可以看到这个解析过程：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># $KBUILD_DEFCONFIG [3 operations]</span>
</span></span><span class=line><span class=cl><span class=c1>#   set /home/lsc/yocto-kirkstone/x86_build/meta-mylayer/recipes-kernel/linux/linux-yocto_%.bbappend:3</span>
</span></span><span class=line><span class=cl><span class=c1>#     &#34;i386_defconfig&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#   override[qemux86-64]:set /home/lsc/yocto-kirkstone/x86_build/meta-mylayer/recipes-kernel/linux/linux-yocto_%.bbappend:4</span>
</span></span><span class=line><span class=cl><span class=c1>#     &#34;x86_64_defconfig&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#   override[beaglebone]:set /home/lsc/yocto-kirkstone/x86_build/meta-mylayer/recipes-kernel/linux/linux-yocto_%.bbappend:5</span>
</span></span><span class=line><span class=cl><span class=c1>#     &#34;beaglebone_defconfig&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># pre-expansion value:</span>
</span></span><span class=line><span class=cl><span class=c1>#   &#34;x86_64_defconfig&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>KBUILD_DEFCONFIG</span><span class=o>=</span><span class=s2>&#34;x86_64_defconfig&#34;</span>
</span></span></code></pre></div><p>这里显示解析结果是<code>KBUILD_DEFCONFIG="x86_64_defconfig"</code>，是因为OVERRIDES变量的值是这样的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>OVERRIDES</span><span class=o>=</span><span class=s2>&#34;linux:x86-64:pn-linux-yocto:qemuall:qemux86-64:poky:class-target:libc-glibc:forcevariable&#34;</span>
</span></span></code></pre></div><p>bitbake解析KBUILD_DEFCONFIG变量的时候，根据冒号后面的条件，在<code>${OVERRIDES}</code>中匹配到了qemux86-64。<a href=https://docs.yoctoproject.org/bitbake/2.0/bitbake-user-manual/bitbake-user-manual-ref-variables.html#term-OVERRIDES title=OVERRIDES target=_blank rel=noreferrer>OVERRIDES</a>叫做条件控制变量，这是一个以冒号字符分隔的字符串列表，每个字符串就是一个条件，定义在 <code>poky/meta/conf/bitbake.conf</code> 文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>OVERRIDES</span> <span class=o>=</span> <span class=s>&#34;${TARGET_OS}:${TRANSLATED_TARGET_ARCH}:pn-${PN}:${MACHINEOVERRIDES}:${DISTROOVERRIDES}:${CLASSOVERRIDE}${LIBCOVERRIDE}:forcevariable&#34;</span>
</span></span><span class=line><span class=cl><span class=n>LIBCOVERRIDE</span> <span class=o>?=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>CLASSOVERRIDE</span> <span class=o>?=</span> <span class=s>&#34;class-target&#34;</span>
</span></span><span class=line><span class=cl><span class=n>DISTROOVERRIDES</span> <span class=o>?=</span> <span class=s>&#34;${@d.getVar(&#39;DISTRO&#39;) or &#39;&#39;}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>MACHINEOVERRIDES</span> <span class=o>?=</span> <span class=s>&#34;${MACHINE}&#34;</span>
</span></span></code></pre></div><p>主要集合列举了当前项目的一些系统特性，其中MACHINEOVERRIDES是指硬件特性，默认使用MACHINE的值，就是qemux86-64。这样，defconfig就跟硬件架构关联起来了。</p><h3 id=55-使用devtool class="relative group">5.5 使用devtool <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#55-%e4%bd%bf%e7%94%a8devtool aria-label=锚点>#</a></span></h3><p>上面是内核开发的基本方法，但是，实际情况不会这么简单，通常需要反复修改验证，如果每次都要修改后都要生成补丁重新构建系统，效率就很低。最好是修改后直接编译验证，完成所有内核开发后，再构建系统镜像，这个过程更推荐用devtool完成。这是Yocto提供的辅助开发工具，不止用于内核开发，它的基本原理是新建一个名为workspace的临时layer进行开发，开发完毕后再合并清除。详细内容可以参考：</p><ul><li><a href=https://docs.yoctoproject.org/4.0.14/kernel-dev/common.html#using-devtool-to-patch-the-kernel title="Using devtool to Patch the Kernel" target=_blank rel=noreferrer>Using devtool to Patch the Kernel</a></li><li><a href=https://docs.yoctoproject.org/4.0.14/ref-manual/devtool-reference.html# title="devtool Quick Reference" target=_blank rel=noreferrer>devtool Quick Reference</a></li></ul><p>首先使用 <code>devtool modify</code> 命令将 linux-yocto 的源码释放到 devtool 的环境下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ devtool modify linux-yocto
</span></span><span class=line><span class=cl>... ...
</span></span><span class=line><span class=cl>INFO: Adding <span class=nb>local</span> <span class=nb>source</span> files to srctree...
</span></span><span class=line><span class=cl>INFO: Copying kernel config to srctree
</span></span><span class=line><span class=cl>INFO: Source tree extracted to /home/lsc/yocto-kirkstone/x86_build/workspace/sources/linux-yocto
</span></span><span class=line><span class=cl>INFO: Recipe linux-yocto now <span class=nb>set</span> up to build from /home/lsc/yocto-kirkstone/x86_build/workspace/sources/linux-yocto
</span></span></code></pre></div><p>这一步完成了几项工作：</p><ol><li>新建了一个名为workspace的layer。</li><li>将workspace的路径添加到<code>conf/bblayers.conf</code>文件的BBLAYERS变量中。</li><li>将linux-yocto的源码checkout到<code>workspace/sources/linux-yocto</code>路径下。</li></ol><p>此时，S变量也指向了这个路径：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ bitbake -e linux-yocto <span class=p>|</span> grep ^S<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>S</span><span class=o>=</span><span class=s2>&#34;/home/lsc/yocto-kirkstone/x86_build/workspace/sources/linux-yocto&#34;</span>
</span></span></code></pre></div><p>这里的内核源码已经应用了recipe中设置的所有补丁和配置片段，合并后的配置文件就是源码路径下的<code>.config</code>，执行<code>git log</code>可以看到已经提交的补丁：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>cd</span> workspace/sources/linux-yocto
</span></span><span class=line><span class=cl>$ ls -la
</span></span><span class=line><span class=cl>total <span class=m>1120</span>
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>28</span> lsc lsc   <span class=m>4096</span> Nov <span class=m>23</span> 15:51 .
</span></span><span class=line><span class=cl>drwxr-xr-x   <span class=m>3</span> lsc lsc   <span class=m>4096</span> Nov <span class=m>23</span> 15:51 ..
</span></span><span class=line><span class=cl>-rw-r--r--   <span class=m>2</span> lsc lsc  <span class=m>17019</span> Nov <span class=m>23</span> 14:14 .clang-format
</span></span><span class=line><span class=cl>-rw-r--r--   <span class=m>2</span> lsc lsc     <span class=m>59</span> Nov <span class=m>23</span> 14:14 .cocciconfig
</span></span><span class=line><span class=cl>-rw-r--r--   <span class=m>1</span> lsc lsc <span class=m>147545</span> Nov <span class=m>23</span> 14:15 .config
</span></span><span class=line><span class=cl>$ git log
</span></span><span class=line><span class=cl>commit 9f62d786ef4e9c4ad2b85aa34d3ec8036ec107f2 <span class=o>(</span>HEAD -&gt; v5.15/standard/base<span class=o>)</span>
</span></span><span class=line><span class=cl>Author: lishaocheng &lt;gexbob@gmail.com&gt;
</span></span><span class=line><span class=cl>Date:   Fri Nov <span class=m>17</span> 15:32:14 <span class=m>2023</span> +0800
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    feat:add boot message
</span></span></code></pre></div><p>之后我们就在这个内核源码上进行开发，例如修改<code>init/calibrate.c</code>文件，添加几行启动信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>void calibrate_delay<span class=o>(</span>void<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    unsigned long lpj<span class=p>;</span>
</span></span><span class=line><span class=cl>    static bool printed<span class=p>;</span>
</span></span><span class=line><span class=cl>    int <span class=nv>this_cpu</span> <span class=o>=</span> smp_processor_id<span class=o>()</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    printk<span class=o>(</span><span class=s2>&#34;*************************************\n&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    printk<span class=o>(</span><span class=s2>&#34;*                                   *\n&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    printk<span class=o>(</span><span class=s2>&#34;*        HELLO YOCTO KERNEL         *\n&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    printk<span class=o>(</span><span class=s2>&#34;*                                   *\n&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    printk<span class=o>(</span><span class=s2>&#34;*************************************\n&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span>per_cpu<span class=o>(</span>cpu_loops_per_jiffy, this_cpu<span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>          .
</span></span><span class=line><span class=cl>          .
</span></span></code></pre></div><p>使用devtool进行编译：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ devtool build linux-yocto
</span></span><span class=line><span class=cl>$ devtool build-image core-image-minimal
</span></span></code></pre></div><p>也可以脱离devtool，使用外部工具链进行编译，首先初始化开发环境：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>source</span> /opt/poky/4.0.12/environment-setup-core2-64-poky-linux
</span></span></code></pre></div><p>打开配置界面修改配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ make menuconfig
</span></span></code></pre></div><p>清除：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ make clean
</span></span></code></pre></div><ul><li><code>make clean</code>，删除大多数的编译生成文件，但是会保留内核的<code>.config</code>， 还有足够的编译支持来建立扩展模块，比较常用。</li><li><code>make mrproper</code> ，删除所有的编译生成文件， 还有内核配置文件， 再加上各种备份文件，慎用。</li><li><code>make distclean</code>，mrproper 删除的文件，加上编辑备份文件和一些补丁文件，包括 <code>.scmversion</code> 等，几乎不用。</li></ul><p>编译 ，生成的内核位于<code>./arch/${ARCH}/boot/</code>路径下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ make -j4
</span></span></code></pre></div><p>打包模块，所有编译出的模块都安装到 <code>./modules/</code> 路径下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ make modules_install <span class=nv>INSTALL_MOD_PATH</span><span class=o>=</span>./modules/
</span></span></code></pre></div><p>生成的内核和模块都可以复制到目标硬件上测试验证。阶段性开发完毕后，可以向 git 提交：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git status
</span></span><span class=line><span class=cl>git add &lt;files&gt;
</span></span><span class=line><span class=cl>git commit -m &lt;message&gt;
</span></span></code></pre></div><p>一次或者多次 commit 后，可以使用<code>devtool finish</code>命令结束开发：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ devtool finish linux-yocto ~/yocto-kirkstone/x86_build/meta-mylayer
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>NOTE: Writing append file /home/lsc/yocto-kirkstone/x86_build/meta-mylayer/recipes-kernel/linux/linux-yocto_%.bbappend
</span></span><span class=line><span class=cl>NOTE: Copying 0001-calibrate-Add-printk-example.patch to /home/lsc/yocto-kirkstone/x86_build/meta-mylayer/recipes-kernel/linux/linux-yocto/0001-calibrate-Add-printk-example.patch
</span></span><span class=line><span class=cl>INFO: Cleaning sysroot <span class=k>for</span> recipe linux-yocto...
</span></span><span class=line><span class=cl>INFO: Leaving <span class=nb>source</span> tree /home/lsc/yocto-kirkstone/x86_build/workspace/sources/linux-yocto as-is<span class=p>;</span> <span class=k>if</span> you no longer need it <span class=k>then</span> please delete it manually
</span></span></code></pre></div><p>这个命令自动执行了几个步骤：</p><ol><li>检查git日志，将最近的几次commit生成补丁，并放到<code>meta-mylayer/recipes-kernel/linux/linux-yocto</code>路径下。</li><li>修改<code>linux-yocto_%.bbappend</code>文件，将补丁文件添加到SRC_URI。</li><li>将<code>workspace/sources/linux-yocto</code> 从yocto开发环境中清除。</li></ol><p>也可以手动完成这些操作，执行 <code>git format-patch &lt;-n></code> 将前面几次 commit 生成补丁，n是 commit 的次数，然后将这些补丁文件复制到<code>meta-mylayer/recipes-kernel/linux/linux-yocto</code>，修改并添加到SRC_URI。最后执行 <code>devtool reset linux-yocto</code> 将 <code>workspace/sources/linux-yocto</code> 从yocto开发环境中清除，之后执行bitbake时，才会使用 <code>meta-mylayer</code> 下的配置。需要注意的是，<code>devtool reset</code>和<code>devtool finish</code>并不会删除源码，所有，<code>workspace/source/linux-yocto</code> 下的源码需要手动删除。</p><p>上面的方法主要针对内核源码的开发，对于内核配置，推荐执行<code>make savedefconfig</code>，使用生成的<code>defconfig</code>文件，而不是配置片段。</p><h3 id=56-使用virtual-provider class="relative group">5.6 使用Virtual Provider <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#56-%e4%bd%bf%e7%94%a8virtual-provider aria-label=锚点>#</a></span></h3><p>在构建之前，如果知道有几个不同的recipe提供相同的功能，可以使用Virtual Provider（即 virtual/*）作为实际提供程序的占位符，实际提供程序将在构建时确定。参考：<a href=https://docs.yoctoproject.org/4.0.14/dev-manual/new-recipe.html#using-virtual-providers title="Using Virtual Providers" target=_blank rel=noreferrer>Using Virtual Providers</a>。</p><p>例如，poky包含了多个不同的内核recipe：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; ls poky/meta/recipes-kernel/linux
</span></span><span class=line><span class=cl>cve-exclusion.inc  linux-dummy.bb          linux-yocto-rt_5.15.bb    linux-yocto.inc
</span></span><span class=line><span class=cl>kernel-devsrc.bb   linux-yocto-dev.bb      linux-yocto-tiny_5.10.bb  linux-yocto_5.10.bb
</span></span><span class=line><span class=cl>linux-dummy        linux-yocto-rt_5.10.bb  linux-yocto-tiny_5.15.bb  linux-yocto_5.15.bb
</span></span></code></pre></div><p>每个recipe都有字节的<a href=https://docs.yoctoproject.org/4.0.14/ref-manual/variables.html#term-PROVIDES title=PROVIDES target=_blank rel=noreferrer>PROVIDES</a>变量，它的值是recpie的别名列表，默认只包含了<code>${PN}</code>，而这些内核recipe都继承了<code>poky/meta/classes/kernel.bbclass</code>，这里向PROVIDES追加了<code>virtual/kernel</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>PROVIDES</span> <span class=o>+=</span> <span class=s2>&#34;virtual/kernel&#34;</span>
</span></span></code></pre></div><p>所以，每个内核recipe就有了<code>${PN}</code>和<code>virtual/kernel</code>两个名称。然后通过<a href=https://docs.yoctoproject.org/4.0.14/ref-manual/variables.html#term-PREFERRED_PROVIDER title=PREFERRED_PROVIDER target=_blank rel=noreferrer>PREFERRED_PROVIDER</a>和<a href=https://docs.yoctoproject.org/4.0.14/ref-manual/variables.html#term-PREFERRED_VERSION title=PREFERRED_VERSION target=_blank rel=noreferrer>PREFERRED_VERSION</a>变量设置<code>virtual/kernel</code>解析为哪个recipe：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># poky/meta/conf/machine/include/qemu.inc</span>
</span></span><span class=line><span class=cl>PREFERRED_PROVIDER_virtual/kernel ??<span class=o>=</span> <span class=s2>&#34;linux-yocto&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># poky/meta-poky/conf/distro/poky.conf</span>
</span></span><span class=line><span class=cl>PREFERRED_VERSION_linux-yocto ?<span class=o>=</span> <span class=s2>&#34;5.15%&#34;</span>
</span></span></code></pre></div><p>这样，开发内核时，可以不用内核的recipe原名，而是使用<code>virtual/kernel</code>，例如<code>bitbake virtual/kernel</code>，bitbake会自动解析PREFERRED_PROVIDER变量，确定使用的内核recipe。</p></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=flex><picture class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full"><img width=568 height=568 class="!mb-0 !mt-0 me-4 w-24 h-auto rounded-full" alt=Shaocheng.Li loading=lazy decoding=async src=/img/author.png></picture><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Shaocheng.Li</div><div class="text-sm text-neutral-700 dark:text-neutral-400">A Linux software engineer.</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=https://github.com/exbob target=_blank aria-label=Github rel="me noopener noreferrer"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/2022/05/07/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Linux 进程调度的学习笔记</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-05-07 18:34:49 +0800 +0800">2022 五月 7</time>
</span></span></a></span><span><a class="group flex text-right" href=/posts/2025/05/04/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">将豆瓣电影记录添加在 Hugo 博客</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2025-05-04 21:44:37 +0800 +0800">2025 五月 4</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[-2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div></footer></article></main><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12" id=to-top hidden=true><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label=回到顶部 title=回到顶部>&uarr;</a></div><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
Shaocheng.Li</p><p class="text-xs text-neutral-500 dark:text-neutral-400">由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a> 强力驱动</p></div><div class="flex flex-row items-center"></div></div></footer><div id=search-wrapper class="invisible fixed inset-0 z-50 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://shaocheng.li/><div id=search-modal class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex flex-none items-center justify-between px-2"><form class="flex min-w-0 flex-auto items-center"><div class="flex h-8 w-8 items-center justify-center text-neutral-400"><span class="icon relative inline-block px-1 align-text-bottom"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=搜索 tabindex=0></form><button id=close-search-button class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="关闭 (Esc)">
<span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto overflow-auto px-2"><ul id=search-results></ul></section></div></div></div></body></html>