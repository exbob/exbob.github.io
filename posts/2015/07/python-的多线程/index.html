<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Shaocheng.Li ">
<meta name="description" content="Python 的标准库提供了两个模块支持多线程：thread 和 threading ，thread 是低级模块，threading 是对 thread 进行了封装的高级模块，通常直接用 threading 模块。
threading 库：https://docs.python.org/2/library/threading.html
1. 创建线程 threading 模块定义了 Thread 对象，创建一个线程就是创建一个 Thread 实例，用 name 参数指定线程的名称，用 target 参数指定该线程执行的函数。然后调用 start() 方法开始执行，join() 方法的作用是等待线程结束，它可以带一个参数，表示超时时间：
import threading,time def loop(): print &amp;quot;this a thread&amp;quot; n=0 while n&amp;lt;5: print &amp;quot;n = %d&amp;quot; %(n) n=n&#43;1 time.sleep(1) print &amp;quot;thread exit&amp;quot; print &amp;quot;thread running...&amp;quot; t=threading.Thread(target=loop) t.start() t.join() print &amp;quot;thread ended&amp;quot;  我们还可以通过创建自己的线程类来使用多线程，这个类需要继承 threading.Thread ,然后重写 Thread 对象的 run() 方法，run() 方法就是这个线程要实现的功能，调用 start() 方法就会执行 run() ，例如：" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<link rel="canonical" href="https://shaocheng.li/posts/2015/07/python-%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B/" />


    <title>
        
            Python 的多线程 :: Shaocheng.Li  — Hello Friends
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://shaocheng.li/main.min.73f55a8d452be4a71b2960620b80252cf69abd84d63fe7501abf0a39b1a70a78.css">


    
        <link rel="stylesheet" type="text/css" href="https://shaocheng.li/css/custom.css">
    



    <link rel="apple-touch-icon" sizes="180x180" href="https://shaocheng.li/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://shaocheng.li/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://shaocheng.li/favicon-16x16.png">
    <link rel="manifest" href="https://shaocheng.li/site.webmanifest">
    <link rel="mask-icon" href="https://shaocheng.li/safari-pinned-tab.svg" color="#252627">
    <link rel="shortcut icon" href="https://shaocheng.li/favicon.ico">
    <meta name="msapplication-TileColor" content="#252627">
    <meta name="theme-color" content="#252627">

<meta itemprop="name" content="Python 的多线程">
<meta itemprop="description" content="Python 的标准库提供了两个模块支持多线程：thread 和 threading ，thread 是低级模块，threading 是对 thread 进行了封装的高级模块，通常直接用 threading 模块。
threading 库：https://docs.python.org/2/library/threading.html
1. 创建线程 threading 模块定义了 Thread 对象，创建一个线程就是创建一个 Thread 实例，用 name 参数指定线程的名称，用 target 参数指定该线程执行的函数。然后调用 start() 方法开始执行，join() 方法的作用是等待线程结束，它可以带一个参数，表示超时时间：
import threading,time def loop(): print &quot;this a thread&quot; n=0 while n&lt;5: print &quot;n = %d&quot; %(n) n=n&#43;1 time.sleep(1) print &quot;thread exit&quot; print &quot;thread running...&quot; t=threading.Thread(target=loop) t.start() t.join() print &quot;thread ended&quot;  我们还可以通过创建自己的线程类来使用多线程，这个类需要继承 threading.Thread ,然后重写 Thread 对象的 run() 方法，run() 方法就是这个线程要实现的功能，调用 start() 方法就会执行 run() ，例如：">


<meta itemprop="datePublished" content="2015-07-27T08:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2015-07-27T08:00:00&#43;08:00" />
<meta itemprop="wordCount" content="400">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://shaocheng.li"/>

<meta name="twitter:title" content="Python 的多线程"/>
<meta name="twitter:description" content="Python 的标准库提供了两个模块支持多线程：thread 和 threading ，thread 是低级模块，threading 是对 thread 进行了封装的高级模块，通常直接用 threading 模块。
threading 库：https://docs.python.org/2/library/threading.html
1. 创建线程 threading 模块定义了 Thread 对象，创建一个线程就是创建一个 Thread 实例，用 name 参数指定线程的名称，用 target 参数指定该线程执行的函数。然后调用 start() 方法开始执行，join() 方法的作用是等待线程结束，它可以带一个参数，表示超时时间：
import threading,time def loop(): print &quot;this a thread&quot; n=0 while n&lt;5: print &quot;n = %d&quot; %(n) n=n&#43;1 time.sleep(1) print &quot;thread exit&quot; print &quot;thread running...&quot; t=threading.Thread(target=loop) t.start() t.join() print &quot;thread ended&quot;  我们还可以通过创建自己的线程类来使用多线程，这个类需要继承 threading.Thread ,然后重写 Thread 对象的 run() 方法，run() 方法就是这个线程要实现的功能，调用 start() 方法就会执行 run() ，例如："/>





    <meta property="article:published_time" content="2015-07-27 08:00:00 &#43;0800 CST" />








    </head>

    <body class="">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://shaocheng.li/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd /home/</span>
            <span class="logo__cursor" style=""></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://shaocheng.li/about/">About</a></li><li><a href="https://shaocheng.li/posts/">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>2 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="https://shaocheng.li/posts/2015/07/python-%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B/">Python 的多线程</a>
            </h1>

            

            <div class="post-content">
                

<p>Python 的标准库提供了两个模块支持多线程：thread 和 threading ，thread 是低级模块，threading 是对 thread 进行了封装的高级模块，通常直接用 threading 模块。</p>

<p>threading 库：<a href="https://docs.python.org/2/library/threading.html" target="_blank">https://docs.python.org/2/library/threading.html</a></p>

<h2 id="1-创建线程">1. 创建线程</h2>

<p>threading 模块定义了 Thread 对象，创建一个线程就是创建一个 Thread 实例，用 name 参数指定线程的名称，用 target 参数指定该线程执行的函数。然后调用 start() 方法开始执行，join() 方法的作用是等待线程结束，它可以带一个参数，表示超时时间：</p>

<pre><code>import threading,time

def loop():
        print &quot;this a thread&quot;
        n=0
        while n&lt;5:
                print &quot;n = %d&quot; %(n)
                n=n+1
                time.sleep(1)
        print &quot;thread exit&quot;

print &quot;thread running...&quot;
t=threading.Thread(target=loop)
t.start()
t.join()
print &quot;thread ended&quot;
</code></pre>

<p>我们还可以通过创建自己的线程类来使用多线程，这个类需要继承 threading.Thread ,然后重写 Thread 对象的 run() 方法，run() 方法就是这个线程要实现的功能，调用 start() 方法就会执行 run() ，例如：</p>

<pre><code>import threading,time

class my_thread(threading.Thread):
        def __init__(self,t_name):
                self.n=0
                threading.Thread.__init__(self,name=t_name)
        def run(self):
                while self.n&lt;5:
                        print self.getName(),&quot;:&quot;,self.n
                        self.n=self.n+1
                        time.sleep(1)

def main():
        t=my_thread('thread_a')
        t.start()
        t.join()

if __name__=='__main__':
        main()
</code></pre>

<p>输出结果是：</p>

<pre><code>thread_a : 0
thread_a : 1
thread_a : 2
thread_a : 3
thread_a : 4
</code></pre>

<p>threading 提供了一个属性 deamon ，默认值是 False ，表示这个线程不是守护线程，当主线程退出时，该线程也会退出。如果设为 True ，这个线程就是守护线程，当主线程退出时，该线程可以继续运行。</p>

<h2 id="2-线程同步">2. 线程同步</h2>

<p>当多个线程访问共享资源时，需要实现线程间的同步，threading 提供了多个对象实现不同的同步功能。</p>

<h3 id="2-1-lock">2.1 Lock</h3>

<p>Lock 对象是最基本的同步方式，相当于互斥锁。使用时，先创建一个锁，然后在访问共享资源时调用 acquire() 方法获取锁，访问完毕再调用 release() 方法释放锁。</p>

<p>acquire() 方法有一个参数 blocking ，默认值为 True ，表示该函数会阻塞，直到获取锁；如果设为 False ，表示非阻塞，函数会立即返回。</p>

<p>release() 方法会释放当前的锁，如果这个锁本来就没被获取，会抛出 ThreadError 异常；</p>

<pre><code>import threading,time

n=0
lock=threading.Lock()

def add_num():
        global n
        while True:
                lock.acquire()
                n=n+1
                n=n-1
                print n
                lock.release()
                time.sleep(1)

print &quot;thread running...&quot;
t1=threading.Thread(target=add_num)
t2=threading.Thread(target=add_num)
t1.start()
t2.start()
t1.join()
t2.join()
print &quot;thread ended&quot;
</code></pre>

<h3 id="2-2-rlock">2.2 RLock</h3>

<p>Lock 锁是不能嵌套申请的，否则必然死锁。Threading 模块提供了另一个对象 RLock ，可重入的互斥锁。该对象内部维护了一个 Lock 对象和一个引用计数，记录 acquire 的次数，可以多次 acquire ，acquire 和 release 必须严格配对，所有的 acquire 最后必须都 release 。</p>

<pre><code>import threading,time

n=0
lock=threading.RLock()

def add_num():
        global n
        while True:
                if lock.acquire():
                        n=n+1
                        print &quot;1 &quot;,n
                        if lock.acquire():
                                n=n-1
                                print &quot;2 &quot;,n
                        lock.release()
                lock.release()
                time.sleep(1)

print &quot;thread running...&quot;

t=threading.Thread(target=add_num)
t.start()
t.join()

print &quot;thread ended&quot;
</code></pre>

<h3 id="2-3-condition">2.3 Condition</h3>

<p>Condition 可以称为条件变量。它的构造函数需要一个 Lock 对象作为参数，如果没有这个参数，Condition 将在内部自行创建一个 Rlock 对象，所有它依然可以调用 acquire() 和 release() 方法。它还提供了 wait() 和 notify() 方法。</p>

<p>当一个线程用 acquire() 获取了一个条件变量，可以调用 wait() 使线程放弃这个锁，进入阻塞状态，直到其他线程用同一个条件变量的 notify() 方法唤醒它。wait() 方法有一个 timeout 参数可以设置阻塞超时。notify() 方法的参数 n 表示唤醒 n 个线程，默认值是 1 。如果是调用 notifyAll() 方法，将会唤醒该条件变量上阻塞的所有线程。</p>

<p>下面是一个生产者和消费者的例程：</p>

<pre><code>import threading

x=0
con = threading.Condition()  

class Producer(threading.Thread):  
    def __init__(self, t_name):  
        threading.Thread.__init__(self, name=t_name)  
    def run(self):  
        global x  
        con.acquire()  
        if x &gt; 0:  
            con.wait()  
        else:  
            for i in range(5):  
                x=x+1  
                print &quot;producing...&quot; + str(x)  
            con.notify()  
        print x  
        con.release()  


class Consumer(threading.Thread):  
    def __init__(self, t_name):  
        threading.Thread.__init__(self, name=t_name)  
    def run(self):  
        global x  
        con.acquire()  
        if x == 0:  
            print 'consumer wait...'  
            con.wait()  
        else:  
            for i in range(5):  
                x=x-1  
                print &quot;consuming...&quot; + str(x)  
            con.notify()  
        print x  
        con.release()  

print 'start consumer'  
c=Consumer('consumer')  
print 'start producer'  
p=Producer('producer')  
p.start()  
c.start()  
p.join()  
c.join()  
print x  
</code></pre>

<h2 id="3-timer">3. Timer</h2>

<p>Timer 是 Thread 的子类，可以实现定时执行某个函数的功能。Timer 的构造方法如下：</p>

<pre><code>class threading.Timer(interval, function, args=[], kwargs={})
</code></pre>

<p>fuction 会在 Timer 启动后 interval 秒开始执行，args 和 kwargs 表示传入 fuction 的参数和可变参数。构造了 Timer 的实例后，可以直接调用 start() 方法启动 Timer 。调用 cancel() 方法可以停止 Timer ，并停止 Timer 启动的函数。</p>

<p>下面这个例程会在启动 Timer 后 5 秒是执行 hello 函数：</p>

<pre><code>import threading

def hello(arg):
        print &quot;Hello World&quot;
        print arg

t=threading.Timer(5,hello,[&quot;Yes&quot;])
t.start()
</code></pre>

            </div>
        </article>

        <hr />

        <div class="post-info">

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>400 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2015-07-27 08:00 &#43;0800</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://shaocheng.li/posts/2015/08/mqtt-%E5%8D%8F%E8%AE%AE%E5%92%8C-mosquitto/">
                                <span class="button__icon">←</span>
                                <span class="button__text">MQTT 协议和 mosquitto</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://shaocheng.li/posts/2015/07/python-%E5%AF%B9-json-%E7%9A%84%E5%A4%84%E7%90%86/">
                                <span class="button__text">Python 对 JSON 的处理</span>
                                <span class="button__icon">→</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        

        
          <div id="comments" class="thin">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "shaocheng-li" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
                <span><a href="https://shaocheng.li">Shaocheng.Li</a></span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            <span> <a href="https://shaocheng.li/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="https://shaocheng.li/bundle.min.2d5469329143160ae2456a69c3c76dc2d0a3b212b46afe291a51bd68650ed6f8697e001dab54f1c272c77ce08092a8c55e5bb4314e0ee334aab4b927ec896638.js" integrity="sha512-LVRpMpFDFgriRWppw8dtwtCjshK0av4pGlG9aGUO1vhpfgAdq1TxwnLHfOCAkqjFXlu0MU4O4zSqtLkn7IlmOA=="></script>



    </body>
</html>
